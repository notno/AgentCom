# Codebase Structure

**Analysis Date:** 2026-02-09

## Directory Layout

```
C:\Users\nrosq\src\AgentCom/
├── lib/                           # Elixir application code
│   ├── agent_com/
│   │   ├── application.ex         # OTP Application + Supervisor tree
│   │   ├── endpoint.ex            # HTTP/WebSocket routing
│   │   ├── socket.ex              # WebSocket message handler
│   │   ├── router.ex              # Message delivery logic
│   │   ├── message.ex             # Message data structure
│   │   ├── auth.ex                # Token authentication
│   │   ├── mailbox.ex             # Message queue for offline agents
│   │   ├── presence.ex            # Connected agents roster
│   │   ├── channels.ex            # Topic-based messaging
│   │   ├── config.ex              # Application configuration store
│   │   ├── message_history.ex     # Global message audit log
│   │   ├── threads.ex             # Conversation threading
│   │   ├── analytics.ex           # Agent activity metrics
│   │   ├── reaper.ex              # Background cleanup
│   │   ├── dashboard.ex           # HTML dashboard renderer
│   │   └── plugs/
│   │       └── require_auth.ex    # HTTP auth middleware
│   └── mix/
│       └── tasks/
│           └── gen_token.ex       # Mix task: generate token
├── config/                        # Elixir configuration files
├── priv/                          # Runtime data (DETS, JSON)
│   ├── mailbox.dets              # Offline message queue
│   ├── channels.dets             # Channel subscriptions
│   ├── channel_history.dets      # Channel message history
│   ├── thread_messages.dets      # Indexed messages for threading
│   ├── thread_replies.dets       # Reply chains
│   ├── message_history.dets      # Audit log
│   └── tokens.json               # Token → agent_id mappings
├── .planning/
│   └── codebase/                 # Analysis documents
├── agentcom-skill/               # Skill definition (external tool)
├── docs/                         # Documentation
├── scripts/                      # Example scripts
├── mix.exs                       # Project manifest
├── mix.lock                      # Dependency lock file
└── README.md                     # Main documentation
```

## Directory Purposes

**`lib/agent_com/`:**
- Purpose: Core application business logic
- Contains: GenServers, HTTP/WebSocket handlers, routing logic, data structures
- Key files: See above

**`lib/mix/tasks/`:**
- Purpose: Custom Mix tasks for development/admin operations
- Contains: `gen_token.ex` — CLI task to generate authentication tokens
- Invocation: `mix gen_token my-agent`

**`config/`:**
- Purpose: Elixir configuration files (not used in current minimal setup)
- Contains: Typically `config.exs`, `dev.exs`, `prod.exs` — currently sparse

**`priv/`:**
- Purpose: Runtime data and generated files
- Contains: DETS database files (created automatically), JSON token store
- Commitment: Not committed to git (in `.gitignore`)

**`.planning/codebase/`:**
- Purpose: Architecture analysis documents (ARCHITECTURE.md, STRUCTURE.md, etc.)
- Contains: Markdown reference guides for code navigation and conventions
- Generated by: GSD codebase mapper agent

**`agentcom-skill/`:**
- Purpose: External tool skill definition
- Contains: `SKILL.md` describing AgentCom as a tool for other systems

**`docs/`:**
- Purpose: Documentation and analysis
- Contains: `experiment-results/` — research outputs

**`scripts/v1-examples/`:**
- Purpose: Example client code and integration patterns
- Contains: Sample agent implementations

## Key File Locations

**Entry Points:**

- `lib/agent_com/application.ex`: Application start (`:mod` in mix.exs); initializes supervisor tree
- `lib/agent_com/endpoint.ex`: HTTP request router; first handler for all HTTP/WS requests
- `lib/agent_com/socket.ex`: WebSocket frame handler; first handler for connected agents

**Configuration:**

- `mix.exs`: Project metadata, dependencies, aliases, port configuration
- `lib/agent_com/config.ex`: Application KV config store (backed by DETS)
- Environment variables: `PORT` (default 4000), `ADMIN_AGENTS` (comma-separated agent_ids)

**Core Logic:**

- `lib/agent_com/router.ex`: Message delivery routing (direct, broadcast, queued)
- `lib/agent_com/auth.ex`: Token generation and verification
- `lib/agent_com/message.ex`: Message struct with JSON serialization
- `lib/agent_com/mailbox.ex`: Offline message queue (DETS-backed)
- `lib/agent_com/channels.ex`: Channel pub/sub (DETS-backed subscriptions + history)
- `lib/agent_com/presence.ex`: Live agent roster (in-memory GenServer)

**Persistence:**

- `priv/tokens.json`: Token → agent_id mappings (JSON, reloaded on startup)
- `priv/mailbox.dets`: `{{agent_id, seq}, entry}` — one table, DETS format
- `priv/channels.dets`: `{channel_name, channel_info}` — channel subscriptions
- `priv/channel_history.dets`: `{channel_name_seq, message}` — per-channel message history
- `priv/thread_messages.dets`: `{message_id, message_json}` — all indexed messages
- `priv/thread_replies.dets`: `{parent_id, [child_ids]}` — reply chains
- `priv/message_history.dets`: `{seq, entry}` — global audit log
- `~/.agentcom/data/config.dets`: Application config KV store (outside priv/)

**Testing:**

- No `test/` directory currently present (feature gap — see CONCERNS.md)

## Naming Conventions

**Files:**

- Underscore-separated, lowercase: `message_history.ex`, `require_auth.ex`
- One module per file (Elixir convention)
- Task files: `gen_token.ex` → module `Mix.Tasks.GenToken`

**Directories:**

- Lowercase, plural for collections: `plugs/`, `lib/agent_com/`, `scripts/`
- No underscores in directory names

**Modules:**

- CamelCase, nested under `AgentCom`: `AgentCom.Mailbox`, `AgentCom.Plugs.RequireAuth`
- Behavior modules (plugs): PascalCase, no trailing "Behavior"

**Functions:**

- Snake_case, lowercase: `register/2`, `send_message/1`, `handle_msg/2`
- Private functions (prefix with `defp`): `do_identify/3`, `reply_error/2`
- Query/retrieval functions: `list/0`, `get/1`, `poll/2`, `query/1`
- Mutation functions: `put/2`, `enqueue/2`, `publish/2`
- Predicate functions: `verify/1`, `is_authenticated/1`

**Variables:**

- Snake_case: `agent_id`, `message_id`, `channel_name`
- Atom keys in maps: `:agent_id`, `:payload`, `:timestamp`
- String keys for JSON payloads: `"type"`, `"to"`, `"payload"`

**Constants:**

- UPPERCASE, prefixed with `@`: `@table :agent_mailbox`, `@default_ttl_ms 604_800_000`

**Message Types:**

- Lowercase strings: `"message"`, `"identify"`, `"status"`, `"broadcast"`
- Define conventions in module docs

## Where to Add New Code

**New Feature (e.g., message search):**
- Primary code: `lib/agent_com/new_feature.ex` (create new GenServer if stateful)
- HTTP routes: Add to `endpoint.ex` pattern matches
- WebSocket commands: Add to `socket.ex` handle_msg dispatch
- Tests: Create `test/agent_com/new_feature_test.exs` (if test directory exists)

**New Component/Module (e.g., rate limiter):**
- Implementation: `lib/agent_com/rate_limiter.ex` as GenServer
- Add to supervisor tree: Update `application.ex` children list
- Client API: Define public functions, keep server callbacks private

**Utilities/Helpers:**
- Shared helpers: No dedicated utils module currently; keep in respective GenServer or `message.ex`
- JSON encoding: Use `Jason.encode!()` and `Jason.decode!()`
- Time utilities: Use `System.system_time(:millisecond)` for milliseconds

**HTTP Endpoints:**
- Location: `lib/agent_com/endpoint.ex`, add route handler
- Pattern: `method "/path" do ... end` in `Plug.Router`
- Authentication: Call `RequireAuth.call(conn, [])`, check `conn.halted`
- Response: Use `send_json(conn, status, map)` helper

**WebSocket Messages:**
- Location: `lib/agent_com/socket.ex`, add pattern to `handle_msg/2`
- Format: Pattern match on `%{"type" => "your_message_type"}`, extract fields
- Response: Use `{:push, {:text, Jason.encode!(reply)}, state}` or `reply_error(reason, state)`
- Side effects: Can call GenServer functions, update state, broadcast to PubSub

**Database Schema (DETS):**
- Design: Flat key-value; use composite keys `{key1, key2}` for secondary indexes
- Example: `{{agent_id, seq}, entry}` for range queries by agent
- Location: Open/close in `init/1` and `terminate/2`
- Pattern: Use `:dets.insert`, `:dets.select` for queries, `:dets.delete` for removal
- Auto-save: Set `auto_save: 5_000` (5 seconds); manual `dets.sync()` for critical paths

**New GenServer Module (template):**

```elixir
defmodule AgentCom.YourModule do
  @moduledoc """
  Brief description.
  """
  use GenServer

  def start_link(opts) do
    GenServer.start_link(__MODULE__, opts, name: __MODULE__)
  end

  @impl true
  def init(_opts) do
    # Load data, open files, schedule timers
    {:ok, %{}}
  end

  # Public API functions
  def your_function(args) do
    GenServer.call(__MODULE__, {:your_function, args})
  end

  # Server callbacks
  @impl true
  def handle_call({:your_function, args}, _from, state) do
    # Do work
    {:reply, result, new_state}
  end

  @impl true
  def terminate(_reason, _state) do
    # Clean up resources
    :ok
  end
end
```

## Special Directories

**`priv/`:**
- Purpose: Runtime data storage
- Generated: Yes (DETS and JSON files created on startup)
- Committed: No (entries in `.gitignore`)
- Cleanup: Safe to delete; will be recreated with defaults

**`.planning/codebase/`:**
- Purpose: Analysis documents
- Generated: Yes (by GSD codebase mapper)
- Committed: Yes (checked into git as reference)

**`~/.agentcom/data/`:**
- Purpose: User-specific config (outside project)
- Generated: Yes (config DETS table created on first run)
- Committed: No (external to repo)

## Module Dependencies

**No circular dependencies.** Dependency graph:

```
Endpoint ──┬──→ RequireAuth
           ├──→ Router ──→ Message, MessageHistory, Analytics, Threads
           ├──→ Auth
           ├──→ Mailbox
           ├──→ Presence
           ├──→ Channels
           ├──→ Config
           └──→ Dashboard

Socket ────┬──→ Message, Router
           ├──→ Presence
           ├──→ Channels
           ├──→ Auth
           ├──→ Analytics
           └──→ PubSub

Router ────┬──→ Message
           ├──→ Mailbox
           ├──→ MessageHistory
           ├──→ Analytics
           ├──→ Threads
           └──→ Registry (Elixir built-in)

Channels ──→ Message (optional: for publish)

Config, Mailbox, Presence, Auth, Threads, Analytics, MessageHistory: no cross-dependencies
```


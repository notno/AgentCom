---
phase: 08-onboarding
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - sidecar/culture-names.js
  - sidecar/add-agent.js
autonomous: true

must_haves:
  truths:
    - "Running add-agent --hub <url> auto-generates a Culture ship name, registers with hub, creates config, clones repo, installs deps, starts pm2 process, and verifies with test task"
    - "Re-running add-agent --hub <url> --resume skips already-completed steps"
    - "Test task completes within 30 seconds or add-agent reports hard failure"
    - "Pre-flight checks fail fast if hub unreachable, OpenClaw missing, Node < 18, pm2 missing, or git missing"
    - "Step-by-step log output shows progress: [1/N] Registering agent... done"
    - "After success, quick-start commands are printed"
  artifacts:
    - path: "sidecar/culture-names.js"
      provides: "Culture ship name list and random selection"
      contains: "gcu-"
    - path: "sidecar/add-agent.js"
      provides: "One-command agent onboarding script"
      contains: "parseArgs"
  key_links:
    - from: "sidecar/add-agent.js"
      to: "POST /api/onboard/register"
      via: "HTTP request to hub registration endpoint"
      pattern: "/api/onboard/register"
    - from: "sidecar/add-agent.js"
      to: "GET /api/config/default-repo"
      via: "HTTP request to hub config endpoint"
      pattern: "/api/config/default-repo"
    - from: "sidecar/add-agent.js"
      to: "sidecar/culture-names.js"
      via: "require for name generation"
      pattern: "require.*culture-names"
    - from: "sidecar/add-agent.js"
      to: "POST /api/tasks"
      via: "HTTP request to submit test task"
      pattern: "/api/tasks"
    - from: "sidecar/add-agent.js"
      to: "GET /api/tasks/:task_id"
      via: "HTTP polling for test task completion"
      pattern: "/api/tasks/"
---

<objective>
Build the add-agent onboarding script that provisions a new agent with one command: auto-generates a Culture ship name, registers with hub, clones repo, creates sidecar config, installs dependencies, starts pm2, and verifies with a round-trip test task.

Purpose: This is the core deliverable of Phase 8 — turning agent provisioning from a multi-step manual process into a single automated command.
Output: sidecar/culture-names.js (name generator) and sidecar/add-agent.js (onboarding script)
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-onboarding/08-01-SUMMARY.md
@sidecar/config.json.example
@sidecar/ecosystem.config.js
@sidecar/agentcom-git.js
@sidecar/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create culture-names.js module</name>
  <files>sidecar/culture-names.js</files>
  <action>
Create sidecar/culture-names.js as a CommonJS module exporting two functions:

1. `getNames()` — returns the full array of Culture ship names
2. `generateName()` — returns a random name from the list, prefixed with "gcu-"

The module contains a curated list of ~60 Culture ship names from Iain M. Banks' novels. Names should be lowercase, hyphenated (e.g., "sleeper-service", "falling-outside-the-normal-moral-constraints", "just-read-the-instructions"). The prefix "gcu-" (General Contact Unit) is always prepended.

Example names to include (at minimum these, plus ~50 more):
- sleeper-service
- grey-area
- just-read-the-instructions
- so-much-for-subtlety
- no-more-mr-nice-guy
- very-little-gravitas-indeed
- of-course-i-still-love-you
- problem-child
- gunboat-diplomat
- sense-amid-madness-wit-amidst-folly
- honest-mistake
- contents-may-differ
- lightly-seared-on-the-reality-grill
- mistake-not
- passing-by-and-thought-id-say-hello
- experiencing-a-significant-gravitas-shortfall
- rapid-random-happiness
- death-and-gravity
- frank-exchange-of-views
- youthful-indiscretion
- zero-gravitas
- limiting-factor
- use-of-weapons
- xenophobe
- quietly-confident
- trade-surplus
- bora-horza-gobuchul
- what-are-the-alarm-signals
- irregular-apocalypse
- killing-time
- happy-idiot-talk
- reasonable-excuse
- prosthetic-conscience
- bad-for-business
- size-isnt-everything
- anticipation-of-a-new-lovers-arrival
- fate-amenable-to-change
- a-series-of-unlikely-explanations
- tactical-grace
- pure-big-mad-boat-thing
- steely-glint
- attitude-adjuster
- determinist
- ends-of-invention
- it-wishes
- subtle-shift-in-emphasis
- i-thought-he-was-with-you
- break-even
- no-fixed-abode
- the-nervously-optimistic
- refreshingly-unconcerned-with-conventional-approach
- quietly-confident
- value-judgment
- lasting-damage
- just-testing
- serious-callers-only

Selection uses `Math.random()` — simple and sufficient. The caller (add-agent.js) is responsible for checking the hub for name collisions.

Module pattern (matching codebase CJS conventions):
```javascript
'use strict';
const NAMES = [ ... ];
function getNames() { return NAMES; }
function generateName() { return 'gcu-' + NAMES[Math.floor(Math.random() * NAMES.length)]; }
module.exports = { getNames, generateName };
```
  </action>
  <verify>
Run `node -e "const c = require('./sidecar/culture-names.js'); console.log(c.generateName()); console.log('Total:', c.getNames().length)"` from C:/Users/nrosq/src/AgentCom and confirm it outputs a gcu- prefixed name and a count >= 55.
  </verify>
  <done>
culture-names.js exports getNames() returning 55+ names and generateName() returning a random gcu-prefixed Culture ship name. Module loads without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create add-agent.js onboarding script</name>
  <files>sidecar/add-agent.js</files>
  <action>
Create sidecar/add-agent.js as a standalone Node.js CLI script. Uses Node.js built-in `util.parseArgs` for flag parsing (zero npm dependencies). Follows the agentcom-git.js pattern for output helpers but uses step-based console logging instead of JSON output (this is a human-facing tool).

**CLI interface:**
```
node add-agent.js --hub http://hub-hostname:4000
node add-agent.js --hub http://hub-hostname:4000 --name gcu-custom-name
node add-agent.js --hub http://hub-hostname:4000 --resume
```

Flags (via util.parseArgs):
- `--hub` (string, required): Hub API URL (e.g., http://localhost:4000)
- `--name` (string, optional): Override auto-generated name
- `--resume` (boolean, optional): Skip completed steps

**Install directory:** `~/.agentcom/<agent-name>/` — use `os.homedir()` + path.join.

**Progress tracking for --resume:**
Store progress in `~/.agentcom/<agent-name>/.onboard-progress.json` with format:
```json
{
  "agent_name": "gcu-sleeper-service",
  "hub_url": "http://localhost:4000",
  "steps_completed": ["preflight", "register", "clone", "config", "install", "pm2"],
  "token": "abc123...",
  "repo_url": "https://github.com/user/repo.git"
}
```

**Steps (in order):**

Step 1 — Pre-flight checks:
- Node.js >= 18 (check process.versions.node major)
- pm2 installed (execSync 'pm2 --version', catch error)
- git installed (execSync 'git --version', catch error)
- openclaw installed (execSync 'openclaw --version', catch error — fail with helpful message about installing OpenClaw)
- Hub reachable (HTTP GET to `${hub}/health`, check for 200)
- Install dir doesn't already exist (unless --resume)
Log: `[1/7] Pre-flight checks... done` (or list failures and exit 1)

Step 2 — Register agent:
- If --name not provided, call require('./culture-names.js').generateName()
- Check hub for name collision: GET `${hub}/api/agents` — if agent_id matches, regenerate (retry up to 10 times)
- POST to `${hub}/api/onboard/register` with `{ "agent_id": name }`
- Parse response: extract token, hub_ws_url, hub_api_url, default_repo
- Save token to progress file
Log: `[2/7] Registering agent "${name}"... done`

Step 3 — Clone repository:
- Fetch default_repo from registration response (or GET `${hub}/api/config/default-repo`)
- If no default_repo configured, fail with: "Hub has no default_repo configured. Run: curl -X PUT ${hub}/api/config/default-repo -H 'Authorization: Bearer <token>' -H 'Content-Type: application/json' -d '{\"url\":\"https://github.com/user/repo.git\"}'"
- Create install dir: `~/.agentcom/<agent-name>/`
- Clone: `git clone <repo_url> ~/.agentcom/<agent-name>/repo`
Log: `[3/7] Cloning repository... done`

Step 4 — Generate config:
- Create `~/.agentcom/<agent-name>/sidecar/config.json` from template:
```json
{
  "agent_id": "<name>",
  "token": "<token from registration>",
  "hub_url": "ws://<hub-host>:<hub-port>/ws",
  "hub_api_url": "<hub_api_url>",
  "repo_dir": "~/.agentcom/<agent-name>/repo",
  "reviewer": "",
  "wake_command": "openclaw agent --message \"Task: ${TASK_JSON}\" --session-id ${TASK_ID}",
  "capabilities": ["code"],
  "confirmation_timeout_ms": 30000,
  "results_dir": "./results",
  "log_file": "./sidecar.log"
}
```
- Resolve repo_dir to absolute path
- Copy sidecar files (index.js, agentcom-git.js, package.json, package-lock.json, ecosystem.config.js, start.sh, start.bat) from the script's directory (__dirname) to the agent's sidecar directory at `~/.agentcom/<agent-name>/sidecar/`
Wait — actually the sidecar is in the cloned repo. So config.json goes into `~/.agentcom/<agent-name>/repo/sidecar/config.json`. And repo_dir points to `~/.agentcom/<agent-name>/repo/`.

Revised: Write config.json into the cloned repo's sidecar directory: `<install_dir>/repo/sidecar/config.json`. The repo already contains index.js, ecosystem.config.js, etc. from the clone.
Log: `[4/7] Generating sidecar config... done`

Step 5 — Install dependencies:
- Run `npm install --production` in `<install_dir>/repo/sidecar/`
- Use execSync with cwd option
Log: `[5/7] Installing dependencies... done`

Step 6 — Start pm2 process:
- pm2 process name: `agentcom-<agent-name>` (unique per agent)
- Modify the ecosystem config approach: instead of using the repo's ecosystem.config.js (which has hardcoded name), generate a per-agent ecosystem file at `<install_dir>/ecosystem.config.js` with the agent-specific name and cwd pointing to `<install_dir>/repo/sidecar/`
- Run: `pm2 start <install_dir>/ecosystem.config.js`
- Run: `pm2 save`
- Wait 3 seconds for sidecar to connect
Log: `[6/7] Starting pm2 process "agentcom-<name>"... done`

Step 7 — Verify with test task:
- Submit test task via POST `${hub}/api/tasks` with auth header (Bearer token from step 2):
  ```json
  {
    "description": "Onboarding test: echo 'Agent <name> online'",
    "priority": "urgent",
    "metadata": { "onboarding_test": true }
  }
  ```
- Poll GET `${hub}/api/tasks/<task_id>` every 2 seconds for up to 30 seconds
- On completion (status "completed"): print success
- On timeout: print HARD FAILURE — "Agent registered and running but test task did not complete within 30 seconds. Check sidecar logs: pm2 logs agentcom-<name>"
- On success: clean up test task (no branch/PR cleanup needed since onboarding_test metadata means git workflow can be skipped — but this depends on hub behavior; if a branch/PR was created, log a warning but don't fail)
Log: `[7/7] Verifying test task... done`

**After success, print quick-start guide:**
```
=====================================
  Agent "<name>" is online!
=====================================

Quick start:
  Submit a task:   node sidecar/agentcom-submit.js --description "Fix the login bug" --hub <hub_url> --token <token>
  Check status:    pm2 status agentcom-<name>
  View logs:       pm2 logs agentcom-<name>
  View dashboard:  open <hub_url> in browser
  Remove agent:    node sidecar/remove-agent.js --name <name> --hub <hub_url> --token <token>

Agent directory:   ~/.agentcom/<name>/
Sidecar config:    ~/.agentcom/<name>/repo/sidecar/config.json
```

**Error handling:**
- Each step wrapped in try/catch
- On failure: log which step failed, save progress, exit 1
- Suggest `--resume` flag on failure

**HTTP helper function:**
Create a helper `httpRequest(method, url, body, headers)` that returns `{ statusCode, body }` using Node.js built-in `http`/`https` module. Use the pattern:
```javascript
function httpRequest(method, url, body = null, headers = {}) {
  return new Promise((resolve, reject) => {
    const u = new URL(url);
    const mod = u.protocol === 'https:' ? require('https') : require('http');
    const opts = { method, hostname: u.hostname, port: u.port, path: u.pathname + u.search, headers: { 'Content-Type': 'application/json', ...headers } };
    const req = mod.request(opts, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => resolve({ statusCode: res.statusCode, body: data ? JSON.parse(data) : null }));
    });
    req.on('error', reject);
    if (body) req.write(JSON.stringify(body));
    req.end();
  });
}
```

Since this is a CLI script (not the long-running sidecar), using async/await with promises is fine. Make the main function async.

**IMPORTANT:** Use `util.parseArgs` from Node.js built-in (not any npm package). Use `const { parseArgs } = require('node:util');`.
  </action>
  <verify>
Run `node sidecar/add-agent.js --help` (should show usage or error about missing --hub). Run `node -c sidecar/add-agent.js` to syntax check. Verify the script file exists and is > 200 lines.
  </verify>
  <done>
add-agent.js accepts --hub (required), --name (optional), --resume (optional). Pre-flight checks validate environment. Registers with hub, clones repo, generates config, installs deps, starts pm2, verifies with test task, prints quick-start guide. Resume flag skips completed steps.
  </done>
</task>

</tasks>

<verification>
1. `node -c sidecar/culture-names.js` passes syntax check
2. `node -c sidecar/add-agent.js` passes syntax check
3. culture-names.js exports 55+ Culture ship names with gcu- prefix
4. add-agent.js parses --hub, --name, --resume flags
5. add-agent.js contains 7-step onboarding flow
6. add-agent.js uses built-in util.parseArgs (no npm deps)
7. add-agent.js creates config.json from template with token from hub
8. add-agent.js submits test task and polls for 30s
</verification>

<success_criteria>
Running `node add-agent.js --hub http://hub:4000` on a machine with the prerequisites performs complete agent provisioning: generates Culture ship name, registers with hub, clones repo, writes config, installs deps, starts pm2, and verifies with a test task. Re-running with --resume skips completed steps.
</success_criteria>

<output>
After completion, create `.planning/phases/08-onboarding/08-02-SUMMARY.md`
</output>

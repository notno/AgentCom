---
phase: 08-onboarding
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - sidecar/remove-agent.js
  - sidecar/agentcom-submit.js
autonomous: true

must_haves:
  truths:
    - "Running remove-agent --name <name> --hub <url> --token <token> stops pm2 process, revokes token, and deletes agent directory"
    - "Running agentcom-submit --description '...' --hub <url> --token <token> submits a task to the queue and returns task_id"
    - "agentcom-submit supports --priority, --target, and --metadata flags"
  artifacts:
    - path: "sidecar/remove-agent.js"
      provides: "Agent teardown script"
      contains: "parseArgs"
    - path: "sidecar/agentcom-submit.js"
      provides: "Task submission CLI"
      contains: "parseArgs"
  key_links:
    - from: "sidecar/remove-agent.js"
      to: "DELETE /admin/tokens/:agent_id"
      via: "HTTP request to revoke agent token"
      pattern: "/admin/tokens/"
    - from: "sidecar/agentcom-submit.js"
      to: "POST /api/tasks"
      via: "HTTP request to submit task"
      pattern: "/api/tasks"
---

<objective>
Build the remove-agent teardown script and agentcom-submit task submission CLI. These complete the onboarding toolchain: add-agent provisions, remove-agent tears down, agentcom-submit makes the system immediately usable.

Purpose: remove-agent enables clean teardown (deregister, stop pm2, delete directory). agentcom-submit provides the CLI interface for submitting tasks, making the system usable right after onboarding without needing to craft curl commands.
Output: sidecar/remove-agent.js (teardown script) and sidecar/agentcom-submit.js (task submission CLI)
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@sidecar/agentcom-git.js
@lib/agent_com/endpoint.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create remove-agent.js teardown script</name>
  <files>sidecar/remove-agent.js</files>
  <action>
Create sidecar/remove-agent.js as a standalone Node.js CLI script. Uses Node.js built-in `util.parseArgs` for flag parsing (zero npm dependencies).

**CLI interface:**
```
node remove-agent.js --name gcu-sleeper-service --hub http://hub:4000 --token <token>
```

Flags (via util.parseArgs):
- `--name` (string, required): Agent name to remove
- `--hub` (string, required): Hub API URL
- `--token` (string, required): Auth token for the agent (read from agent's config.json before deletion, or passed explicitly)

If --token is not provided, attempt to read it from `~/.agentcom/<name>/repo/sidecar/config.json` before deletion. If that file doesn't exist either, fail with helpful message.

**Steps (in order):**

Step 1 — Stop pm2 process:
- Run `pm2 stop agentcom-<name>` (execSync, ignore errors if process doesn't exist)
- Run `pm2 delete agentcom-<name>` (execSync, ignore errors)
- Run `pm2 save` (persist removal)
Log: `[1/3] Stopping pm2 process "agentcom-<name>"... done`

Step 2 — Revoke token from hub:
- DELETE `${hub}/admin/tokens/${name}` with Authorization header: `Bearer ${token}`
- If 200: token revoked
- If error: log warning but continue (agent dir will still be deleted)
Log: `[2/3] Revoking hub token... done`

Step 3 — Delete agent directory:
- Remove `~/.agentcom/<name>/` recursively (fs.rmSync with { recursive: true, force: true })
- If directory doesn't exist, log "already removed" and continue
Log: `[3/3] Removing agent directory... done`

**After completion, print:**
```
Agent "<name>" has been removed.
- pm2 process stopped and deleted
- Hub token revoked
- Directory ~/.agentcom/<name>/ deleted
```

**HTTP helper:** Same httpRequest pattern as add-agent.js — create inline (these are standalone scripts, not sharing modules). Or simpler: use http.request synchronously via execSync + curl if available, but prefer the async approach for consistency.

Actually, for simplicity in a teardown script (only one HTTP call), use a synchronous approach: spawn curl or use the built-in http module with a blocking pattern. The simplest approach: use the same async httpRequest + async main pattern from add-agent.js.

**Error handling:** Each step wrapped in try/catch. Failures log warnings but continue to next step (best-effort cleanup). Only exit 1 if all steps fail.
  </action>
  <verify>
Run `node -c sidecar/remove-agent.js` to syntax check. Run `node sidecar/remove-agent.js` without flags to verify it shows a usage error about missing required flags.
  </verify>
  <done>
remove-agent.js accepts --name, --hub, --token (or reads token from agent config). Stops pm2 process, revokes hub token, deletes agent directory. Best-effort cleanup continues through errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agentcom-submit.js task submission CLI</name>
  <files>sidecar/agentcom-submit.js</files>
  <action>
Create sidecar/agentcom-submit.js as a standalone Node.js CLI script. Uses Node.js built-in `util.parseArgs` for flag parsing (zero npm dependencies).

**CLI interface:**
```
node agentcom-submit.js --description "Fix the login page bug" --hub http://hub:4000 --token abc123
node agentcom-submit.js --description "Deploy v2" --hub http://hub:4000 --token abc123 --priority urgent
node agentcom-submit.js --description "Fix issue #42" --hub http://hub:4000 --token abc123 --priority normal --metadata '{"issue": 42}'
```

Flags (via util.parseArgs):
- `--description` (string, required): Task description
- `--hub` (string, required): Hub API URL
- `--token` (string, required): Auth token for API access
- `--priority` (string, optional, default "normal"): Task priority — "low", "normal", "urgent", "critical"
- `--target` (string, optional): Target agent name for directed task
- `--metadata` (string, optional): JSON string of additional metadata

**Implementation:**

1. Parse and validate flags
   - --description, --hub, --token are required — exit 1 with usage message if missing
   - --priority validated against allowed values ["low", "normal", "urgent", "critical"]
   - --metadata parsed as JSON if provided (try/catch JSON.parse, exit 1 on invalid JSON)

2. Build task payload:
```json
{
  "description": "<description>",
  "priority": "<priority>",
  "metadata": <parsed metadata or {}>,
  "needed_capabilities": []
}
```
If --target is provided, add `"target_agent": "<target>"` to metadata (the hub doesn't have a first-class target field, but metadata can carry it for future use; alternatively check if the hub supports it).

3. Submit via POST `${hub}/api/tasks` with headers:
   - `Authorization: Bearer ${token}`
   - `Content-Type: application/json`

4. On success (201):
```
Task submitted successfully.
  Task ID:   <task_id>
  Priority:  <priority>
  Status:    queued
  Created:   <created_at>

Track: curl -H "Authorization: Bearer <token>" ${hub}/api/tasks/<task_id>
```

5. On error: print the error response and exit 1.

**HTTP helper:** Same async httpRequest + async main pattern. Only one HTTP call needed.

**Pattern note:** This script is intentionally standalone (not integrated into the sidecar process). It's a human-facing CLI tool like agentcom-git.js. The --token flag means it can be used from any machine, not just the agent's machine.
  </action>
  <verify>
Run `node -c sidecar/agentcom-submit.js` to syntax check. Run `node sidecar/agentcom-submit.js` without flags to verify it shows a usage error about missing required flags.
  </verify>
  <done>
agentcom-submit.js accepts --description (required), --hub (required), --token (required), --priority (optional), --target (optional), --metadata (optional JSON). Submits task to hub via POST /api/tasks and prints task_id on success.
  </done>
</task>

</tasks>

<verification>
1. `node -c sidecar/remove-agent.js` passes syntax check
2. `node -c sidecar/agentcom-submit.js` passes syntax check
3. remove-agent.js parses --name, --hub, --token flags
4. remove-agent.js has 3-step teardown (pm2 stop, token revoke, dir delete)
5. agentcom-submit.js parses --description, --hub, --token, --priority, --target, --metadata
6. agentcom-submit.js posts to /api/tasks with auth header
7. Both scripts use built-in util.parseArgs (no npm deps)
</verification>

<success_criteria>
remove-agent.js performs clean teardown: stops pm2, revokes hub token, deletes agent directory. agentcom-submit.js submits tasks to the hub with full flag support (priority, target, metadata). Both scripts are standalone with zero npm dependencies.
</success_criteria>

<output>
After completion, create `.planning/phases/08-onboarding/08-03-SUMMARY.md`
</output>

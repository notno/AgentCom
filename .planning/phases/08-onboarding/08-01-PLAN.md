---
phase: 08-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/agent_com/endpoint.ex
autonomous: true

must_haves:
  truths:
    - "POST /api/onboard/register with agent name returns agent_id + token + hub config without requiring authentication"
    - "GET /api/config/default-repo returns the configured default repository URL"
    - "PUT /api/config/default-repo sets the default repository URL (auth required)"
    - "DELETE /admin/tokens/:agent_id revokes agent token (already exists, used by remove-agent)"
  artifacts:
    - path: "lib/agent_com/endpoint.ex"
      provides: "Registration and config API endpoints"
      contains: "/api/onboard/register"
  key_links:
    - from: "POST /api/onboard/register"
      to: "AgentCom.Auth.generate/1"
      via: "token generation for new agent"
      pattern: "Auth\\.generate"
    - from: "GET /api/config/default-repo"
      to: "AgentCom.Config.get/1"
      via: "DETS config lookup"
      pattern: "Config\\.get\\(:default_repo\\)"
    - from: "PUT /api/config/default-repo"
      to: "AgentCom.Config.put/2"
      via: "DETS config write"
      pattern: "Config\\.put\\(:default_repo"
---

<objective>
Add hub-side API endpoints for agent onboarding: a registration endpoint that generates auth tokens without requiring pre-existing authentication (solving the chicken-and-egg problem), and a config endpoint for the default repository URL that new agents clone.

Purpose: The add-agent script needs to register with the hub to get a token and fetch the repo URL. Existing /admin/tokens requires auth, creating a chicken-and-egg problem for new agents.
Output: Two new endpoint groups in endpoint.ex — /api/onboard/register (unauthenticated) and /api/config/default-repo (GET unauthenticated, PUT authenticated)
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/agent_com/endpoint.ex
@lib/agent_com/auth.ex
@lib/agent_com/config.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add POST /api/onboard/register endpoint</name>
  <files>lib/agent_com/endpoint.ex</files>
  <action>
Add a new route `post "/api/onboard/register"` to endpoint.ex. This endpoint is UNAUTHENTICATED (no RequireAuth call) — it uses network trust (local network only, same as /api/dashboard/state pattern).

Request body: `{ "agent_id": "gcu-sleeper-service" }`

Implementation:
1. Extract agent_id from body_params
2. Validate agent_id is present and is a non-empty string
3. Check for existing agent with same name via AgentCom.Auth.list() — if found, return 409 Conflict with error "agent_id already registered"
4. Call AgentCom.Auth.generate(agent_id) to create token
5. Fetch default_repo from AgentCom.Config.get(:default_repo) — may be nil
6. Return 201 with JSON: `{ "agent_id": agent_id, "token": token, "hub_ws_url": "ws://#{host}:#{port}/ws", "hub_api_url": "http://#{host}:#{port}", "default_repo": default_repo }`

For hub_ws_url and hub_api_url: use conn.host and conn.port to construct the URLs dynamically. Use the pattern:
```elixir
host = conn.host
port = conn.port
hub_ws_url = "ws://#{host}:#{port}/ws"
hub_api_url = "http://#{host}:#{port}"
```

Place this route BEFORE the catch-all match at the bottom of endpoint.ex, near the existing /admin/tokens routes. Use the same send_json helper pattern used throughout.

Return 400 if agent_id is missing. Return 409 if agent_id already exists.
  </action>
  <verify>
Run `mix compile` from C:/Users/nrosq/src/AgentCom to verify no compilation errors. Then grep endpoint.ex for "/api/onboard/register" to confirm route exists.
  </verify>
  <done>
POST /api/onboard/register accepts { agent_id } without auth, generates token via Auth.generate, returns 201 with agent_id + token + hub URLs + default_repo. Returns 400 on missing agent_id, 409 on duplicate.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GET/PUT /api/config/default-repo endpoints</name>
  <files>lib/agent_com/endpoint.ex</files>
  <action>
Add two routes to endpoint.ex for managing the default repository URL:

1. `get "/api/config/default-repo"` — UNAUTHENTICATED (onboarding script needs this before it has a token)
   - Call AgentCom.Config.get(:default_repo)
   - If nil, return 200 with `{ "default_repo": null, "configured": false }`
   - If set, return 200 with `{ "default_repo": value, "configured": true }`

2. `put "/api/config/default-repo"` — AUTHENTICATED (admin sets this up once)
   - Call RequireAuth, return if halted
   - Extract "url" from body_params
   - Validate url is a non-empty string, return 400 if missing
   - Call AgentCom.Config.put(:default_repo, url)
   - Return 200 with `{ "status": "ok", "default_repo": url }`

Place these routes near the existing /api/config/heartbeat-interval routes for organizational consistency.

Note: The existing AgentCom.Config GenServer (DETS-backed) already supports arbitrary atom keys via get/put — no changes needed to config.ex. The :default_repo key will be stored automatically.
  </action>
  <verify>
Run `mix compile` from C:/Users/nrosq/src/AgentCom to verify no compilation errors. Grep endpoint.ex for "default-repo" to confirm both routes exist.
  </verify>
  <done>
GET /api/config/default-repo returns current default_repo value (no auth). PUT /api/config/default-repo sets the value (auth required). Both compile without errors.
  </done>
</task>

</tasks>

<verification>
1. `mix compile` succeeds with zero errors
2. Endpoint.ex contains route for POST /api/onboard/register
3. Endpoint.ex contains routes for GET and PUT /api/config/default-repo
4. Registration endpoint does NOT call RequireAuth
5. PUT default-repo endpoint DOES call RequireAuth
6. Registration returns 201 with token, hub URLs, and default_repo
</verification>

<success_criteria>
Hub has three new API endpoints: registration (unauthenticated, returns token), config read (unauthenticated), and config write (authenticated). All compile cleanly and follow existing endpoint.ex patterns.
</success_criteria>

<output>
After completion, create `.planning/phases/08-onboarding/08-01-SUMMARY.md`
</output>

---
phase: 07-git-workflow
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - sidecar/index.js
  - sidecar/config.json.example
autonomous: false

must_haves:
  truths:
    - "Sidecar auto-runs start-task before waking agent on task assignment"
    - "Sidecar auto-runs submit after agent reports task_complete (before notifying hub)"
    - "If start-task fails, agent is still woken with a git_warning field in the task"
    - "PR URL is included in task_complete message sent to hub"
    - "config.json.example includes repo_dir, reviewer, and hub_api_url fields"
  artifacts:
    - path: "sidecar/index.js"
      provides: "Git lifecycle hooks in handleTaskAssign and handleResult"
      contains: "runGitCommand"
    - path: "sidecar/config.json.example"
      provides: "Updated config template with git workflow fields"
      contains: "repo_dir"
  key_links:
    - from: "sidecar/index.js"
      to: "sidecar/agentcom-git.js"
      via: "execSync child process invocation"
      pattern: "agentcom-git\\.js"
    - from: "sidecar/index.js handleTaskAssign"
      to: "agentcom-git start-task"
      via: "runGitCommand('start-task', ...)"
      pattern: "runGitCommand.*start-task"
    - from: "sidecar/index.js handleResult"
      to: "agentcom-git submit"
      via: "runGitCommand('submit', ...)"
      pattern: "runGitCommand.*submit"
---

<objective>
Wire agentcom-git into the sidecar's task lifecycle so the full autonomous pipeline works: task assigned -> fetch + branch -> wake agent -> agent works -> agent reports complete -> push + open PR -> report PR URL to hub.

Purpose: The CLI tool from Plan 01 is standalone. This plan integrates it into the sidecar so the git workflow happens automatically without agent intervention.

Output: Modified `sidecar/index.js` with git lifecycle hooks, updated `sidecar/config.json.example`
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-git-workflow/07-RESEARCH.md
@.planning/phases/07-git-workflow/07-01-SUMMARY.md
@sidecar/index.js
@sidecar/agentcom-git.js
@sidecar/config.json.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add runGitCommand helper and wire git lifecycle into sidecar</name>
  <files>sidecar/index.js, sidecar/config.json.example</files>
  <action>
**Part A: Update config.json.example**

Add three new fields to the example config:
```json
{
  "agent_id": "my-agent",
  "token": "paste-token-here",
  "hub_url": "ws://hub-hostname:4000/ws",
  "hub_api_url": "http://hub-hostname:4000",
  "repo_dir": "/path/to/agent/working/repo",
  "reviewer": "flere-imsaho",
  "wake_command": "openclaw agent --message \"Task: ${TASK_JSON}\" --session-id ${TASK_ID}",
  "capabilities": ["code"],
  "confirmation_timeout_ms": 30000,
  "results_dir": "./results",
  "log_file": "./sidecar.log"
}
```

**Part B: Add runGitCommand helper to index.js**

Add `const { execSync } = require('child_process');` at the top (the file already imports `exec` from child_process -- change to destructure both: `const { exec, execSync } = require('child_process');`).

Add a new section between section 4 (Wake Command) and section 5 (Result File Watcher), numbered as section 4b or similar:

```javascript
// =============================================================================
// 4b. Git Workflow Integration
// =============================================================================

/**
 * Invoke agentcom-git.js as a child process.
 * Returns parsed JSON output. On error, returns { status: 'error', error: message }.
 */
function runGitCommand(command, args) {
  const gitCliPath = path.join(__dirname, 'agentcom-git.js');
  const argsJson = JSON.stringify(args);
  try {
    const output = execSync(
      `node "${gitCliPath}" ${command} ${JSON.stringify(argsJson)}`,
      { encoding: 'utf-8', timeout: 180000, shell: true, windowsHide: true }
    );
    return JSON.parse(output.trim());
  } catch (err) {
    // agentcom-git outputs JSON even on error (to stdout captured in err.stdout)
    try {
      return JSON.parse((err.stdout || '').trim());
    } catch {
      return { status: 'error', error: err.message };
    }
  }
}
```

Note on the double-JSON-stringify: `argsJson` is the JSON string, then `JSON.stringify(argsJson)` wraps it in quotes for safe shell passing. The CLI does `JSON.parse(process.argv[3])` which unwraps one level. This handles special characters in task descriptions on both Windows and Unix.

**Part C: Modify handleTaskAssign in HubConnection**

In `handleTaskAssign(msg)`, add git start-task BETWEEN persisting the task and calling wakeAgent. The modified flow:

1. (Existing) Check if busy, reject if so
2. (Existing) Track generation
3. (Existing) Create task object, persist to queue, send task_accepted
4. **(NEW)** If `_config.repo_dir` is configured, run start-task:
   ```javascript
   // Git workflow: create branch before waking agent
   if (_config.repo_dir) {
     const gitResult = runGitCommand('start-task', {
       agent_id: this.config.agent_id,
       task_id: msg.task_id,
       description: msg.description || '',
       metadata: msg.metadata || {}
     });

     if (gitResult.status === 'ok') {
       task.branch = gitResult.branch;
       log('git_start_task_ok', { task_id: msg.task_id, branch: gitResult.branch });
     } else {
       // Per CONTEXT.md: wake agent anyway with warning
       task.git_warning = gitResult.error || 'start-task failed';
       log('git_start_task_failed', { task_id: msg.task_id, error: gitResult.error });
     }
     saveQueue(_queue);
   }
   ```
5. (Existing) Call wakeAgent

The key behavior: if `repo_dir` is NOT in config, git workflow is entirely skipped (backward-compatible with existing sidecars). If start-task fails, agent is still woken with `git_warning` on the task object.

**Part D: Modify handleResult to run submit before hub notification**

In the existing `handleResult(taskId, filePath, hub)` function, add git submit BEFORE sending task_complete to hub. The modified flow:

After parsing the result JSON and before the success/failure branch:

```javascript
// In the success branch (result.status === 'success'):
if (result.status === 'success') {
  // Git workflow: push branch and create PR before reporting to hub
  if (_config.repo_dir) {
    const gitResult = runGitCommand('submit', {
      agent_id: _config.agent_id,
      task_id: taskId,
      task: _queue.active  // Full task data for PR description
    });

    if (gitResult.status === 'ok') {
      result.pr_url = gitResult.pr_url;
      log('git_submit_ok', { task_id: taskId, pr_url: gitResult.pr_url });
    } else {
      log('git_submit_failed', { task_id: taskId, error: gitResult.error });
      // Still report task complete, just without PR URL
    }
  }

  log('task_complete', { task_id: taskId, output: result.output, pr_url: result.pr_url });
  hub.sendTaskComplete(taskId, result);
}
```

Move the existing `log('task_complete', ...)` call to AFTER the git submit block so it can include the pr_url.

**Part E: Update loadConfig defaults**

In `loadConfig()`, add defaults for new fields:
```javascript
config.repo_dir = config.repo_dir || '';  // Empty string = git workflow disabled
config.reviewer = config.reviewer || '';
config.hub_api_url = config.hub_api_url || '';
```

Do NOT add repo_dir to the `required` array -- it's optional (backward-compatible).

If `config.repo_dir` is set but not absolute, resolve it against `__dirname` (same pattern as log_file and results_dir).
  </action>
  <verify>
1. Review `sidecar/index.js` to confirm `runGitCommand` helper exists and is called from both `handleTaskAssign` and `handleResult`.
2. Confirm `config.json.example` has `repo_dir`, `reviewer`, and `hub_api_url` fields.
3. Confirm backward compatibility: if `repo_dir` is empty/missing in config, git workflow is completely skipped.
4. Confirm start-task failure still wakes the agent (git_warning field set, wakeAgent still called).
  </verify>
  <done>
Sidecar automatically runs agentcom-git start-task before waking agent and submit after task completion. PR URL flows from agentcom-git -> sidecar -> hub. Config example updated with git workflow fields. Sidecars without repo_dir continue working unchanged.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify git workflow pipeline</name>
  <files>sidecar/agentcom-git.js, sidecar/index.js</files>
  <action>
CHECKPOINT: Human verification of the complete Phase 7 git workflow.

What was built: Complete agentcom-git CLI tool and sidecar integration. The full pipeline is:
1. `agentcom-git start-task` -- fetches origin, creates branch from origin/main
2. `agentcom-git submit` -- pushes branch, opens PR with metadata, labels, reviewer
3. `agentcom-git status` -- reports branch, diff, uncommitted changes
4. Sidecar auto-invokes start-task on assignment and submit on completion

How to verify:

**Test 1: CLI status command**
```bash
cd C:\Users\nrosq\src\AgentCom
node sidecar/agentcom-git.js status
```
Expect: JSON output with current branch (`main`), `commits_ahead: 0`, `is_clean: true/false`

**Test 2: CLI start-task (creates branch)**
```bash
node sidecar/agentcom-git.js start-task "{\"agent_id\":\"test-agent\",\"task_id\":\"test-001\",\"description\":\"Add login endpoint\"}"
```
Expect: JSON with `branch: "test/add-login-endpoint"`, `base_commit: "..."`. Verify with `git branch` showing the new branch.

**Test 3: CLI status on new branch**
```bash
node sidecar/agentcom-git.js status
```
Expect: `branch: "test/add-login-endpoint"`, `commits_ahead: 0`

**Test 4: Return to main (cleanup)**
```bash
git checkout main
git branch -D test/add-login-endpoint
```

**Test 5: Verify sidecar code review**
Open `sidecar/index.js` and confirm:
- `runGitCommand` helper exists
- `handleTaskAssign` calls `runGitCommand('start-task', ...)` before `wakeAgent`
- `handleResult` calls `runGitCommand('submit', ...)` before `hub.sendTaskComplete`
- Failure in start-task still proceeds to wakeAgent
- `config.json.example` has `repo_dir`, `reviewer`, `hub_api_url`

**Test 6: Verify backward compat**
Confirm that if `repo_dir` is not set in config, git operations are completely skipped (no errors, no git commands).
  </action>
  <verify>Run all 6 tests above. All should pass.</verify>
  <done>Human has verified the git workflow pipeline works end-to-end: CLI commands produce correct output, sidecar integration is wired correctly, and backward compatibility is maintained.</done>
</task>

</tasks>

<verification>
1. `node sidecar/agentcom-git.js status` produces valid JSON with branch info
2. `node sidecar/agentcom-git.js start-task` creates branch from origin/main
3. Sidecar index.js has runGitCommand helper used in handleTaskAssign and handleResult
4. config.json.example includes repo_dir, reviewer, hub_api_url
5. Git workflow is opt-in: sidecars without repo_dir are unaffected
6. start-task failure does not prevent agent wake (git_warning set instead)
7. submit failure does not prevent task_complete reporting (just omits pr_url)
</verification>

<success_criteria>
- Full pipeline wired: task_assign -> start-task -> wake -> work -> submit -> task_complete with pr_url
- Backward compatible: existing sidecars without repo_dir work unchanged
- Graceful degradation: git failures are warnings, not blockers
- PR URL flows from sidecar to hub in task_complete result
</success_criteria>

<output>
After completion, create `.planning/phases/07-git-workflow/07-02-SUMMARY.md`
</output>

---
phase: 07-git-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidecar/agentcom-git.js
autonomous: true

must_haves:
  truths:
    - "Running `node agentcom-git.js start-task '{...}'` with a clean repo fetches origin and creates a branch {agent}/{slug} from origin/main"
    - "Running `node agentcom-git.js submit '{...}'` pushes branch and creates a PR with task metadata, agent label, priority label, and reviewer"
    - "Running `node agentcom-git.js status` outputs JSON with current branch, commits ahead, diff from main, and uncommitted changes"
    - "All commands output structured JSON to stdout (never interactive prompts)"
    - "start-task fails with error JSON when working tree is dirty"
  artifacts:
    - path: "sidecar/agentcom-git.js"
      provides: "CLI wrapper for git workflow commands (start-task, submit, status)"
      min_lines: 200
  key_links:
    - from: "sidecar/agentcom-git.js"
      to: "git CLI"
      via: "child_process.execSync"
      pattern: "execSync.*git"
    - from: "sidecar/agentcom-git.js"
      to: "gh CLI"
      via: "child_process.execSync for PR creation"
      pattern: "execSync.*gh"
    - from: "sidecar/agentcom-git.js"
      to: "sidecar/config.json"
      via: "fs.readFileSync for repo_dir, reviewer, hub_api_url"
      pattern: "config\\.repo_dir"
---

<objective>
Build the `agentcom-git` CLI tool -- a single Node.js file that wraps git and gh CLI commands into three autonomous agent commands: `start-task` (fetch + branch), `submit` (push + PR), and `status` (branch info + diff).

Purpose: Agents need enforced git hygiene -- always branching from fresh main, submitting work as PRs with rich metadata, and reporting their git state. This CLI is the standalone tool the sidecar will invoke.

Output: `sidecar/agentcom-git.js` -- executable via `node agentcom-git.js <command> <json-args>`
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-git-workflow/07-RESEARCH.md
@sidecar/config.json.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agentcom-git.js CLI with start-task, submit, and status commands</name>
  <files>sidecar/agentcom-git.js</files>
  <action>
Create `sidecar/agentcom-git.js` as a single Node.js file using only built-in modules (`child_process`, `path`, `fs`). The file implements three commands dispatched via `process.argv[2]`, with JSON arguments on `process.argv[3]`.

**Shared infrastructure:**

1. `git(cmd, opts)` helper -- runs `git ${cmd}` via `execSync` with `cwd: config.repo_dir`, `encoding: 'utf-8'`, `shell: true`, `timeout: 60000`, `windowsHide: true`. Returns trimmed stdout. On error, throws with stderr.

2. `gh(cmd, opts)` helper -- same as git() but for `gh` commands, with `timeout: 120000` (PR creation can be slow). Sets `GH_PROMPT_DISABLED=1` in env to prevent interactive prompts.

3. `outputSuccess(data)` -- writes `JSON.stringify({ status: 'ok', ...data })` to stdout and exits 0.

4. `outputError(message, details)` -- writes `JSON.stringify({ status: 'error', error: message, ...details })` to stdout and exits 1.

5. `generateSlug(description, maxLength=40)` -- auto-slugify: lowercase, strip non-alphanumeric (keep spaces/hyphens), spaces to hyphens, collapse multiples, trim leading/trailing hyphens, truncate to maxLength, clean trailing hyphen from truncation.

6. Config loading: reads `config.json` from `__dirname`. Validates `repo_dir` exists and is a git repository (check for `.git` directory). Uses `config.repo_dir` for all git/gh commands.

**Command: start-task**

Args: `{ agent_id, task_id, description, metadata }`

Steps:
1. Check working tree is clean: `git status --porcelain`. If output is non-empty, call `outputError('dirty_working_tree', { files: [...] })`.
2. Fetch origin: `git fetch origin`. On failure, call `outputError('fetch_failed', { ... })`.
3. Generate branch name: `{shortAgent}/{slug}` where shortAgent is `agent_id.split('-')[0].slice(0, 8)` and slug is `generateSlug(description)`.
4. Delete existing local branch if it exists (handles re-assignment): `git branch -D {branch}` (catch and ignore errors).
5. Create branch from origin/main: `git checkout -b {branch} origin/main`.
6. Output success: `{ branch, base_commit: git('rev-parse --short HEAD'), repo_dir }`.

**Command: submit**

Args: `{ agent_id, task_id, task }` (task is the full task object with description, metadata)

Steps:
1. Get current branch: `git rev-parse --abbrev-ref HEAD`. If `main` or `master`, call `outputError('on_main_branch')`.
2. Check for uncommitted changes: `git status --porcelain`. If non-empty, log warning to stderr (JSON format) but proceed.
3. Check for commits: `git rev-list --count origin/main..HEAD`. If 0, call `outputError('no_commits', { hint: 'Agent made no commits on this branch' })`.
4. Push with force-with-lease: `git push --force-with-lease origin {branch}`. Per Claude's discretion, force-with-lease is the safest default (prevents overwriting others' work while allowing re-submit).
5. Generate PR body using `generatePrBody(task, agent_id, diffStat)`:
   - Header: `## Task: {task_id}`
   - Agent, Priority, Task Link (`{hub_api_url}/api/tasks/{task_id}`)
   - Description section with original task description
   - Changes section with `git diff --stat origin/main...HEAD` output in code block
   - Footer: `*Submitted by agentcom-git | Agent: {agent_id} | Task: {task_id}*`
6. Ensure labels exist using `gh label create "{name}" --force` (idempotent):
   - `agent:{shortAgent}` (e.g. `agent:gcu`)
   - `priority:{level}` from `task.metadata.priority || 'normal'`
7. Write PR body to temp file `.pr-body.tmp` in repo_dir to avoid shell escaping issues (per research Pitfall 6).
8. Create PR: `gh pr create --base main --head "{branch}" --title "{title}" --body-file "{bodyFile}" --label "{agentLabel}" --label "{priorityLabel}" --reviewer "{config.reviewer}"`. Skip `--reviewer` if `config.reviewer` is not set.
9. Clean up temp file in finally block.
10. Output success: `{ pr_url, branch }`.

PR title: Use task description truncated to 60 chars. If longer, truncate at 57 + "...".

**Command: status**

Args: none required

Steps:
1. Get current branch: `git rev-parse --abbrev-ref HEAD`.
2. Get uncommitted changes: `git status --porcelain`.
3. Get diff from main: `git diff --stat origin/main...HEAD` (catch errors if origin/main doesn't exist).
4. Get commits ahead: `git rev-list --count origin/main..HEAD` (catch errors, default to '0').
5. Validate conventional commits: check all commits since origin/main with `git log --format=%s origin/main..HEAD`. Test each against regex `/^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?!?:\s.+/`. Include `non_conventional_commits` array in output.
6. Output success: `{ branch, commits_ahead, diff_from_main, uncommitted_changes: [...], is_clean, non_conventional_commits: [...] }`.

**Command dispatch (bottom of file):**
```javascript
const commands = { 'start-task': startTask, 'submit': submit, 'status': status };
const command = process.argv[2];
if (!commands[command]) {
  outputError('unknown_command', { command, available: Object.keys(commands) });
}
const args = process.argv[3] ? JSON.parse(process.argv[3]) : {};
commands[command](args);
```

**Error handling:** Wrap top-level command execution in try/catch. Any uncaught error outputs `outputError('unexpected_error', { message: err.message })`.
  </action>
  <verify>
Run `node sidecar/agentcom-git.js status` from the AgentCom repo root (after adding `repo_dir` to config.json temporarily or creating a test config). It should output JSON with current branch, commits ahead, diff, and uncommitted changes. Also verify `node sidecar/agentcom-git.js --help` (unknown command) returns error JSON.
  </verify>
  <done>
`sidecar/agentcom-git.js` exists with all three commands implemented. Each command outputs structured JSON. start-task validates clean tree and creates branch from origin/main. submit pushes and creates PR with full metadata, labels, and reviewer. status reports branch info and conventional commit compliance.
  </done>
</task>

</tasks>

<verification>
1. `node sidecar/agentcom-git.js unknown-cmd` exits 1 with JSON error containing "unknown_command"
2. `node sidecar/agentcom-git.js status` (with valid config) exits 0 with JSON containing branch, commits_ahead, is_clean
3. File has no external npm dependencies (only require('child_process'), require('path'), require('fs'))
4. All git/gh calls use `cwd: config.repo_dir`, never `__dirname`
5. `gh` helper sets `GH_PROMPT_DISABLED=1` in environment
</verification>

<success_criteria>
- `sidecar/agentcom-git.js` is a standalone Node.js CLI tool
- Three commands: start-task, submit, status -- all produce JSON output
- No interactive prompts, no external npm dependencies
- Shell escaping handled via --body-file for PR descriptions
- Force-with-lease used for safe push
- Labels created idempotently before PR creation
</success_criteria>

<output>
After completion, create `.planning/phases/07-git-workflow/07-01-SUMMARY.md`
</output>

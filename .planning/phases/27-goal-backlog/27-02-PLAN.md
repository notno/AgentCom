---
phase: 27-goal-backlog
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - lib/agent_com/endpoint.ex
  - lib/agent_com/validation/schemas.ex
  - sidecar/agentcom-submit-goal.js
autonomous: true

must_haves:
  truths:
    - "POST /api/goals creates a goal and returns 201 with goal_id"
    - "GET /api/goals returns list of all goals"
    - "GET /api/goals/:goal_id returns a single goal"
    - "PATCH /api/goals/:goal_id/transition advances goal lifecycle"
    - "GET /api/goals/stats returns backlog statistics"
    - "Invalid POST body returns 400 with validation errors"
    - "CLI tool agentcom-submit-goal.js submits a goal and prints the goal_id"
    - "All goal endpoints require auth token"
  artifacts:
    - path: "lib/agent_com/endpoint.ex"
      provides: "Goal API routes (POST, GET list, GET single, PATCH transition, GET stats)"
      contains: "post \"/api/goals\""
    - path: "lib/agent_com/validation/schemas.ex"
      provides: "post_goal and patch_goal_transition validation schemas"
      contains: "post_goal:"
    - path: "sidecar/agentcom-submit-goal.js"
      provides: "CLI tool for submitting goals from command line"
      contains: "agentcom-submit-goal"
  key_links:
    - from: "lib/agent_com/endpoint.ex"
      to: "lib/agent_com/goal_backlog.ex"
      via: "GoalBacklog.submit/1 and GoalBacklog.transition/3"
      pattern: "GoalBacklog\\.(submit|transition|list|get|stats)"
    - from: "lib/agent_com/endpoint.ex"
      to: "lib/agent_com/validation/schemas.ex"
      via: "Validation.validate_http(:post_goal, ...)"
      pattern: "validate_http\\(:post_goal"
    - from: "sidecar/agentcom-submit-goal.js"
      to: "lib/agent_com/endpoint.ex"
      via: "HTTP POST to /api/goals"
      pattern: "/api/goals"
---

<objective>
Wire GoalBacklog to external interfaces: HTTP API endpoints with validation, admin DETS operations, and a CLI sidecar tool for goal submission.

Purpose: Goals must be submittable from multiple sources -- HTTP API for programmatic access, CLI tool for human/script submission. This completes the multi-source intake requirement (GOAL-02).
Output: 5 HTTP routes, 2 validation schemas, admin table registration, and agentcom-submit-goal.js CLI tool.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-goal-backlog/27-RESEARCH.md
@.planning/phases/27-goal-backlog/27-01-SUMMARY.md
@lib/agent_com/endpoint.ex
@lib/agent_com/validation/schemas.ex
@sidecar/agentcom-submit.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation schemas and HTTP API routes for goals</name>
  <files>
lib/agent_com/validation/schemas.ex
lib/agent_com/endpoint.ex
  </files>
  <action>
**validation/schemas.ex -- Add 2 schemas to `@http_schemas`:**

1. `post_goal` schema:
   - Required: `"description" => :string`, `"success_criteria" => {:list, :string}`
   - Optional: `"priority" => :string`, `"source" => :string`, `"repo" => :string`, `"file_hints" => {:list, :string}`, `"tags" => {:list, :string}`, `"metadata" => :map`, `"depends_on" => {:list, :string}`
   - Description: "Submit a goal to the backlog."

2. `patch_goal_transition` schema:
   - Required: `"status" => :string`
   - Optional: `"reason" => :string`, `"child_task_ids" => {:list, :string}`
   - Description: "Transition a goal to a new lifecycle state."

**endpoint.ex -- Add Goal API routes section (place after Task Queue API section, before Admin section):**

IMPORTANT: Route ordering matters. `/api/goals/stats` MUST come BEFORE `/api/goals/:goal_id` to prevent "stats" matching as a goal_id parameter.

1. **GET /api/goals/stats** -- Auth-gated. Call `GoalBacklog.stats()`, return 200 with stats map.

2. **POST /api/goals** -- Auth-gated. Validate with `Validation.validate_http(:post_goal, conn.body_params)`. On valid: build params map with atom keys from body_params (description, success_criteria, priority, source defaulting to "api", tags, repo, file_hints, metadata, depends_on). Call `GoalBacklog.submit(params)`. Return 201 with `%{"status" => "submitted", "goal_id" => goal.id, "priority" => goal.priority, "created_at" => goal.created_at}`. On validation error: return 400 with errors.

3. **GET /api/goals** -- Auth-gated. Read optional query params `status` and `priority` from `conn.params`. Build filter map. Call `GoalBacklog.list(filters)`. Return 200 with `%{"goals" => goals_list}` where each goal is formatted as a JSON-safe map (atom status converted to string, etc.). Use a `format_goal/1` private helper to convert goal map to JSON-friendly format.

4. **GET /api/goals/:goal_id** -- Auth-gated. Call `GoalBacklog.get(goal_id)`. On `{:ok, goal}`: return 200 with formatted goal. On `{:error, :not_found}`: return 404 with `%{"error" => "goal_not_found"}`.

5. **PATCH /api/goals/:goal_id/transition** -- Auth-gated. Validate with `Validation.validate_http(:patch_goal_transition, conn.body_params)`. Convert status string to atom. Build opts keyword list from optional reason and child_task_ids. Call `GoalBacklog.transition(goal_id, status_atom, opts)`. On `{:ok, goal}`: return 200 with formatted goal. On `{:error, {:invalid_transition, from, to}}`: return 422 with descriptive error. On `{:error, :not_found}`: return 404.

6. **Add `"goal_backlog" => :goal_backlog` to `@dets_table_atoms`** for admin compact/restore endpoints.

**format_goal/1 helper:** Convert goal map to JSON-safe format -- atom keys to string keys, atom status to string, format timestamps. Place near the existing format helpers in endpoint.ex.
  </action>
  <verify>
Run `mix compile --warnings-as-errors` -- clean compilation.
Run `mix test` -- full suite passes.
Verify route ordering: grep for `/api/goals` in endpoint.ex and confirm stats route appears before `:goal_id` route.
  </verify>
  <done>5 HTTP routes operational (POST create, GET list, GET single, GET stats, PATCH transition) with input validation. Admin DETS operations registered. All routes require auth.</done>
</task>

<task type="auto">
  <name>Task 2: Create agentcom-submit-goal.js CLI sidecar tool</name>
  <files>sidecar/agentcom-submit-goal.js</files>
  <action>
Create `sidecar/agentcom-submit-goal.js` following the `agentcom-submit.js` pattern exactly. This is a standalone Node.js script with no shared module dependencies.

**CLI interface:**
```
node agentcom-submit-goal.js \
  --description "Implement rate limiting" \
  --criteria "Returns 429 after 100 req/min" \
  --criteria "Configurable via Config" \
  --hub http://localhost:4000 \
  --token abc123 \
  --priority normal \
  --tags refactor,performance \
  --repo https://github.com/user/repo
```

**parseArgs config:**
- `--description` (string, required) -- goal description
- `--criteria` (string, multiple: true, required) -- success criteria (repeatable flag)
- `--hub` (string, default: "http://localhost:4000") -- hub URL
- `--token` (string, required) -- auth token
- `--priority` (string, default: "normal") -- urgent/high/normal/low
- `--tags` (string, optional) -- comma-separated tags
- `--repo` (string, optional) -- target repository URL
- `--help` (boolean) -- show usage

**Implementation:**
1. Parse args with `node:util/parseArgs`
2. Validate required fields (description, criteria, token). Print usage and exit 1 if missing.
3. Build JSON body: `{ description, success_criteria: criteria_array, priority, source: "cli", tags: tags_string.split(","), repo }`
4. POST to `${hub}/api/goals` with `Authorization: Bearer ${token}` header and `Content-Type: application/json`
5. Use raw `node:http` or `node:https` (detect from URL protocol) -- same pattern as agentcom-submit.js
6. On 201: print `Goal submitted: ${response.goal_id}` to stdout, exit 0
7. On 4xx/5xx: print error to stderr, exit 1
8. On connection error: print connection error to stderr, exit 1

**Add shebang line:** `#!/usr/bin/env node` at top.
**Make file structure match agentcom-submit.js** -- self-contained, no imports from shared modules.
  </action>
  <verify>
Run `node sidecar/agentcom-submit-goal.js --help` -- prints usage without error.
Run `node sidecar/agentcom-submit-goal.js` (no args) -- prints usage and exits with code 1.
Verify the script parses `--criteria` as a repeatable flag by checking the parseArgs config.
  </verify>
  <done>agentcom-submit-goal.js CLI tool accepts --description, --criteria (repeatable), --priority, --hub, --token, --tags, --repo. Posts to /api/goals and prints goal_id on success. Follows agentcom-submit.js pattern exactly.</done>
</task>

</tasks>

<verification>
1. `mix compile --warnings-as-errors` -- clean compilation
2. `mix test` -- full suite passes
3. `curl -X POST http://localhost:4000/api/goals -H "Authorization: Bearer TOKEN" -H "Content-Type: application/json" -d '{"description":"test goal","success_criteria":["it works"]}'` -- returns 201 with goal_id
4. `curl http://localhost:4000/api/goals -H "Authorization: Bearer TOKEN"` -- returns goal list
5. `node sidecar/agentcom-submit-goal.js --help` -- prints usage
6. Verify /api/goals/stats route works before /:goal_id matching
</verification>

<success_criteria>
Goals can be submitted via HTTP API (POST /api/goals) and CLI tool (agentcom-submit-goal.js). Each returns a unique goal ID. Goals can be listed, retrieved individually, and transitioned through lifecycle states via API. All endpoints validate input and require authentication.
</success_criteria>

<output>
After completion, create `.planning/phases/27-goal-backlog/27-02-SUMMARY.md`
</output>

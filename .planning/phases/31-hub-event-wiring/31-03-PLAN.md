---
phase: 31-hub-event-wiring
plan: 03
type: tdd
wave: 3
depends_on: ["31-01", "31-02"]
files_modified:
  - test/agent_com/webhook_verifier_test.exs
  - test/agent_com/webhook_history_test.exs
  - test/agent_com/webhook_endpoint_test.exs
  - test/agent_com/hub_fsm/predicates_test.exs
autonomous: true

must_haves:
  truths:
    - "HMAC signature verification accepts valid signatures and rejects invalid ones"
    - "Webhook endpoint returns 401 for missing or bad signatures"
    - "Push events on active repos trigger FSM transition to :improving"
    - "PR merge events on active repos trigger FSM transition to :improving"
    - "Non-merge PR events are ignored"
    - "Events on non-active repos are ignored with 200 response"
    - "Predicates correctly evaluate :improving state"
    - "WebhookHistory stores and retrieves events with cap at 100"
  artifacts:
    - path: "test/agent_com/webhook_verifier_test.exs"
      provides: "HMAC verification unit tests"
      contains: "WebhookVerifierTest"
    - path: "test/agent_com/webhook_history_test.exs"
      provides: "ETS history unit tests"
      contains: "WebhookHistoryTest"
    - path: "test/agent_com/webhook_endpoint_test.exs"
      provides: "Integration tests for webhook HTTP endpoint"
      contains: "WebhookEndpointTest"
    - path: "test/agent_com/hub_fsm/predicates_test.exs"
      provides: "Extended predicate tests for :improving state"
      contains: "evaluate.*improving"
  key_links:
    - from: "test/agent_com/webhook_endpoint_test.exs"
      to: "lib/agent_com/endpoint.ex"
      via: "HTTP POST requests to /api/webhooks/github"
      pattern: "api/webhooks/github"
---

<objective>
Write comprehensive tests for all Phase 31 webhook functionality: HMAC verification, webhook history, endpoint integration, and :improving state predicates.

Purpose: Ensure webhook handling is correct, secure, and reliable. HMAC verification is security-critical and must be tested with valid and invalid signatures. Endpoint tests validate the full request flow.

Output: Test files covering signature verification, event handling, repo matching, FSM transitions, history storage, and predicate evaluation.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-hub-event-wiring/31-RESEARCH.md
@.planning/phases/31-hub-event-wiring/31-01-SUMMARY.md
@.planning/phases/31-hub-event-wiring/31-02-SUMMARY.md
@lib/agent_com/webhook_verifier.ex
@lib/agent_com/webhook_history.ex
@lib/agent_com/cache_body_reader.ex
@lib/agent_com/endpoint.ex
@lib/agent_com/hub_fsm.ex
@lib/agent_com/hub_fsm/predicates.ex
@test/agent_com/hub_fsm/predicates_test.exs
</context>

<tasks>

<task type="auto">
  <name>Task 1: WebhookVerifier and WebhookHistory unit tests</name>
  <files>test/agent_com/webhook_verifier_test.exs, test/agent_com/webhook_history_test.exs</files>
  <action>
1. Create `test/agent_com/webhook_verifier_test.exs`:
   - Use `async: false` (reads from Config GenServer)
   - Setup: Store a known webhook secret in Config via `AgentCom.Config.put(:github_webhook_secret, "test-webhook-secret-key")`
   - Helper function to compute valid HMAC: `:crypto.mac(:hmac, :sha256, secret, body) |> Base.encode16(case: :lower)`
   - Helper to build a fake conn with raw_body assign and x-hub-signature-256 header

   Test cases:
   - **valid signature**: Build conn with correct HMAC, verify returns `{:ok, conn}`
   - **invalid signature**: Build conn with wrong HMAC hex, verify returns `{:error, :invalid_signature}`
   - **missing header**: Build conn without x-hub-signature-256, verify returns `{:error, :missing_signature}`
   - **no secret configured**: Clear the webhook secret from Config, verify returns `{:error, :no_secret_configured}`
   - **empty body**: Verify works correctly with empty string body
   - **malformed header** (no sha256= prefix): Returns `{:error, :missing_signature}`

2. Create `test/agent_com/webhook_history_test.exs`:
   - Use `async: false` (shared ETS table)
   - Setup: call `WebhookHistory.init_table()` and `WebhookHistory.clear()` in setup

   Test cases:
   - **record and list**: Record an event, list it back, verify fields present
   - **ordering**: Record 3 events with small delays, verify list returns newest first
   - **limit**: Record 5 events, list with limit: 2, verify only 2 returned
   - **cap at 100**: Record 105 events, verify only 100 exist in table (`list(limit: 200)` returns 100)
   - **clear**: Record events, clear, verify empty list
  </action>
  <verify>
Run `mix test test/agent_com/webhook_verifier_test.exs test/agent_com/webhook_history_test.exs --trace` and confirm all tests pass.
  </verify>
  <done>
WebhookVerifier correctly validates HMAC-SHA256 signatures and handles all error cases. WebhookHistory stores, retrieves, and caps events at 100.
  </done>
</task>

<task type="auto">
  <name>Task 2: Webhook endpoint integration tests and Predicates :improving tests</name>
  <files>test/agent_com/webhook_endpoint_test.exs, test/agent_com/hub_fsm/predicates_test.exs</files>
  <action>
1. Create `test/agent_com/webhook_endpoint_test.exs`:
   - Use `async: false` (uses GenServers: Config, RepoRegistry, HubFSM)
   - Follow existing endpoint test patterns from the codebase (use `Plug.Test.conn/3` to build test conns)
   - Setup: Configure webhook secret, register an active repo in RepoRegistry, ensure HubFSM is in :resting state

   Helper: Build a webhook request conn with proper headers and HMAC signature:
   ```elixir
   defp webhook_conn(event_type, payload, secret) do
     body = Jason.encode!(payload)
     hmac = :crypto.mac(:hmac, :sha256, secret, body) |> Base.encode16(case: :lower)

     Plug.Test.conn(:post, "/api/webhooks/github", body)
     |> Plug.Conn.put_req_header("content-type", "application/json")
     |> Plug.Conn.put_req_header("x-github-event", event_type)
     |> Plug.Conn.put_req_header("x-hub-signature-256", "sha256=#{hmac}")
     |> Plug.Conn.put_req_header("x-github-delivery", "test-delivery-#{System.unique_integer()}")
   end
   ```

   IMPORTANT: Since the Endpoint uses CacheBodyReader via Plug.Parsers, the test conn must go through the full Plug pipeline. Use `AgentCom.Endpoint.call(conn, AgentCom.Endpoint.init([]))` to process the conn through the full router.

   Test cases:
   - **push event on active repo**: Send push payload with matching repo, verify 200 response with "accepted", verify HubFSM transitioned to :improving (or already active)
   - **push event on non-active repo**: Send push payload with unknown repo, verify 200 with "ignored"
   - **PR merge event on active repo**: Send pull_request payload with action: "closed", merged: true, matching repo. Verify 200 "accepted"
   - **PR non-merge event**: Send pull_request with action: "opened". Verify 200 "ignored"
   - **invalid signature**: Send request with wrong HMAC. Verify 401 response
   - **missing signature header**: Send request without x-hub-signature-256. Verify 401
   - **webhook history endpoint**: After sending events, GET /api/webhooks/github/history returns recorded events
   - **webhook secret config**: PUT /api/config/webhook-secret with auth sets the secret

   GitHub payload structures (from research):
   - Push: `%{"ref" => "refs/heads/main", "repository" => %{"full_name" => "owner/repo"}, "head_commit" => %{"id" => "abc123"}}`
   - PR merge: `%{"action" => "closed", "pull_request" => %{"merged" => true, "number" => 42, "base" => %{"ref" => "main"}}, "repository" => %{"full_name" => "owner/repo"}}`

2. Extend `test/agent_com/hub_fsm/predicates_test.exs`:
   - Add test cases for the `:improving` state (check if test file already has them -- if so, skip):
   - **improving stays when budget ok**: `evaluate(:improving, %{...budget_exhausted: false...})` returns `:stay`
   - **improving -> resting on budget exhausted**: `evaluate(:improving, %{budget_exhausted: true})` returns `{:transition, :resting, "budget exhausted"}`
   - These tests should be `async: true` since Predicates are pure functions
  </action>
  <verify>
Run `mix test test/agent_com/webhook_endpoint_test.exs test/agent_com/hub_fsm/predicates_test.exs --trace` and confirm all tests pass.
Run `mix test` to confirm no existing tests broken.
  </verify>
  <done>
Full test coverage for webhook endpoint (push, PR merge, non-active repo, invalid signature), webhook history, webhook secret config, and :improving state predicates. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `mix test test/agent_com/webhook_verifier_test.exs` -- all pass
2. `mix test test/agent_com/webhook_history_test.exs` -- all pass
3. `mix test test/agent_com/webhook_endpoint_test.exs` -- all pass
4. `mix test test/agent_com/hub_fsm/predicates_test.exs` -- all pass (including new :improving tests)
5. `mix test` -- full suite passes, no regressions
</verification>

<success_criteria>
- All HMAC verification edge cases tested (valid, invalid, missing, no secret)
- Webhook endpoint tested with push and PR merge payloads
- Non-active repo events correctly ignored
- WebhookHistory cap and ordering tested
- Predicates :improving state transitions tested
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/31-hub-event-wiring/31-03-SUMMARY.md`
</output>

---
phase: 10-dets-backup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/agent_com/dets_backup.ex
  - test/dets_backup_test.exs
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "After triggering a manual backup, the dashboard DETS panel updates automatically without a manual page refresh"
    - "DashboardSocket does not crash when encoding snapshot data containing backup results"
    - "health_metrics/0 returns only Jason-serializable data structures (no Elixir tuples)"
  artifacts:
    - path: "lib/agent_com/dets_backup.ex"
      provides: "Normalized last_backup_results in health_metrics handler"
      contains: "defp normalize_backup_results"
    - path: "test/dets_backup_test.exs"
      provides: "Test proving health_metrics returns Jason-serializable data"
      contains: "Jason.encode"
  key_links:
    - from: "lib/agent_com/dets_backup.ex"
      to: "lib/agent_com/dashboard_state.ex"
      via: "health_metrics/0 call in snapshot"
      pattern: "DetsBackup\\.health_metrics"
    - from: "lib/agent_com/dashboard_state.ex"
      to: "lib/agent_com/dashboard_socket.ex"
      via: "Jason.encode! of snapshot"
      pattern: "Jason\\.encode!"
---

<objective>
Fix DashboardSocket crash caused by Jason.Encoder not implemented for Tuple when encoding health_metrics snapshot data.

Purpose: Close the single UAT gap (Test 4) -- backup_complete events currently crash the WebSocket snapshot path because health_metrics/0 returns raw tagged tuples ({:ok, %{...}} / {:error, %{...}}) in last_backup_results, which Jason cannot serialize.

Output: Patched DetsBackup.health_metrics/0 that normalizes tagged tuples to plain maps before returning, plus a regression test proving the output is Jason-serializable.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-dets-backup/10-02-SUMMARY.md
@.planning/debug/dashboard-socket-jason-tuple-crash.md

# Source files
@lib/agent_com/dets_backup.ex
@test/dets_backup_test.exs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Normalize tagged tuples in health_metrics handler</name>
  <files>lib/agent_com/dets_backup.ex</files>
  <action>
In lib/agent_com/dets_backup.ex, add a private function `normalize_backup_results/1` that converts the raw tagged tuple list into plain maps Jason can serialize.

The function should:
1. Accept `nil` (no backup yet) and return `nil`
2. Accept a list of `{:ok, %{table: atom, path: string, size: integer}}` / `{:error, %{table: atom, reason: term}}` tuples
3. Convert each tuple to a plain map:
   - `{:ok, info}` becomes `%{status: "ok", table: to_string(info.table), path: info.path, size: info.size}`
   - `{:error, info}` becomes `%{status: "error", table: to_string(info.table), reason: inspect(info.reason)}`

Then in handle_call(:health_metrics, ...) at line 84-93, pipe `state.last_backup_results` through `normalize_backup_results/1` before including it in the return map. Change line 90 from:

```elixir
last_backup_results: state.last_backup_results
```

to:

```elixir
last_backup_results: normalize_backup_results(state.last_backup_results)
```

IMPORTANT: Do NOT convert atoms to strings in table_metrics/1. Only normalize `last_backup_results` -- that is the sole source of the Jason crash. The `tables` list returned by table_metrics/1 contains atoms for `:table` and `:status` keys, but these are Jason-serializable (Jason encodes atoms as strings automatically). The ONLY non-serializable data is the tagged tuples in `last_backup_results`.

The fix is ONLY:
1. Add `normalize_backup_results/1` private function
2. Apply it to `state.last_backup_results` in the health_metrics handler

Do NOT change table_metrics/1 or any other function.
  </action>
  <verify>
Run `mix compile --warnings-as-errors` -- must compile with no warnings.
Run `mix test test/dets_backup_test.exs` -- existing tests must still pass.
  </verify>
  <done>health_metrics/0 returns last_backup_results as a list of plain maps (or nil) instead of tagged tuples. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add Jason-serializability regression test</name>
  <files>test/dets_backup_test.exs</files>
  <action>
Add a test to test/dets_backup_test.exs that proves health_metrics output is fully Jason-serializable.

The test should:
1. Call `DetsBackup.backup_all()` to populate last_backup_results in GenServer state
2. Call `DetsBackup.health_metrics()` to get the metrics map
3. Assert `Jason.encode!(metrics)` does NOT raise (this is the exact operation that was crashing DashboardSocket)
4. Decode the JSON back and assert `last_backup_results` is a list (not nil, since we just ran a backup)
5. Assert each entry in last_backup_results has a "status" key that is either "ok" or "error"

Name the test something like: `"health_metrics returns Jason-serializable data after backup"`

Place it in the existing describe block alongside the other health_metrics and backup tests.
  </action>
  <verify>
Run `mix test test/dets_backup_test.exs` -- all tests pass including the new one.
Run `mix test` -- full suite passes.
  </verify>
  <done>A regression test exists that calls Jason.encode! on health_metrics() output after a backup, proving the DashboardSocket crash cannot recur.</done>
</task>

</tasks>

<verification>
1. `mix compile --warnings-as-errors` passes
2. `mix test test/dets_backup_test.exs` passes (including new regression test)
3. `mix test` full suite passes
4. Manual verification: Start the application, trigger a backup via `curl -X POST http://localhost:4000/api/admin/backup`, then check that the dashboard WebSocket does NOT crash (connect to ws://localhost:4000/ws/dashboard and send `{"type":"request_snapshot"}` -- should receive valid JSON response with dets_health.last_backup_results as a list of maps)
</verification>

<success_criteria>
- DashboardSocket no longer crashes with Protocol.UndefinedError when encoding snapshot after a backup
- health_metrics/0 returns only plain maps and primitives in last_backup_results (no tagged tuples)
- Existing tests continue to pass
- New regression test proves Jason-serializability of health_metrics output
</success_criteria>

<output>
After completion, create `.planning/phases/10-dets-backup/10-03-SUMMARY.md`
</output>

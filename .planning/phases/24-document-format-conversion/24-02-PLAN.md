---
phase: 24-document-format-conversion
plan: 02
type: tdd
wave: 2
depends_on: ["24-01"]
files_modified:
  - test/agent_com/xml/xml_test.exs
  - test/agent_com/xml/parser_test.exs
  - test/agent_com/xml/schemas/goal_test.exs
  - test/agent_com/xml/schemas/scan_result_test.exs
  - test/agent_com/xml/schemas/schemas_test.exs
autonomous: true

must_haves:
  truths:
    - "Encoding a schema struct produces valid XML with correct root element"
    - "Decoding valid XML produces a struct with all fields populated"
    - "Encode then decode round-trip preserves all field values including lists"
    - "Decoding invalid XML returns an error tuple, not a crash"
    - "Required field validation in new/1 returns errors for missing fields"
  artifacts:
    - path: "test/agent_com/xml/xml_test.exs"
      provides: "Encode/decode integration tests for all 5 schema types"
      min_lines: 50
    - path: "test/agent_com/xml/parser_test.exs"
      provides: "SAX parser unit tests for edge cases"
      min_lines: 30
    - path: "test/agent_com/xml/schemas/goal_test.exs"
      provides: "Goal struct validation and encoding tests"
      min_lines: 30
  key_links:
    - from: "test/agent_com/xml/xml_test.exs"
      to: "lib/agent_com/xml/xml.ex"
      via: "calls AgentCom.XML.encode/1 and decode/2"
      pattern: "AgentCom\\.XML\\.(encode|decode)"
    - from: "test/agent_com/xml/schemas/goal_test.exs"
      to: "lib/agent_com/xml/schemas/goal.ex"
      via: "constructs Goal structs and validates"
      pattern: "AgentCom\\.XML\\.Schemas\\.Goal"
---

<objective>
Test-driven verification of the XML encode/decode subsystem created in Plan 01. Write tests that prove round-trip correctness for all 5 schema types, validate error handling for malformed XML and missing required fields, and confirm list fields (success_criteria, related_files, transition_history) survive serialization.

Purpose: The XML schemas are foundational -- Phases 27, 29, 30, 32, and 33 all depend on correct encoding/decoding. Tests catch serialization bugs before they cascade into data loss or silent corruption in the autonomous loop.

Output: Comprehensive test suite for the AgentCom.XML subsystem with all tests passing.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-document-format-conversion/24-01-SUMMARY.md
@lib/agent_com/xml/xml.ex
@lib/agent_com/xml/parser.ex
@lib/agent_com/xml/schemas/goal.ex
@test/test_helper.exs
</context>

<feature>
  <name>XML Encode/Decode Round-Trip Correctness</name>
  <files>
    test/agent_com/xml/xml_test.exs
    test/agent_com/xml/parser_test.exs
    test/agent_com/xml/schemas/goal_test.exs
    test/agent_com/xml/schemas/scan_result_test.exs
    test/agent_com/xml/schemas/schemas_test.exs
  </files>
  <behavior>
    Tests cover three dimensions:

    1. **Round-trip correctness** (xml_test.exs):
       - For each of the 5 schema types: create struct -> encode -> decode -> assert fields match
       - Goal with success_criteria list: encode -> decode -> list preserved with correct values
       - Proposal with related_files list: encode -> decode -> list preserved
       - FsmSnapshot with transition_history: encode -> decode -> history preserved
       - Struct with nil optional fields: encode -> decode -> nil fields remain nil
       - Struct with all fields populated: no data loss

    2. **Error handling** (xml_test.exs + parser_test.exs):
       - decode/2 with empty string returns {:error, _}
       - decode/2 with malformed XML returns {:error, _}
       - decode/2 with wrong schema type returns {:error, _} or handles gracefully
       - encode/1 with non-struct argument returns {:error, _}
       - new/1 with missing required fields returns {:error, _}

    3. **Schema validation** (schemas/goal_test.exs, scan_result_test.exs, schemas_test.exs):
       - Goal.new/1 requires id and title
       - ScanResult.new/1 requires id, repo, description
       - Each schema's new/1 accepts keyword list and map forms
       - Default values applied correctly (priority defaults to "normal")
       - schemas_test.exs: all 5 types listed in AgentCom.XML.schema_types/0

    Cases:
      encode(%Goal{id: "g1", title: "Test"}) -> {:ok, "<goal ...>...</goal>"}
      decode("<goal id=\"g1\"><title>Test</title></goal>", :goal) -> {:ok, %Goal{id: "g1", title: "Test"}}
      encode(%Goal{}) -> {:error, _} (missing required fields) OR produces XML with empty attributes
      decode("not xml", :goal) -> {:error, _}
      decode("<goal id=\"g1\"><title>T</title><success-criteria><criterion>A</criterion><criterion>B</criterion></success-criteria></goal>", :goal) -> {:ok, %Goal{success_criteria: ["A", "B"]}}
  </behavior>
  <implementation>
    TDD RED-GREEN-REFACTOR cycle:

    RED: Create test files with all test cases described above. Run `mix test test/agent_com/xml/` -- tests should fail if Plan 01 left any gaps (missing error handling, list serialization bugs, etc.).

    GREEN: Fix any failures found in the source modules (xml.ex, parser.ex, schema files). Make minimal changes to pass each test.

    REFACTOR: Clean up any duplication in test setup (extract shared test helpers if needed). Ensure test descriptions are clear.

    Test file structure:
    - `test/agent_com/xml/xml_test.exs` -- Integration tests for AgentCom.XML encode/decode
    - `test/agent_com/xml/parser_test.exs` -- Unit tests for Parser SAX handler edge cases
    - `test/agent_com/xml/schemas/goal_test.exs` -- Goal struct tests (most complex due to success_criteria list)
    - `test/agent_com/xml/schemas/scan_result_test.exs` -- ScanResult struct tests
    - `test/agent_com/xml/schemas/schemas_test.exs` -- Cross-schema tests (schema_types/0, all types encode/decode)

    Use ExUnit with `async: true` where possible. Do NOT mock Saxy -- test against real encode/decode.
  </implementation>
</feature>

<verification>
1. `mix test test/agent_com/xml/` passes with all tests green
2. At least 15 test cases across the 5 test files
3. Round-trip tests exist for all 5 schema types
4. Error handling tests exist for malformed input
5. List field tests exist for Goal (success_criteria), Proposal (related_files), FsmSnapshot (transition_history)
</verification>

<success_criteria>
- All XML tests pass (`mix test test/agent_com/xml/` green)
- Round-trip encode/decode proven correct for all 5 schema types
- List fields survive serialization (success_criteria, related_files, transition_history)
- Error tuples returned for invalid input (not crashes)
- Required field validation tested for Goal and ScanResult
- No regressions in existing test suite (`mix test` all green)
</success_criteria>

<output>
After completion, create `.planning/phases/24-document-format-conversion/24-02-SUMMARY.md`
</output>

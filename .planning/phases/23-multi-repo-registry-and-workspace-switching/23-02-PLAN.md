---
phase: 23-multi-repo-registry-and-workspace-switching
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - sidecar/lib/workspace-manager.js
  - sidecar/index.js
autonomous: true

must_haves:
  truths:
    - "Sidecar resolves a per-task workspace directory from the task's repo URL"
    - "First task for a new repo triggers a git clone into the workspace cache"
    - "Subsequent tasks for the same repo update the workspace via git fetch + reset"
    - "Tasks with no repo field use the original config.repo_dir unchanged"
    - "The global _config object is never mutated -- a shallow copy with overridden repo_dir is passed to execution"
  artifacts:
    - path: "sidecar/lib/workspace-manager.js"
      provides: "WorkspaceManager class with ensureWorkspace(repoUrl)"
      contains: "class WorkspaceManager"
    - path: "sidecar/index.js"
      provides: "Workspace resolution before task dispatch"
      contains: "workspace"
  key_links:
    - from: "sidecar/index.js"
      to: "sidecar/lib/workspace-manager.js"
      via: "require and ensureWorkspace call in executeTask"
      pattern: "ensureWorkspace"
    - from: "sidecar/index.js"
      to: "sidecar/lib/execution/verification-loop.js"
      via: "effectiveConfig with overridden repo_dir passed to executeWithVerification"
      pattern: "effectiveConfig"
---

<objective>
Build the sidecar workspace manager and integrate it into the task execution pipeline so tasks targeting different repos execute in isolated workspace directories.

Purpose: Enable sidecars to work on multiple repos without manual reconfiguration. Each repo gets its own cloned workspace directory, and the per-task `repo_dir` override ensures all downstream code (shell executor, verification, git workflow) uses the correct directory.

Output: WorkspaceManager module and index.js integration that resolves workspace paths before task dispatch.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-multi-repo-registry-and-workspace-switching/23-RESEARCH.md

# Key reference files:
@sidecar/index.js
@sidecar/lib/execution/shell-executor.js
@sidecar/lib/execution/verification-loop.js
@sidecar/verification.js
@sidecar/agentcom-git.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: WorkspaceManager module</name>
  <files>sidecar/lib/workspace-manager.js</files>
  <action>
Create `sidecar/lib/workspace-manager.js` with a `WorkspaceManager` class.

**Constructor:**
- Takes `baseDir` (e.g., `~/.agentcom/<agent_name>/workspaces/`)
- Creates the directory recursively with `fs.mkdirSync(baseDir, { recursive: true })`

**`ensureWorkspace(repoUrl)` method:**
- Convert URL to filesystem-safe slug via `_urlToSlug(url)`
- Compute workspace dir: `path.join(this.baseDir, slug)`
- Check if `.git` directory exists in workspace dir
- If exists: run `git fetch origin && git reset --hard origin/main` with cwd=wsDir, timeout=120000ms, windowsHide=true. Log success. On error, log warning but continue with stale workspace (don't fail the task).
- If not exists: create directory, run `git clone "<repoUrl>" "<wsDir>"` with timeout=300000ms (5 min for large repos), windowsHide=true. Log cloning start and completion.
- Return the absolute workspace directory path.

**`_urlToSlug(url)` private method:**
- Strip `https?://` protocol prefix
- Strip `git@host:` SSH prefix
- Strip `.git` suffix
- Replace `/` with `-`
- Replace any non-alphanumeric (except `-` and `_`) with `-`
- Return the slug string

Use `require('child_process').execSync` for git operations (matching existing patterns in agentcom-git.js).
Use `require('./log').log` for structured logging (matching existing sidecar log pattern).

Export: `{ WorkspaceManager }`
  </action>
  <verify>
`node -e "const { WorkspaceManager } = require('./sidecar/lib/workspace-manager'); console.log('OK')"` loads without error.
  </verify>
  <done>
WorkspaceManager class exists with ensureWorkspace that clones on first use, pulls on subsequent use, and returns absolute workspace path. Handles git errors gracefully without failing the task.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate workspace manager into index.js executeTask</name>
  <files>sidecar/index.js</files>
  <action>
**1. Initialize WorkspaceManager at module level (near other requires at top):**

After the existing config loading section (around line 30-65), add workspace manager initialization:
```javascript
const { WorkspaceManager } = require('./lib/workspace-manager');
const os = require('os');
```

After config is loaded and validated (after `loadOrCreateConfig`), initialize the workspace manager:
```javascript
const agentName = _config.agent_id || 'unknown';
const wsBaseDir = path.join(os.homedir(), '.agentcom', agentName, 'workspaces');
let _workspaceManager = null;
try {
  _workspaceManager = new WorkspaceManager(wsBaseDir);
} catch (err) {
  log('warning', 'workspace_manager_init_failed', { error: err.message });
}
```

Note: `os` may already be required -- check before adding duplicate require.

**2. Modify `executeTask(task)` method (around line 638):**

Before the existing `executeWithVerification` call, add workspace resolution. Create a shallow copy of `_config` with the resolved repo_dir:

```javascript
async executeTask(task) {
  const { executeWithVerification } = require('./lib/execution/verification-loop');
  const { ProgressEmitter } = require('./lib/execution/progress-emitter');

  // Resolve per-task workspace (Phase 23: multi-repo support)
  let effectiveConfig = { ..._config };
  if (task.repo && _workspaceManager) {
    try {
      const wsDir = _workspaceManager.ensureWorkspace(task.repo);
      effectiveConfig.repo_dir = wsDir;
      log('info', 'workspace_resolved', {
        task_id: task.task_id,
        repo: task.repo,
        workspace: wsDir
      });
    } catch (err) {
      log('error', 'workspace_resolve_failed', {
        task_id: task.task_id,
        repo: task.repo,
        error: err.message
      });
      this.sendTaskFailed(task.task_id,
        `Workspace setup failed for ${task.repo}: ${err.message}`);
      _queue.active = null;
      saveQueue(QUEUE_PATH, _queue);
      return;
    }
  }

  // ... rest of executeTask, but pass effectiveConfig instead of _config ...
```

Change the `executeWithVerification` call from:
```javascript
const result = await executeWithVerification(task, _config, (event) => emitter.emit(event));
```
to:
```javascript
const result = await executeWithVerification(task, effectiveConfig, (event) => emitter.emit(event));
```

**3. Also update the git workflow section in handleTaskAssign (around line 597-618):**

The git `start-task` call before wakeAgent also uses `_config.repo_dir`. For the Phase 20 path (executeTask), git start-task should use the effective config. Since executeTask handles its own workspace, and the git start-task in handleTaskAssign only runs for the legacy wakeAgent path, no change is needed there. The legacy path continues using `_config.repo_dir` as before.

**CRITICAL: Never mutate `_config` directly.** Always use `{ ..._config }` spread to create a shallow copy.
  </action>
  <verify>
`node -e "require('./sidecar/index.js')"` does not throw on load (may warn about missing config, which is fine). Verify that `executeTask` creates `effectiveConfig` and passes it to `executeWithVerification`.
  </verify>
  <done>
WorkspaceManager initializes on sidecar startup. executeTask resolves workspace per task.repo, creates effectiveConfig with overridden repo_dir, and passes it to executeWithVerification. Tasks without repo field continue using original config.repo_dir. Global _config is never mutated.
  </done>
</task>

</tasks>

<verification>
1. `node -e "const { WorkspaceManager } = require('./sidecar/lib/workspace-manager'); console.log('loaded')"` -- loads without error
2. WorkspaceManager._urlToSlug converts "https://github.com/notno/AgentCom.git" to "github.com-notno-AgentCom"
3. index.js loads without error
4. executeTask method creates effectiveConfig (not mutating _config)
5. executeWithVerification receives effectiveConfig with overridden repo_dir
</verification>

<success_criteria>
- WorkspaceManager module exists and exports class
- ensureWorkspace clones on first use, pulls on subsequent
- index.js integrates workspace resolution before dispatch
- _config never mutated (shallow copy pattern)
- Graceful error handling (workspace failure reports task failed, does not crash sidecar)
</success_criteria>

<output>
After completion, create `.planning/phases/23-multi-repo-registry-and-workspace-switching/23-02-SUMMARY.md`
</output>

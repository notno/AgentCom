---
phase: 16-operations-docs
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - mix.exs
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Architecture page renders 3 Mermaid diagrams as visual SVG flowcharts in browser"
    - "Mermaid rendering works without any local JS build step -- CDN-loaded"
    - "epub format is unaffected (returns empty string)"
  artifacts:
    - path: "mix.exs"
      provides: "before_closing_body_tag hook with Mermaid CDN injection"
      contains: "before_closing_body_tag"
  key_links:
    - from: "mix.exs docs() before_closing_body_tag"
      to: "doc/architecture.html"
      via: "mix docs generation injects script tag before closing body"
      pattern: "mermaid"
---

<objective>
Fix Mermaid diagram rendering in ExDoc-generated documentation.

Purpose: UAT test 2 found that the 3 Mermaid diagrams in docs/architecture.md display as raw code text instead of visual SVG diagrams. ExDoc v0.40.1 correctly converts ```mermaid blocks to `<pre><code class="mermaid">` HTML but does not bundle Mermaid.js. A `before_closing_body_tag` hook must inject the Mermaid CDN script.

Output: mix.exs updated so `mix docs` produces architecture.html with rendered Mermaid SVG diagrams.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/mermaid-diagrams-raw-text.md
@mix.exs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Mermaid.js CDN injection to ExDoc docs config</name>
  <files>mix.exs</files>
  <action>
In the `docs()` function in mix.exs (currently lines 37-102), add a `before_closing_body_tag` key to the returned keyword list.

The value must be a function that takes a format atom and returns an HTML string:

For `:html` format, return a string containing:
1. A script tag loading Mermaid v11 from jsDelivr CDN: `https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js`
2. An inline script that:
   - Calls `mermaid.initialize({ startOnLoad: false, theme: "default" })`
   - Selects all `pre > code.mermaid` elements via `document.querySelectorAll`
   - For each element: reads its `.textContent`, creates a sibling div, calls `mermaid.render()` to produce SVG, inserts the SVG div, and removes the original `<pre>` block
   - Wraps the render loop in a `document.addEventListener("DOMContentLoaded", ...)` or equivalent so it runs after DOM is ready
   - Uses async/await since mermaid.render returns a Promise in v11

For `:epub` format (and any other format), return an empty string `""`.

Implementation pattern (ExDoc before_closing_body_tag expects a function/1):

```elixir
before_closing_body_tag: fn
  :html ->
    """
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        mermaid.initialize({ startOnLoad: false, theme: "default" });
        var i = 0;
        var codeBlocks = document.querySelectorAll("pre code.mermaid");
        codeBlocks.forEach(function (codeBlock) {
          var pre = codeBlock.parentElement;
          var graphDefinition = codeBlock.textContent;
          var containerId = "mermaid-graph-" + i;
          var div = document.createElement("div");
          div.id = containerId;
          pre.parentElement.insertBefore(div, pre);
          try {
            mermaid.render(containerId, graphDefinition).then(function (result) {
              div.innerHTML = result.svg;
              pre.style.display = "none";
            });
          } catch (e) {
            console.error("Mermaid rendering failed for block " + i, e);
          }
          i++;
        });
      });
    </script>
    """
  _ ->
    ""
end
```

Place the `before_closing_body_tag` key after the existing `groups_for_modules` key in the docs keyword list. Maintain consistent formatting with the rest of mix.exs.

IMPORTANT: Use `fn` with pattern-matching clauses (multi-clause anonymous function), NOT `case`. ExDoc calls this function with the output format atom.
  </action>
  <verify>
Run `mix docs` and confirm it completes without errors. Then verify the generated HTML contains the mermaid script injection:

```bash
mix docs
```

Check that the mermaid script tag appears in the generated architecture.html:

```bash
grep -c "mermaid" doc/architecture.html
```

The grep count should be significantly higher than before (now includes the script tags plus the original code blocks). Specifically look for the CDN script tag:

```bash
grep "cdn.jsdelivr.net/npm/mermaid" doc/architecture.html
```

This should return a match confirming the script injection.
  </verify>
  <done>
`mix docs` generates doc/architecture.html containing:
1. The Mermaid v11 CDN script tag from jsDelivr
2. The initialization and rendering inline script
3. All 3 original mermaid code blocks still present in the HTML (rendered client-side into SVG by the injected script)
  </done>
</task>

</tasks>

<verification>
1. `mix docs` completes without errors or warnings
2. `doc/architecture.html` contains `cdn.jsdelivr.net/npm/mermaid` script tag
3. `doc/architecture.html` contains `mermaid.initialize` in inline script
4. Opening `doc/architecture.html` in a browser shows 3 visual SVG diagrams (supervision tree, task lifecycle, sidecar-hub communication) instead of raw code text
</verification>

<success_criteria>
The 3 Mermaid diagrams in docs/architecture.md render as visual SVG flowcharts when viewing the ExDoc-generated doc/architecture.html in a browser. No build step required -- Mermaid loads from CDN at page view time.
</success_criteria>

<output>
After completion, create `.planning/phases/16-operations-docs/16-04-SUMMARY.md`
</output>

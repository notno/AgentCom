---
phase: 30-goal-decomposition-and-inner-loop
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/agent_com/goal_orchestrator/file_tree.ex
  - lib/agent_com/goal_orchestrator/dag_validator.ex
  - test/agent_com/goal_orchestrator/file_tree_test.exs
  - test/agent_com/goal_orchestrator/dag_validator_test.exs
autonomous: true

must_haves:
  truths:
    - "FileTree.gather/1 returns a sorted list of file paths from a directory using cross-platform Elixir functions"
    - "FileTree.validate_references/2 identifies task descriptions referencing files not in the file tree"
    - "DagValidator.validate/1 rejects cyclic dependency graphs and invalid index references"
    - "DagValidator.topological_order/1 returns a valid execution ordering for DAG submission"
  artifacts:
    - path: "lib/agent_com/goal_orchestrator/file_tree.ex"
      provides: "Cross-platform file tree gathering and reference validation"
      exports: ["gather/1", "validate_references/2"]
    - path: "lib/agent_com/goal_orchestrator/dag_validator.ex"
      provides: "DAG cycle detection, index validation, topological ordering"
      exports: ["validate/1", "topological_order/1"]
    - path: "test/agent_com/goal_orchestrator/file_tree_test.exs"
      provides: "FileTree unit tests"
    - path: "test/agent_com/goal_orchestrator/dag_validator_test.exs"
      provides: "DagValidator unit tests"
  key_links:
    - from: "lib/agent_com/goal_orchestrator/file_tree.ex"
      to: "Path.wildcard/1, File.dir?/1"
      via: "Elixir stdlib for cross-platform file listing"
    - from: "lib/agent_com/goal_orchestrator/dag_validator.ex"
      to: "decomposed task list with 1-based depends_on indices"
      via: "Kahn's algorithm for topological sort"
---

<objective>
Build the two pure utility modules that GoalOrchestrator depends on: FileTree for cross-platform repository file listing with reference validation, and DagValidator for dependency graph validation with topological ordering.

Purpose: These modules provide the grounding and structural validation layers needed before the orchestrator can decompose goals and submit tasks. FileTree ensures the LLM decomposition prompt references only real files. DagValidator ensures the LLM-produced dependency graph is a valid DAG before submission to TaskQueue.

Output: Two tested library modules under `lib/agent_com/goal_orchestrator/`.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-goal-decomposition-and-inner-loop/30-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement FileTree module</name>
  <files>lib/agent_com/goal_orchestrator/file_tree.ex, test/agent_com/goal_orchestrator/file_tree_test.exs</files>
  <action>
Create `AgentCom.GoalOrchestrator.FileTree` as a pure library module (no GenServer).

**`gather/1`** -- Takes a directory path (string), returns `{:ok, [String.t()]}` or `{:error, term()}`.
- Use `Path.wildcard(Path.join(repo_path, "**/*"))` to recursively list all files. This is cross-platform (works on Windows without shelling out to `ls` or `find`).
- Filter out directories using `File.regular?/1` -- only return regular files.
- Strip the `repo_path` prefix from results so paths are relative (e.g., `lib/agent_com/foo.ex` not `/full/path/lib/agent_com/foo.ex`).
- Sort the resulting list alphabetically.
- Exclude hidden directories (paths containing `/.` or `\\.`) and common noise directories (`_build`, `deps`, `node_modules`, `.git`, `.elixir_ls`).
- Return `{:error, {:not_a_directory, path}}` if the path doesn't exist or isn't a directory.

**`validate_references/2`** -- Takes a list of task maps (each with `:description` field) and a list of file paths (from `gather/1`). Returns `{valid_tasks, invalid_tasks}` where `invalid_tasks` is a list of `{task, missing_files}` tuples.
- Extract file references from each task's description using a regex that matches common file path patterns: paths starting with `lib/`, `test/`, `sidecar/`, `config/`, `priv/` followed by path segments and a file extension.
- Check each extracted path against the file tree list (use MapSet for O(1) lookup).
- Tasks with no file references are considered valid (they may be conceptual tasks).

**Tests:**
- `gather/1` on a temp directory with nested files returns correct relative paths.
- `gather/1` excludes `_build`, `.git`, `deps` directories.
- `gather/1` on non-existent path returns error tuple.
- `validate_references/2` identifies missing files correctly.
- `validate_references/2` passes tasks with no file references.
- `validate_references/2` handles mixed valid/invalid tasks.

Use `async: true` for tests (pure functions, no shared state). Use `System.tmp_dir!/0` and `File.mkdir_p!/1` for temp directories in tests.
  </action>
  <verify>Run `mix test test/agent_com/goal_orchestrator/file_tree_test.exs` -- all tests pass.</verify>
  <done>FileTree.gather/1 returns relative file paths using cross-platform Path.wildcard, excludes noise directories, and validates input. FileTree.validate_references/2 correctly identifies task descriptions referencing non-existent files.</done>
</task>

<task type="auto">
  <name>Task 2: Implement DagValidator module</name>
  <files>lib/agent_com/goal_orchestrator/dag_validator.ex, test/agent_com/goal_orchestrator/dag_validator_test.exs</files>
  <action>
Create `AgentCom.GoalOrchestrator.DagValidator` as a pure library module.

**Input format:** A list of task maps where each has a `:depends_on` field containing a list of 1-based integer indices. E.g., `[%{depends_on: []}, %{depends_on: [1]}, %{depends_on: [1, 2]}]`.

**`validate/1`** -- Takes the task list, returns `:ok` or `{:error, reason}`.
- Validate all dependency indices are within range: 1 to N where N is the list length.
- Validate no task depends on itself or a later-indexed task (forward references only -- task 3 can depend on task 1 or 2 but not 3, 4, or 5). This constraint ensures the LLM produced a valid ordering.
- Validate no cycles using Kahn's algorithm for topological sort. If the sorted output has fewer nodes than the input, a cycle exists.
- Error tuples: `{:error, {:invalid_indices, [{task_index, bad_dep_index}]}}`, `{:error, :cycle_detected}`, `{:error, :empty_tasks}`.

**`topological_order/1`** -- Takes the task list, returns `{:ok, [integer()]}` -- a list of 1-based indices in valid execution order (independent tasks first). Uses Kahn's algorithm internally.
- This ordering is used by the orchestrator to submit tasks to TaskQueue in the right order (so dependency IDs exist at submit time).

**`resolve_indices_to_ids/2`** -- Takes `[{1_based_index, task_id}]` mapping and a task list, returns updated task list where each task's `:depends_on` contains actual task IDs instead of indices.

**Tests:**
- `validate/1` accepts valid linear chain: task 1 -> task 2 -> task 3.
- `validate/1` accepts valid diamond: tasks 2,3 depend on 1, task 4 depends on 2,3.
- `validate/1` accepts fully independent tasks (all empty depends_on).
- `validate/1` rejects cycle (task 1 depends on 2, task 2 depends on 1 -- though this also violates forward-only rule).
- `validate/1` rejects out-of-range index.
- `validate/1` rejects self-dependency.
- `validate/1` rejects empty task list.
- `topological_order/1` returns independent tasks before dependent ones.
- `resolve_indices_to_ids/2` correctly maps indices to IDs.

Use `async: true`.
  </action>
  <verify>Run `mix test test/agent_com/goal_orchestrator/dag_validator_test.exs` -- all tests pass.</verify>
  <done>DagValidator.validate/1 correctly detects invalid dependency references, cycles, and forward references. DagValidator.topological_order/1 returns a valid execution ordering. DagValidator.resolve_indices_to_ids/2 maps 1-based indices to actual task IDs.</done>
</task>

</tasks>

<verification>
1. `mix test test/agent_com/goal_orchestrator/` -- all tests pass
2. `mix compile --warnings-as-errors` -- no warnings
3. Both modules are pure functions with no GenServer or PubSub dependencies
</verification>

<success_criteria>
- FileTree.gather/1 works cross-platform using Path.wildcard (not System.cmd)
- FileTree.validate_references/2 catches hallucinated file paths in task descriptions
- DagValidator.validate/1 catches cycles, invalid indices, and forward references
- DagValidator.topological_order/1 provides correct submission ordering
- All tests pass with async: true
</success_criteria>

<output>
After completion, create `.planning/phases/30-goal-decomposition-and-inner-loop/30-01-SUMMARY.md`
</output>

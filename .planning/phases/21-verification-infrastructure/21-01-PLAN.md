---
phase: 21-verification-infrastructure
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/agent_com/verification/store.ex
  - lib/agent_com/verification/report.ex
  - test/agent_com/verification/store_test.exs
  - test/agent_com/verification/report_test.exs
autonomous: true

must_haves:
  truths:
    - "Verification reports persist across hub restarts via DETS"
    - "Reports are keyed by {task_id, run_number} for multi-run history"
    - "Retention cap prevents unbounded DETS growth"
    - "Report struct captures pass/fail per check with stdout/stderr and per-check timing"
  artifacts:
    - path: "lib/agent_com/verification/store.ex"
      provides: "GenServer managing verification_reports DETS table"
      exports: ["save/2", "get/1", "get_latest/1", "list_for_task/1"]
    - path: "lib/agent_com/verification/report.ex"
      provides: "Report struct builder and validation"
      exports: ["build/3", "build_skipped/1", "build_auto_pass/1", "build_timeout/1"]
    - path: "test/agent_com/verification/store_test.exs"
      provides: "Store GenServer tests with DETS isolation"
    - path: "test/agent_com/verification/report_test.exs"
      provides: "Report builder tests"
  key_links:
    - from: "lib/agent_com/verification/store.ex"
      to: "DETS verification_reports table"
      via: ":dets.insert / :dets.lookup"
      pattern: "dets\\.(insert|lookup|sync)"
    - from: "lib/agent_com/verification/report.ex"
      to: "lib/agent_com/verification/store.ex"
      via: "Store.save(task_id, report)"
      pattern: "Store\\.save"
---

<objective>
Build the verification report structure and DETS-backed persistence store for verification history.

Purpose: Phase 21 needs a well-defined report format and persistent storage so that verification results survive hub restarts, support multi-run history (Phase 22 retries), and can be queried across tasks. This plan establishes the data model that all other Phase 21 work depends on.

Output: `AgentCom.Verification.Report` module for building structured reports, `AgentCom.Verification.Store` GenServer for DETS persistence with retention cap.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-verification-infrastructure/21-RESEARCH.md
@lib/agent_com/llm_registry.ex (DETS + GenServer pattern reference)
@lib/agent_com/task_queue.ex (dets_path pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD Report struct builder and validation</name>
  <files>
    lib/agent_com/verification/report.ex
    test/agent_com/verification/report_test.exs
  </files>
  <action>
RED: Create test/agent_com/verification/report_test.exs with tests for:

1. `build/3` - takes task_id, run_number, list of check results; returns a report map with:
   - `task_id`, `run_number`, `started_at`, `duration_ms`, `timeout_ms` (from opts)
   - `status`: `:pass` (all checks pass), `:fail` (any check failed), `:error` (any check errored)
   - `checks`: list of check result maps (each has `type`, `target`, `description`, `status`, `output`, `duration_ms`)
   - `summary`: `%{total, passed, failed, errors, timed_out}`
   - Test: all-pass -> status :pass, one-fail -> status :fail, one-error -> status :error
   - Test: summary counts match check statuses

2. `build_skipped/1` - takes task_id; returns report with status: :skip, empty checks
3. `build_auto_pass/1` - takes task_id; returns report with status: :auto_pass, empty checks (for tasks with no verification_steps)
4. `build_timeout/1` - takes task_id; returns report with status: :timeout, empty checks

GREEN: Create lib/agent_com/verification/report.ex as `AgentCom.Verification.Report`:
- Pure functions, no GenServer or side effects
- `@default_timeout_ms 120_000` module attribute
- `build/3` computes status from check results using Enum.reduce to count pass/fail/error/timeout
- Priority: :error > :fail > :timeout > :pass for overall status
- `build_skipped/1`, `build_auto_pass/1`, `build_timeout/1` are simple constructors
- Each report includes `started_at: System.system_time(:millisecond)` and `timeout_ms` defaulting to @default_timeout_ms

REFACTOR: Extract summary computation into private `compute_summary/1` helper.
  </action>
  <verify>
    `cd C:/Users/nrosq/src/AgentCom && mix test test/agent_com/verification/report_test.exs --no-start` passes all tests
  </verify>
  <done>Report builder creates well-structured verification reports from check results with correct status derivation and summary counts</done>
</task>

<task type="auto">
  <name>Task 2: TDD Verification Store GenServer with DETS persistence</name>
  <files>
    lib/agent_com/verification/store.ex
    test/agent_com/verification/store_test.exs
  </files>
  <action>
RED: Create test/agent_com/verification/store_test.exs with tests for:

1. `save/2` - persists report with key `{task_id, run_number}`, returns :ok
2. `get/1` - returns `{:ok, report}` for existing `{task_id, run_number}` key, `{:error, :not_found}` for missing
3. `get_latest/1` - returns latest report (highest run_number) for a task_id
4. `list_for_task/1` - returns all reports for a task_id, ordered by run_number ascending
5. Retention: after saving more than @max_reports reports, oldest reports per task are pruned (test with max_reports: 3)
6. Persistence: reports survive GenServer stop/restart (test with stop + start_link, verify data still present)

Use DETS isolation pattern from existing tests: unique temp paths per test, cleanup in on_exit callback.

GREEN: Create lib/agent_com/verification/store.ex as `AgentCom.Verification.Store`:
- GenServer with `use GenServer`
- Module attribute: `@dets_table :verification_reports`, `@max_reports 1000`
- `init/1`: open DETS table at data_dir/verification_reports.dets (same pattern as LlmRegistry.data_dir)
  - Support `dets_path` option in init args for test isolation
- `save/2`: GenServer.call that inserts `{{task_id, run_number}, report}` into DETS, then calls `enforce_retention/1`
- `get/1`: GenServer.call that looks up `{task_id, run_number}`
- `get_latest/1`: GenServer.call that uses `:dets.match_object` to find all reports for task_id, returns the one with highest run_number
- `list_for_task/1`: GenServer.call returning all reports sorted by run_number
- `enforce_retention/1`: private, counts total records, if > @max_reports, delete oldest (by started_at timestamp) until at @max_reports
- `terminate/2`: close DETS table

REFACTOR: Ensure :dets.sync is called after inserts for durability.
  </action>
  <verify>
    `cd C:/Users/nrosq/src/AgentCom && mix test test/agent_com/verification/store_test.exs` passes all tests
  </verify>
  <done>Verification Store persists reports in DETS, supports querying by task_id, enforces retention cap, and survives restarts</done>
</task>

</tasks>

<verification>
- `mix test test/agent_com/verification/` passes all tests
- `mix compile --no-start` succeeds with no warnings from new modules
- Report.build/3 produces correct status derivation from check results
- Store persists and retrieves reports across GenServer restart
</verification>

<success_criteria>
- Report struct captures all verification data: per-check pass/fail, stdout/stderr, timing, overall status
- Store GenServer manages DETS table with save/get/list/retention operations
- All tests pass with DETS isolation
- TDD commits: RED (failing tests) -> GREEN (implementation) -> REFACTOR
</success_criteria>

<output>
After completion, create `.planning/phases/21-verification-infrastructure/21-01-SUMMARY.md`
</output>

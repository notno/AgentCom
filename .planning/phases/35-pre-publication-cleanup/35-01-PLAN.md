---
phase: 35-pre-publication-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/agent_com/repo_scanner.ex
  - lib/agent_com/repo_scanner/patterns.ex
  - lib/agent_com/repo_scanner/file_walker.ex
  - lib/agent_com/repo_scanner/finding.ex
autonomous: true

must_haves:
  truths:
    - "Scanner detects Anthropic API keys (sk-ant-*) in source files"
    - "Scanner detects GitHub PATs (ghp_*) and hex tokens (bd5b66*, 617b01*)"
    - "Scanner detects Tailscale IPs (100.x.x.x) and private IPs"
    - "Scanner detects workspace files (SOUL.md, USER.md, etc.) by filename"
    - "Scanner detects personal references (Nathan, notno, C:\\Users\\nrosq)"
    - "Scanner skips binary files, .git, _build, deps, node_modules"
    - "Token matches are redacted in findings (first 4 + last 4 chars only)"
  artifacts:
    - path: "lib/agent_com/repo_scanner/patterns.ex"
      provides: "Pattern definitions for all 4 scanning categories"
      contains: "defmodule AgentCom.RepoScanner.Patterns"
    - path: "lib/agent_com/repo_scanner/file_walker.ex"
      provides: "File traversal with directory/binary exclusions"
      contains: "defmodule AgentCom.RepoScanner.FileWalker"
    - path: "lib/agent_com/repo_scanner/finding.ex"
      provides: "Finding struct with file_path, line_number, category, severity"
      contains: "defmodule AgentCom.RepoScanner.Finding"
    - path: "lib/agent_com/repo_scanner.ex"
      provides: "Public API: scan_repo/2, scan_all/1"
      exports: ["scan_repo", "scan_all"]
  key_links:
    - from: "lib/agent_com/repo_scanner.ex"
      to: "lib/agent_com/repo_scanner/patterns.ex"
      via: "alias and Patterns.patterns_for/1 calls"
      pattern: "Patterns\\.patterns_for"
    - from: "lib/agent_com/repo_scanner.ex"
      to: "lib/agent_com/repo_scanner/file_walker.ex"
      via: "FileWalker.walk/2 for file discovery"
      pattern: "FileWalker\\.walk"
    - from: "lib/agent_com/repo_scanner.ex"
      to: "lib/agent_com/repo_registry.ex"
      via: "RepoRegistry.list_repos/0 in scan_all"
      pattern: "RepoRegistry\\.list_repos"
---

<objective>
Build the core RepoScanner library module that detects sensitive content (tokens, IPs, workspace files, personal references) across repository files using deterministic regex scanning.

Purpose: Systematize the detection of sensitive content identified by the 3-agent audit, making pre-publication cleanup repeatable and comprehensive.
Output: Working scanner library that can scan any repo path and return structured findings.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-pre-publication-cleanup/35-RESEARCH.md
@lib/agent_com/repo_registry.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pattern library, FileWalker, and Finding struct</name>
  <files>
    lib/agent_com/repo_scanner/patterns.ex
    lib/agent_com/repo_scanner/file_walker.ex
    lib/agent_com/repo_scanner/finding.ex
  </files>
  <action>
Create three supporting modules for the scanner:

**1. `AgentCom.RepoScanner.Finding` (finding.ex):**
- Define a struct with fields: `file_path` (relative to repo root), `line_number` (1-based, 0 for filename-only matches), `category` (atom: `:tokens | :ips | :workspace_files | :personal_refs`), `pattern_name` (string), `matched_text` (string, redacted for tokens), `severity` (`:critical | :warning`), `replacement` (string or nil), `action` (`:replace | :remove_and_gitignore`)
- Derive Jason.Encoder for JSON serialization

**2. `AgentCom.RepoScanner.Patterns` (patterns.ex):**
- Define `@patterns` map as module attribute with 4 categories, using compile-time `~r//` sigils:
  - `:tokens` -- `sk-ant-[a-zA-Z0-9_-]{20,}` (critical), `ghp_[a-zA-Z0-9]{36}` (critical), `bd5b66[a-f0-9]{10,}` (critical), `617b01[a-f0-9]{10,}` (critical)
  - `:ips` -- `\b100\.\d{1,3}\.\d{1,3}\.\d{1,3}\b` (critical, Tailscale), `\b(192\.168\.\d{1,3}\.\d{1,3}|10\.\d{1,3}\.\d{1,3}\.\d{1,3})\b` (warning, private)
  - `:workspace_files` -- filename-based (not regex): filenames list `~w(SOUL.md USER.md IDENTITY.md TOOLS.md HEARTBEAT.md AGENTS.md commit_msg.txt gen_token.ps1)`, dir_patterns `["memory/"]`, severity `:warning`, action `:remove_and_gitignore`
  - `:personal_refs` -- `\bNathan\b` with case-insensitive flag (warning), `\bnotno\b` (warning), `C:[/\\]Users[/\\]nrosq[/\\]` (warning, must match both slash styles per research pitfall 4)
- Public functions: `all_categories/0`, `patterns_for/1`, `all_patterns/0`

**3. `AgentCom.RepoScanner.FileWalker` (file_walker.ex):**
- `@default_excludes` -- `.git`, `_build`, `deps`, `node_modules`, `.elixir_ls`, `priv/static`
- `@binary_extensions` -- `.beam`, `.gz`, `.tar`, `.zip`, `.png`, `.jpg`, `.jpeg`, `.gif`, `.ico`, `.woff`, `.woff2`, `.ttf`, `.eot`, `.exe`, `.dll`, `.so`, `.dylib`, `.dets`, `.db`, `.sqlite3`
- `@max_file_size` -- 1_048_576 (1 MB)
- `walk/2` -- recursive directory traversal returning list of absolute file paths. Skip excluded dirs, binary extensions, oversized files. Use `File.ls/1` (not `File.ls!/1`) to handle permission errors gracefully. Accept `excludes` keyword option to override defaults.
- Follow research code example closely but ensure `excluded?/3` checks both the entry name and the relative path prefix.
  </action>
  <verify>
Run `mix compile --warnings-as-errors` -- all three modules compile cleanly. Verify in iex:
- `AgentCom.RepoScanner.Patterns.all_categories()` returns `[:tokens, :ips, :workspace_files, :personal_refs]`
- `AgentCom.RepoScanner.FileWalker.walk(".")` returns a list of file paths (not empty, excludes _build/deps/.git)
- `%AgentCom.RepoScanner.Finding{}` creates a struct
  </verify>
  <done>Three modules compile, Patterns returns all 4 categories with correct regex patterns, FileWalker traverses directories with exclusions, Finding struct is defined with Jason.Encoder derived.</done>
</task>

<task type="auto">
  <name>Task 2: RepoScanner public API with scan_repo and scan_all</name>
  <files>
    lib/agent_com/repo_scanner.ex
  </files>
  <action>
Create `AgentCom.RepoScanner` as the public API module. This is a library module (NOT a GenServer) per research recommendation.

**Public functions:**

1. `scan_repo(repo_path, opts \\ [])` -- returns `{:ok, report}` or `{:error, term()}`
   - `opts[:categories]` -- list of category atoms, defaults to `Patterns.all_categories()`
   - Call `FileWalker.walk(repo_path)` to get file list
   - For each file, call `scan_file/3` which reads the file, checks for binary content (null bytes in content), splits into lines, and matches each line against patterns for the requested categories
   - Separately call `check_workspace_files/1` for the `:workspace_files` category (filename-based, not content-based)
   - Build report map with: `repo_path`, `scanned_at` (UTC ISO8601), `scan_duration_ms` (measure with `:timer.tc`), `files_scanned` count, `findings` list, `summary` (counts by severity and category), `blocking` (true if any `:critical` findings), `gitignore_recommendations` (list of gitignore entries from workspace file findings), `cleanup_tasks` (list of `%{description, file, line, replacement}` maps derived from non-workspace findings)

2. `scan_all(opts \\ [])` -- returns `{:ok, [report]}`
   - Call `AgentCom.RepoRegistry.list_repos()` to get registered repos
   - Accept `opts[:base_dir]` for resolving repo local paths. Derive local path as `Path.join(base_dir, repo_name)` where `repo_name` is extracted from the repo URL (last path segment without .git)
   - If `opts[:repo_path]` is given for a single repo, just scan that one
   - Map over repos calling `scan_repo/2` for each

**Private helpers:**

- `scan_file/3` -- read file, null-byte check, line-by-line scan. Use `File.read/1` (not stream, files are <1MB from FileWalker filter)
- `scan_line/4` -- match line against all patterns in requested categories, return list of Finding structs
- `redact_match/3` -- for `:tokens` category, show only first 4 + last 4 chars of the matched token. For other categories, show the full match.
- `check_workspace_files/1` -- check for workspace filenames and directory patterns, return findings with `action: :remove_and_gitignore`
- `build_report/2` -- assemble the report map from repo_path and findings list
- `generate_gitignore_recommendations/1` -- extract gitignore entries from workspace_files findings (filenames + "memory/" directory)

Follow the research code examples closely. Key details:
- Workspace file detection is separate from content scanning (checks file existence, not file content)
- Token redaction MUST happen before findings are returned (security requirement)
- Report `blocking` field = `Enum.any?(findings, &(&1.severity == :critical))`
  </action>
  <verify>
Run `mix compile --warnings-as-errors`. Then in iex:
```
{:ok, report} = AgentCom.RepoScanner.scan_repo(".")
report.files_scanned > 0
is_list(report.findings)
is_boolean(report.blocking)
is_list(report.gitignore_recommendations)
```
The scan should complete without errors and return a structured report. If the current repo has any matching patterns (likely -- it may have personal paths in docs), findings should be non-empty.
  </verify>
  <done>RepoScanner.scan_repo/2 scans a directory and returns a report with findings, summary, blocking status, and gitignore recommendations. RepoScanner.scan_all/1 scans all registered repos. Token matches are redacted in finding output.</done>
</task>

</tasks>

<verification>
1. `mix compile --warnings-as-errors` passes with zero warnings
2. `AgentCom.RepoScanner.scan_repo(".")` returns `{:ok, report}` with a complete report structure
3. Report contains findings if sensitive content exists in the scanned directory
4. Token findings have redacted `matched_text` (never full token values)
5. Workspace file findings have `action: :remove_and_gitignore`
6. Binary files and excluded directories are not scanned
</verification>

<success_criteria>
- All 4 scanning categories (tokens, IPs, workspace files, personal refs) are implemented with correct regex patterns
- FileWalker correctly excludes .git, _build, deps, node_modules, binary files, and files >1MB
- scan_repo/2 returns a structured report with findings, summary, blocking flag, and gitignore recommendations
- scan_all/1 uses RepoRegistry to discover and scan all registered repos
- Token matches are always redacted in findings (first 4 + last 4 chars only)
</success_criteria>

<output>
After completion, create `.planning/phases/35-pre-publication-cleanup/35-01-SUMMARY.md`
</output>

---
phase: 35-pre-publication-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - lib/agent_com/endpoint.ex
  - test/agent_com/repo_scanner_test.exs
autonomous: true

must_haves:
  truths:
    - "POST /api/admin/repo-scanner/scan with repo_path returns scan report as JSON"
    - "POST /api/admin/repo-scanner/scan without repo_path scans all registered repos"
    - "Endpoint requires admin authentication"
    - "Scanner correctly identifies tokens, IPs, workspace files, and personal references in test fixtures"
    - "Scanner skips binary files and excluded directories"
    - "Token findings are redacted in API response"
  artifacts:
    - path: "lib/agent_com/endpoint.ex"
      provides: "POST /api/admin/repo-scanner/scan route"
      contains: "repo-scanner/scan"
    - path: "test/agent_com/repo_scanner_test.exs"
      provides: "Unit tests for all 4 scanning categories"
      contains: "defmodule AgentCom.RepoScannerTest"
  key_links:
    - from: "lib/agent_com/endpoint.ex"
      to: "lib/agent_com/repo_scanner.ex"
      via: "AgentCom.RepoScanner.scan_repo/2 call"
      pattern: "RepoScanner\\.scan_repo"
    - from: "test/agent_com/repo_scanner_test.exs"
      to: "lib/agent_com/repo_scanner.ex"
      via: "Testing scan_repo/2 against temp directory fixtures"
      pattern: "RepoScanner\\.scan_repo"
---

<objective>
Add the API endpoint for triggering scans and comprehensive tests validating all 4 scanning categories against controlled test fixtures.

Purpose: Make the scanner accessible via HTTP API and prove correctness of all pattern matching with reproducible tests.
Output: Working API endpoint and passing test suite.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-pre-publication-cleanup/35-RESEARCH.md
@.planning/phases/35-pre-publication-cleanup/35-01-SUMMARY.md
@lib/agent_com/endpoint.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: API endpoint for repo scanning</name>
  <files>
    lib/agent_com/endpoint.ex
  </files>
  <action>
Add a `POST /api/admin/repo-scanner/scan` route to `endpoint.ex` following the existing admin endpoint pattern (RequireAuth, conn.halted check, JSON response).

**Request body options:**
- `repo_path` (string, optional) -- local filesystem path to scan. If provided, scans only that repo.
- `categories` (list of strings, optional) -- subset of categories to scan. Defaults to all. Parse strings to atoms: `"tokens"` -> `:tokens`, etc. Only allow the 4 known categories (reject unknown).

**Behavior:**
- If `repo_path` provided: call `AgentCom.RepoScanner.scan_repo(path, opts)`, return 200 with report JSON
- If no `repo_path`: call `AgentCom.RepoScanner.scan_all(opts)`, return 200 with `%{"reports" => reports}`
- On error: return 422 with `%{"error" => reason}`

**Response format:** The report map from RepoScanner serializes to JSON via Jason. Findings contain Finding structs which should have Jason.Encoder derived (done in Plan 01). If Jason.Encoder is not derived on Finding, convert findings to plain maps before encoding.

Add a helper `parse_scan_categories/1` that converts a list of category strings to atoms, filtering to only valid categories. Place this as a private function near the route.

Follow the exact pattern of existing admin endpoints (e.g., `post "/api/admin/backup"`): RequireAuth call, halted check, body_params parsing, send_json response.
  </action>
  <verify>
`mix compile --warnings-as-errors` passes. The route exists in endpoint.ex. Can verify with:
```
curl -X POST http://localhost:4000/api/admin/repo-scanner/scan \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"repo_path": "."}'
```
Returns 200 with JSON report containing `findings`, `summary`, `blocking`, `gitignore_recommendations`.
  </verify>
  <done>POST /api/admin/repo-scanner/scan endpoint exists, requires auth, accepts optional repo_path and categories params, returns scan report as JSON.</done>
</task>

<task type="auto">
  <name>Task 2: Scanner test suite with temp directory fixtures</name>
  <files>
    test/agent_com/repo_scanner_test.exs
  </files>
  <action>
Create a comprehensive test suite for the scanner using temporary directory fixtures (no real repo scanning in tests).

**Test setup:** Use `setup` block to create a temporary directory with controlled test files. Use `System.tmp_dir!/0` and a unique subdirectory per test. Clean up in `on_exit` callback.

**Test categories:**

1. **Token detection tests:**
   - Create a file containing `sk-ant-api03-abcdefghijklmnopqrst` -- assert finding with category `:tokens`, severity `:critical`, pattern_name `"anthropic_api_key"`
   - Create a file containing `ghp_abcdefghijklmnopqrstuvwxyz0123456789` -- assert finding with category `:tokens`, severity `:critical`
   - Assert matched_text is redacted (does NOT contain full token, shows `...` pattern)

2. **IP detection tests:**
   - Create a file containing `100.126.22.86` -- assert finding with category `:ips`, severity `:critical`, replacement `"your-tailscale-ip"`
   - Create a file containing `192.168.1.100` -- assert finding with category `:ips`, severity `:warning`

3. **Workspace file detection tests:**
   - Create `SOUL.md` in temp dir -- assert finding with category `:workspace_files`, action `:remove_and_gitignore`
   - Create `USER.md` in temp dir -- assert finding
   - Create `memory/` directory with a `.md` file -- assert finding
   - Assert gitignore_recommendations includes the detected files

4. **Personal reference detection tests:**
   - Create a file containing `Nathan` -- assert finding with category `:personal_refs`, replacement `"YOUR_NAME"`
   - Create a file containing `notno` -- assert finding
   - Create a file containing `C:\Users\nrosq\` -- assert finding (test Windows path)
   - Create a file containing `C:/Users/nrosq/` -- assert finding (test forward-slash variant)

5. **Exclusion tests:**
   - Create a `.git/` subdirectory with a file containing a token -- assert NO findings from that file
   - Create a `node_modules/` subdirectory with a file -- assert NO findings
   - Create a file with a `.beam` extension -- assert it is not scanned

6. **Report structure tests:**
   - Assert report has all required keys: `repo_path`, `scanned_at`, `files_scanned`, `findings`, `summary`, `blocking`, `gitignore_recommendations`, `cleanup_tasks`
   - Assert `blocking` is true when critical findings exist
   - Assert `blocking` is false when only warning findings exist
   - Assert `summary.by_category` has correct counts

7. **Category filtering test:**
   - Create temp dir with tokens AND personal refs
   - Call `scan_repo(path, categories: [:tokens])` -- assert only token findings returned, no personal ref findings

Use `assert` and pattern matching. Each test should be focused on one behavior. Aim for 15-20 test cases total.
  </action>
  <verify>
`mix test test/agent_com/repo_scanner_test.exs --trace` -- all tests pass. No warnings. Tests create and clean up temp directories.
  </verify>
  <done>Test suite covers all 4 scanning categories, exclusion behavior, report structure, token redaction, and category filtering. All tests pass against controlled temp directory fixtures.</done>
</task>

</tasks>

<verification>
1. `mix compile --warnings-as-errors` passes
2. `mix test test/agent_com/repo_scanner_test.exs` -- all tests pass
3. `mix test` -- full test suite still passes (no regressions)
4. API endpoint returns valid JSON report when called with a repo_path
5. Token findings in both test output and API response have redacted matched_text
</verification>

<success_criteria>
- POST /api/admin/repo-scanner/scan endpoint works with auth, returns scan report JSON
- Test suite covers all 4 categories with controlled fixtures and all tests pass
- Token redaction is verified in tests (full tokens never appear in findings)
- Scanner exclusions (binary files, .git, deps) are verified in tests
- Full test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/35-pre-publication-cleanup/35-02-SUMMARY.md`
</output>

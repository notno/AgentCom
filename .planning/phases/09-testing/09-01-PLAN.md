---
phase: 09-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/test.exs
  - test/test_helper.exs
  - test/support/dets_helpers.ex
  - test/support/test_factory.ex
  - test/support/ws_client.ex
  - lib/agent_com/config.ex
  - lib/agent_com/threads.ex
autonomous: true

must_haves:
  truths:
    - "Config module reads its DETS path from Application.get_env instead of hardcoded HOME"
    - "Threads module reads its DETS path from Application.get_env instead of hardcoded HOME"
    - "Running mix test in test env uses temp directories for all DETS tables"
    - "Test factory can create agents, submit tasks, and clean up without manual boilerplate"
    - "WebSocket test client can connect, identify, send/receive JSON messages"
  artifacts:
    - path: "config/test.exs"
      provides: "Test environment config with DETS temp paths and test port"
      contains: "config :agent_com"
    - path: "test/support/dets_helpers.ex"
      provides: "DETS isolation helpers for setup/teardown"
      contains: "setup_test_dets"
    - path: "test/support/test_factory.ex"
      provides: "Factory functions for creating test agents and tasks"
      contains: "create_agent"
    - path: "test/support/ws_client.ex"
      provides: "Mint.WebSocket-based test client GenServer"
      contains: "send_json"
    - path: "lib/agent_com/config.ex"
      provides: "Config module with configurable DETS path"
      contains: "Application.get_env"
    - path: "lib/agent_com/threads.ex"
      provides: "Threads module with configurable DETS path"
      contains: "Application.get_env"
  key_links:
    - from: "config/test.exs"
      to: "lib/agent_com/config.ex"
      via: "Application.get_env(:agent_com, :config_data_dir)"
      pattern: "config_data_dir"
    - from: "config/test.exs"
      to: "lib/agent_com/threads.ex"
      via: "Application.get_env(:agent_com, :threads_data_dir)"
      pattern: "threads_data_dir"
    - from: "test/support/dets_helpers.ex"
      to: "config/test.exs"
      via: "Application.put_env overrides at runtime"
      pattern: "Application\\.put_env"
---

<objective>
Create the test infrastructure foundation: DETS isolation helpers, test factory, WebSocket test client, config/test.exs, and refactor Config + Threads modules to use Application.get_env for DETS paths.

Purpose: This is the foundation that ALL subsequent test plans depend on. Without DETS isolation, tests corrupt production data. Without the factory, every test file duplicates agent/task setup. Without the WS client, integration tests cannot exercise the real protocol.

Output: config/test.exs, 3 test support modules, 2 refactored source modules
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-testing/09-RESEARCH.md

@lib/agent_com/config.ex
@lib/agent_com/threads.ex
@lib/agent_com/application.ex
@config/config.exs
@test/test_helper.exs
@test/smoke/helpers/agent_sim.ex
@test/smoke/helpers/setup.ex
@test/smoke/helpers/assertions.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Config + Threads DETS paths and create config/test.exs</name>
  <files>
    lib/agent_com/config.ex
    lib/agent_com/threads.ex
    config/test.exs
    config/config.exs
  </files>
  <action>
1. Refactor `lib/agent_com/config.ex` -- change `data_dir/0` (lines 61-65) to read from Application.get_env:
   ```elixir
   defp data_dir do
     dir = Application.get_env(:agent_com, :config_data_dir,
       Path.join([System.get_env("HOME") || ".", ".agentcom", "data"]))
     File.mkdir_p!(dir)
     dir
   end
   ```
   The default value preserves backward compatibility for production/dev.

2. Refactor `lib/agent_com/threads.ex` -- change `dets_path/1` (lines 137-141) to read from Application.get_env:
   ```elixir
   defp dets_path(name) do
     dir = Application.get_env(:agent_com, :threads_data_dir,
       Path.join([System.get_env("HOME") || ".", ".agentcom", "data"]))
     File.mkdir_p!(dir)
     Path.join(dir, name <> ".dets") |> String.to_charlist()
   end
   ```

3. Create `config/test.exs` with all DETS paths pointing to tmp/test/ directories and test port 4002:
   ```elixir
   import Config

   config :agent_com,
     port: 4002,
     task_queue_path: "tmp/test/task_queue",
     tokens_path: "tmp/test/tokens.json",
     mailbox_path: "tmp/test/mailbox.dets",
     message_history_path: "tmp/test/message_history.dets",
     channels_path: "tmp/test/channels",
     config_data_dir: "tmp/test/config",
     threads_data_dir: "tmp/test/threads"

   config :logger, level: :warning
   ```

4. Update `config/config.exs` to import environment-specific config at the bottom (standard Elixir pattern):
   Add at the very end of the file:
   ```elixir
   import_config "#{config_env()}.exs"
   ```
   This ensures config/test.exs is loaded when MIX_ENV=test.

IMPORTANT: Do NOT change any GenServer names, module names, or the supervision tree. Only change the two `defp` functions that compute DETS paths.
  </action>
  <verify>
Run `MIX_ENV=test mix compile --warnings-as-errors` -- should compile cleanly with no warnings.
Run `MIX_ENV=dev mix compile` -- should also compile (backward compatibility check).
Verify config/test.exs is loaded: `MIX_ENV=test mix run -e "IO.inspect(Application.get_env(:agent_com, :port))"` should output 4002.
  </verify>
  <done>
Config.data_dir/0 reads from Application.get_env(:agent_com, :config_data_dir) with HOME-based default.
Threads.dets_path/1 reads from Application.get_env(:agent_com, :threads_data_dir) with HOME-based default.
config/test.exs exists with all 7 DETS path overrides and port 4002.
config/config.exs imports environment-specific config.
Both dev and test environments compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test support modules (DETS helpers, test factory, WS client) and update test_helper.exs</name>
  <files>
    test/support/dets_helpers.ex
    test/support/test_factory.ex
    test/support/ws_client.ex
    test/test_helper.exs
  </files>
  <action>
1. Create `test/support/dets_helpers.ex` -- module `AgentCom.TestHelpers.DetsHelpers`:
   - `setup_test_dets/0`: Creates a fresh temp dir via `Path.join(System.tmp_dir!(), "agentcom_test_#{:erlang.unique_integer([:positive])}")`, calls `File.mkdir_p!/1`, then uses `Application.put_env/3` to override ALL 7 DETS paths (task_queue_path, tokens_path, mailbox_path, message_history_path, channels_path, config_data_dir, threads_data_dir) to subdirectories of the temp dir. Returns the tmp_dir path.
   - `restart_dets_servers/0`: Terminates then restarts these GenServers via `Supervisor.terminate_child`/`restart_child` on `AgentCom.Supervisor`, IN ORDER: first stop Scheduler, then TaskQueue, MessageHistory, Mailbox, Channels, Threads, Config, Auth. Then restart in REVERSE order (Auth, Config, Threads, Channels, Mailbox, MessageHistory, TaskQueue, Scheduler). Auth must restart because it reads tokens_path.
   - `cleanup_dets/1`: Takes tmp_dir, calls `File.rm_rf!/1`.
   - `full_test_setup/0`: Calls `setup_test_dets/0`, then `restart_dets_servers/0`, returns tmp_dir. Convenience for `setup` blocks.
   - `full_test_teardown/1`: Takes tmp_dir, calls `cleanup_dets/1`. For `on_exit` blocks.

2. Create `test/support/test_factory.ex` -- module `AgentCom.TestFactory`:
   - `create_agent/1`: Takes keyword opts (agent_id, capabilities, name -- all optional with defaults). Generates a unique agent_id if not provided. Calls `AgentCom.Auth.generate(agent_id)` for token, spawns a dummy process (`spawn(fn -> Process.sleep(:infinity) end)`) as ws_pid, starts AgentFSM via `AgentCom.AgentSupervisor.start_agent/1`, registers in Presence. Returns `%{agent_id, token, ws_pid, fsm_pid}`.
   - `submit_task/1`: Takes keyword opts (description, priority, submitted_by, max_retries, needed_capabilities -- all optional with defaults). Calls `AgentCom.TaskQueue.submit/1`. Returns the result.
   - `cleanup_agent/1`: Takes the map from `create_agent/1`. Kills ws_pid with `Process.exit(ws_pid, :kill)`, revokes token, sleeps 50ms for FSM to process :DOWN.
   - `cleanup_all_agents/1`: Takes list of agent maps, calls cleanup_agent for each.

3. Create `test/support/ws_client.ex` -- module `AgentCom.TestHelpers.WsClient`:
   Build a simplified GenServer WebSocket client based on `Smoke.AgentSim` (already in codebase). Key differences from AgentSim:
   - No task handling logic (just message collection)
   - Constructor takes `url` (default "ws://localhost:4002/ws" -- test port)
   - `start_link/1` takes opts keyword list with :url
   - `connect_and_identify/3` takes pid, agent_id, token -- sends identify message
   - `send_json/2` takes pid and map -- encodes and sends
   - `messages/1` returns all received JSON messages as list of maps
   - `wait_for_identified/2` takes pid and timeout -- polls until identified? returns true
   - `stop/1` graceful shutdown
   - Internal state tracks: conn, websocket, request_ref, response_status, response_headers, messages (list), identified (boolean)
   - Follow the exact Mint.WebSocket connection pattern from AgentSim: `Mint.HTTP.connect` -> `Mint.WebSocket.upgrade` -> process responses -> `Mint.WebSocket.new` on `:done` -> send identify
   - Process incoming `:data` responses by decoding frames, parsing JSON text frames, appending to messages list

4. Update `test/test_helper.exs`:
   - Keep existing `:inets.start()` call
   - Keep existing smoke helper loading
   - Add: compile all `test/support/*.ex` files (same pattern as smoke helpers)
   - Keep `ExUnit.start(exclude: [:skip], capture_log: true)`
   - The order should be: inets, load smoke helpers, load support helpers, ExUnit.start

NOTE on WebSocket test client: Use `Mint.HTTP` and `Mint.WebSocket` directly (already available via `fresh` dep). Do NOT add any new dependencies.
  </action>
  <verify>
Run `MIX_ENV=test mix compile` -- should compile all support modules without errors.
Run `MIX_ENV=test mix test` -- should run (existing smoke tests may fail if they need a running hub, but the test infrastructure itself should load without errors). Look for: no compile errors from support modules, ExUnit starts successfully.
Verify support modules are loadable: `MIX_ENV=test mix run -e "IO.inspect(AgentCom.TestFactory.module_info(:module))"` should output `AgentCom.TestFactory`.
  </verify>
  <done>
test/support/dets_helpers.ex exists with setup_test_dets/0, restart_dets_servers/0, cleanup_dets/1, full_test_setup/0, full_test_teardown/1.
test/support/test_factory.ex exists with create_agent/1, submit_task/1, cleanup_agent/1, cleanup_all_agents/1.
test/support/ws_client.ex exists as a Mint.WebSocket GenServer with connect_and_identify/3, send_json/2, messages/1, wait_for_identified/2, stop/1.
test/test_helper.exs loads both smoke helpers and support helpers.
All support modules compile and are accessible in test environment.
  </done>
</task>

</tasks>

<verification>
1. `MIX_ENV=test mix compile --warnings-as-errors` passes
2. Config and Threads modules use Application.get_env for DETS paths
3. config/test.exs loaded in test environment (port 4002 confirms)
4. All 3 support modules compile and are loadable
5. Production/dev behavior unchanged (default paths preserved)
</verification>

<success_criteria>
- Config.ex and Threads.ex use Application.get_env for DETS paths with backward-compatible defaults
- config/test.exs configures all 7 DETS paths + port for test isolation
- DetsHelpers provides per-test temp dir setup/teardown for all DETS-backed GenServers
- TestFactory provides create_agent, submit_task, cleanup_agent convenience functions
- WsClient provides Mint.WebSocket-based test client for WebSocket integration tests
- test_helper.exs auto-loads all support modules
- Everything compiles cleanly in both dev and test environments
</success_criteria>

<output>
After completion, create `.planning/phases/09-testing/09-01-SUMMARY.md`
</output>

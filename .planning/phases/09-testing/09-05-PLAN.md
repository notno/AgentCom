---
phase: 09-testing
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - sidecar/lib/queue.js
  - sidecar/lib/wake.js
  - sidecar/lib/git-workflow.js
  - sidecar/index.js
  - sidecar/test/queue.test.js
  - sidecar/test/wake.test.js
  - sidecar/test/git-workflow.test.js
  - sidecar/package.json
autonomous: true

must_haves:
  truths:
    - "Sidecar queue management functions are extracted to a testable module and unit tested"
    - "Sidecar wake trigger functions are extracted to a testable module and unit tested"
    - "Sidecar git workflow functions are tested with real temp git repos"
    - "Running node --test in sidecar directory executes all tests and they pass"
  artifacts:
    - path: "sidecar/lib/queue.js"
      provides: "Extracted queue management module"
      contains: "loadQueue"
    - path: "sidecar/lib/wake.js"
      provides: "Extracted wake trigger module"
      contains: "interpolateWakeCommand"
    - path: "sidecar/lib/git-workflow.js"
      provides: "Extracted git workflow helpers"
      contains: "runGitCommand"
    - path: "sidecar/test/queue.test.js"
      provides: "Queue management unit tests"
      contains: "describe.*Queue"
    - path: "sidecar/test/wake.test.js"
      provides: "Wake trigger unit tests"
      contains: "describe.*Wake"
    - path: "sidecar/test/git-workflow.test.js"
      provides: "Git workflow tests with real temp repos"
      contains: "describe.*Git"
  key_links:
    - from: "sidecar/index.js"
      to: "sidecar/lib/queue.js"
      via: "require/import for queue functions"
      pattern: "require.*lib/queue|from.*lib/queue"
    - from: "sidecar/test/queue.test.js"
      to: "sidecar/lib/queue.js"
      via: "imports loadQueue and saveQueue for testing"
      pattern: "require.*lib/queue|from.*lib/queue"
---

<objective>
Extract testable functions from the monolithic sidecar index.js into separate modules, then write unit tests using node:test. Git workflow tests use real temp git repos per locked decision.

Purpose: Satisfies TEST-05 (sidecar Node.js tests for queue, wake trigger, git workflow). The sidecar is 880 lines in a single file -- extracting modules makes functions independently testable without starting the full sidecar (which would try to connect to the hub). Uses node:test per Claude's discretion decision (zero deps, built into Node 22).

Output: 3 extracted modules in sidecar/lib/, 3 test files in sidecar/test/, updated index.js to use extracted modules
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-testing/09-RESEARCH.md

@sidecar/index.js
@sidecar/agentcom-git.js
@sidecar/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract sidecar modules from index.js</name>
  <files>
    sidecar/lib/queue.js
    sidecar/lib/wake.js
    sidecar/lib/git-workflow.js
    sidecar/index.js
    sidecar/package.json
  </files>
  <action>
The sidecar uses CommonJS (`require`). Keep using CommonJS for extracted modules (matching existing codebase convention). Do NOT convert to ESM.

**Extract `sidecar/lib/queue.js`:**
Move these functions from index.js:
- `loadQueue(queuePath)` -- takes queuePath as parameter instead of using global QUEUE_PATH
- `saveQueue(queuePath, queue)` -- takes queuePath as parameter instead of using global QUEUE_PATH
- `cleanupResultFiles(taskId, resultsDir)` -- takes resultsDir as parameter

Export them: `module.exports = { loadQueue, saveQueue, cleanupResultFiles }`

The functions must be pure (no global state). Pass paths as parameters.

**Extract `sidecar/lib/wake.js`:**
Move these functions from index.js:
- `interpolateWakeCommand(command, task)` -- already pure, no changes needed
- `execCommand(command)` -- already pure, returns promise
- `RETRY_DELAYS` constant

Export: `module.exports = { interpolateWakeCommand, execCommand, RETRY_DELAYS }`

Do NOT extract `wakeAgent` or `startConfirmationTimeout` -- they have complex dependencies on _queue and hub. Keep those in index.js.

**Extract `sidecar/lib/git-workflow.js`:**
Move this function from index.js:
- `runGitCommand(command, args)` -- takes gitCliPath as parameter or computes it relative to __dirname

Export: `module.exports = { runGitCommand }`

Also export a version that accepts a custom path: `runGitCommandWithPath(gitCliPath, command, args)` for testability.

**Update `sidecar/index.js`:**
Replace the extracted function definitions with requires:
```javascript
const { loadQueue, saveQueue, cleanupResultFiles } = require('./lib/queue');
const { interpolateWakeCommand, execCommand, RETRY_DELAYS } = require('./lib/wake');
const { runGitCommand } = require('./lib/git-workflow');
```

Update call sites:
- `loadQueue()` -> `loadQueue(QUEUE_PATH)` (pass the path)
- `saveQueue(_queue)` -> `saveQueue(QUEUE_PATH, _queue)` (pass path and queue)
- `cleanupResultFiles(taskId)` -> `cleanupResultFiles(taskId, _config.results_dir)` (pass resultsDir)

CRITICAL: The refactored index.js must still work identically. The `main()` function and `HubConnection` class stay in index.js. Only pure/extractable functions move out.

**Update `sidecar/package.json`:**
Add test script:
```json
"scripts": {
  "start": "node index.js",
  "test": "node --test test/"
}
```

Test the refactored sidecar still runs: `cd sidecar && node -e "require('./lib/queue')"` should not throw. Same for wake and git-workflow.
  </action>
  <verify>
`cd sidecar && node -e "const q = require('./lib/queue'); console.log(typeof q.loadQueue)"` outputs "function".
`cd sidecar && node -e "const w = require('./lib/wake'); console.log(typeof w.interpolateWakeCommand)"` outputs "function".
`cd sidecar && node -e "const g = require('./lib/git-workflow'); console.log(typeof g.runGitCommand)"` outputs "function".
`cd sidecar && node -c index.js` -- syntax check passes.
  </verify>
  <done>
Three modules extracted to sidecar/lib/ (queue.js, wake.js, git-workflow.js).
index.js refactored to import from extracted modules.
All extracted functions accept dependencies as parameters (no global state).
sidecar/package.json has "test" script.
Refactored index.js maintains identical behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write sidecar unit tests with node:test</name>
  <files>
    sidecar/test/queue.test.js
    sidecar/test/wake.test.js
    sidecar/test/git-workflow.test.js
  </files>
  <action>
Use `node:test` (built-in) and `node:assert` (built-in). No new npm dependencies needed.

**Queue tests** (`sidecar/test/queue.test.js`):
```javascript
const { describe, it, beforeEach, afterEach } = require('node:test');
const assert = require('node:assert');
const fs = require('node:fs');
const path = require('node:path');
const os = require('node:os');
const { loadQueue, saveQueue, cleanupResultFiles } = require('../lib/queue');
```

Test cases:
- loadQueue returns `{ active: null, recovering: null }` when file doesn't exist
- loadQueue returns `{ active: null, recovering: null }` on corrupt JSON file (write "not json{{{" to file)
- loadQueue parses valid queue file correctly
- saveQueue writes valid JSON that loadQueue can read back (round-trip)
- saveQueue creates file if it doesn't exist
- cleanupResultFiles removes .json and .started files for a task_id
- cleanupResultFiles handles missing files gracefully (no throw)

Each test creates a fresh temp dir in beforeEach, removes it in afterEach:
```javascript
let tmpDir;
beforeEach(() => { tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'sidecar-test-')); });
afterEach(() => { fs.rmSync(tmpDir, { recursive: true, force: true }); });
```

NOTE: saveQueue in the extracted module uses `writeFileAtomic.sync()`. The tests will need the `write-file-atomic` package to be available. Since it's already a production dependency in sidecar/package.json, it will be available. If the extracted saveQueue needs to require it, make sure the require path resolves correctly from `sidecar/lib/queue.js`.

**Wake tests** (`sidecar/test/wake.test.js`):
```javascript
const { describe, it } = require('node:test');
const assert = require('node:assert');
const { interpolateWakeCommand, RETRY_DELAYS } = require('../lib/wake');
```

Test cases:
- interpolateWakeCommand replaces ${TASK_ID} with task.task_id
- interpolateWakeCommand replaces ${TASK_DESCRIPTION} with task.description
- interpolateWakeCommand replaces ${TASK_JSON} with JSON-encoded task (with escaped quotes)
- interpolateWakeCommand handles missing task fields gracefully
- interpolateWakeCommand with no template variables returns command unchanged
- RETRY_DELAYS has 3 entries: [5000, 15000, 30000]
- execCommand with a simple command (e.g., `echo hello` or `node -e "console.log('ok')"`) resolves with exit code 0
- execCommand with a failing command rejects with error info

**Git workflow tests** (`sidecar/test/git-workflow.test.js`):
Per locked decision: "Git workflow tests use real temp git repos (not mocked git commands)."

```javascript
const { describe, it, beforeEach, afterEach } = require('node:test');
const assert = require('node:assert');
const fs = require('node:fs');
const path = require('node:path');
const os = require('node:os');
const { execSync } = require('node:child_process');
```

Setup: Create a real temp git repo:
```javascript
let tmpDir;
beforeEach(() => {
  tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'git-test-'));
  execSync('git init', { cwd: tmpDir });
  execSync('git config user.email "test@test.com"', { cwd: tmpDir });
  execSync('git config user.name "Test"', { cwd: tmpDir });
  // Create initial commit so we have a branch
  fs.writeFileSync(path.join(tmpDir, 'README.md'), '# test');
  execSync('git add . && git commit -m "init"', { cwd: tmpDir });
});
afterEach(() => { fs.rmSync(tmpDir, { recursive: true, force: true }); });
```

Test cases -- read `sidecar/agentcom-git.js` to understand what commands it supports:
- Test that `agentcom-git.js start-task` creates a new branch from main in the temp repo
- Test that `agentcom-git.js submit` stages, commits, and (attempts to) push (push will fail without remote, which is fine -- verify it handles that gracefully or test with a local bare remote)
- Test the branch naming convention
- Test with missing/empty args returns error status

For git tests, call `agentcom-git.js` as a child process (same as production code does via `spawnSync`), passing the tmpDir as the repo_dir in args.

If agentcom-git.js is tightly coupled to config.json, the tests may need to mock or override the config path. Read the file to understand how it gets its config. If it reads from argv (which runGitCommand passes as JSON), it should be testable without config.json.
  </action>
  <verify>
Run all sidecar tests: `cd sidecar && npm test` (or `node --test test/`)
All tests pass. Queue >= 5 tests, Wake >= 5 tests, Git >= 2 tests.
  </verify>
  <done>
sidecar/test/queue.test.js tests loadQueue, saveQueue, cleanupResultFiles with temp dirs.
sidecar/test/wake.test.js tests interpolateWakeCommand (template interpolation), execCommand, and RETRY_DELAYS.
sidecar/test/git-workflow.test.js tests git operations with real temp git repos.
All tests pass with `node --test test/` and use zero additional npm dependencies.
  </done>
</task>

</tasks>

<verification>
1. `cd sidecar && node --test test/` -- all tests pass
2. `cd sidecar && node -c index.js` -- refactored index.js is syntactically valid
3. Extracted modules export functions that accept dependencies as parameters
4. Git tests use real temp repos (not mocked)
5. No new npm dependencies added
</verification>

<success_criteria>
- Three modules extracted from monolithic index.js into sidecar/lib/
- index.js refactored to use extracted modules, functionally identical
- Queue tests cover load/save/corrupt/round-trip/cleanup (>= 5 tests)
- Wake tests cover interpolation, exec, retry delays (>= 5 tests)
- Git tests use real temp git repos and test branch creation/submission (>= 2 tests)
- All sidecar tests pass with `node --test` using built-in node:test
- Satisfies TEST-05 requirement
</success_criteria>

<output>
After completion, create `.planning/phases/09-testing/09-05-SUMMARY.md`
</output>

---
phase: 09-testing
plan: 06
type: execute
wave: 3
depends_on: ["09-02", "09-03", "09-04", "09-05"]
files_modified:
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "GitHub Actions CI runs mix test on push and PR to main"
    - "GitHub Actions CI runs node --test for sidecar tests on push and PR to main"
    - "CI installs OTP 28, Elixir 1.19, and Node.js 22"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI workflow for Elixir and Node.js tests"
      contains: "erlef/setup-beam"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "test/"
      via: "mix test runs all Elixir tests"
      pattern: "mix test"
    - from: ".github/workflows/ci.yml"
      to: "sidecar/test/"
      via: "node --test runs all sidecar tests"
      pattern: "node --test|npm test"
---

<objective>
Create GitHub Actions CI workflow that runs both Elixir and Node.js sidecar tests on push and PR to main.

Purpose: Satisfies the CI portion of the locked decision "GitHub Actions CI runs both Elixir (mix test) and Node.js sidecar tests on push/PR". This is the final piece that makes the test infrastructure operational for ongoing development. CI only, no pre-commit hooks per locked decision.

Output: .github/workflows/ci.yml
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-testing/09-RESEARCH.md

@mix.exs
@sidecar/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with two parallel jobs: elixir-tests and sidecar-tests.

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  elixir-tests:
    runs-on: ubuntu-latest
    env:
      MIX_ENV: test
    steps:
      - uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: '28'
          elixir-version: '1.19'

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Compile
        run: mix compile --warnings-as-errors

      - name: Run tests
        run: mix test --exclude skip

  sidecar-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sidecar
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: node --test test/
```

Key decisions:
- `--exclude skip` on mix test: excludes tests tagged with :skip (like the known circular walk_to_root bug if it's tagged)
- `npm ci` instead of `npm install`: deterministic installs from lockfile, better for CI
- Two separate jobs run in parallel (not sequential)
- No pre-commit hooks per locked decision
- Uses erlef/setup-beam@v1 (not deprecated actions/setup-elixir)
- Uses actions/setup-node@v4
- Cache for Elixir deps/_build to speed up subsequent runs

Create the .github/workflows/ directory if it doesn't exist: `mkdir -p .github/workflows` (the executor should handle this via the Write tool creating the file).

Do NOT add: code formatting checks, dialyzer, credo, or other static analysis. This phase is about test infrastructure only.
  </action>
  <verify>
Verify the file exists and is valid YAML: read the file back and check structure.
Verify the workflow would trigger on push to main and PRs.
Optionally: `cd C:/Users/nrosq/src/AgentCom && git add .github/workflows/ci.yml` to confirm it's trackable.
Note: Cannot verify CI actually runs without pushing to GitHub, but the workflow file should be syntactically valid YAML.
  </verify>
  <done>
.github/workflows/ci.yml exists with two parallel jobs: elixir-tests (OTP 28 + Elixir 1.19 + mix test) and sidecar-tests (Node 22 + node --test).
Triggers on push to main and pull requests to main.
Uses dep caching for faster subsequent runs.
No pre-commit hooks.
  </done>
</task>

</tasks>

<verification>
1. .github/workflows/ci.yml exists with valid YAML
2. Two jobs: elixir-tests and sidecar-tests
3. Correct tool versions: OTP 28, Elixir 1.19, Node 22
4. Triggers: push to main, PR to main
5. Uses erlef/setup-beam (not deprecated alternative)
6. No pre-commit hooks anywhere in the repo
</verification>

<success_criteria>
- CI workflow runs Elixir tests and sidecar tests in parallel
- Uses correct toolchain versions matching production
- Dep caching enabled for faster subsequent runs
- Triggers on push and PR to main only
</success_criteria>

<output>
After completion, create `.planning/phases/09-testing/09-06-SUMMARY.md`
</output>

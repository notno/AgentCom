---
phase: 09-testing
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - test/smoke/basic_test.exs
  - test/smoke/failure_test.exs
  - test/smoke/scale_test.exs
  - test/test_helper.exs
  - .github/workflows/ci.yml
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Running mix test --exclude skip passes with 0 failures"
    - "Smoke tests are excluded from default mix test runs"
    - "Smoke tests can still be run explicitly with mix test --only smoke"
    - "CI workflow excludes both :skip and :smoke tags"
  artifacts:
    - path: "test/smoke/basic_test.exs"
      provides: "Smoke test with @moduletag :smoke"
      contains: "@moduletag :smoke"
    - path: "test/smoke/failure_test.exs"
      provides: "Smoke test with @moduletag :smoke"
      contains: "@moduletag :smoke"
    - path: "test/smoke/scale_test.exs"
      provides: "Smoke test with @moduletag :smoke"
      contains: "@moduletag :smoke"
    - path: "test/test_helper.exs"
      provides: "ExUnit config excluding :smoke"
      contains: "exclude: [:skip, :smoke]"
    - path: ".github/workflows/ci.yml"
      provides: "CI excluding smoke tests"
      contains: "--exclude smoke"
  key_links:
    - from: "test/test_helper.exs"
      to: "test/smoke/*.exs"
      via: "ExUnit exclude list matches @moduletag"
      pattern: "exclude:.*:smoke"
---

<objective>
Fix smoke test exclusion so `mix test --exclude skip` passes with 0 failures.

Purpose: Smoke tests require a running hub server and should not run during standard `mix test`. They are currently untagged, causing 5 econnrefused failures in CI and local test runs.

Output: All smoke test modules tagged with `@moduletag :smoke`, test_helper.exs excludes `:smoke` by default, CI workflow updated to also exclude `:smoke`.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-testing/09-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tag smoke tests and update exclusion config</name>
  <files>
    test/smoke/basic_test.exs
    test/smoke/failure_test.exs
    test/smoke/scale_test.exs
    test/test_helper.exs
    .github/workflows/ci.yml
  </files>
  <action>
1. Add `@moduletag :smoke` to each smoke test module, placed immediately after `use ExUnit.Case, async: false`:
   - test/smoke/basic_test.exs: Add `@moduletag :smoke` on line after `use ExUnit.Case, async: false` (line 12)
   - test/smoke/failure_test.exs: Add `@moduletag :smoke` on line after `use ExUnit.Case, async: false` (line 13)
   - test/smoke/scale_test.exs: Add `@moduletag :smoke` on line after `use ExUnit.Case, async: false` (line 13)

2. Update test/test_helper.exs line 18: Change `ExUnit.start(exclude: [:skip], capture_log: true)` to `ExUnit.start(exclude: [:skip, :smoke], capture_log: true)`

3. Update .github/workflows/ci.yml line 39: Change `mix test --exclude skip` to `mix test --exclude skip --exclude smoke`

These changes ensure smoke tests are excluded from default runs but can be explicitly invoked with `mix test --only smoke` when a hub server is running.
  </action>
  <verify>
Run `mix test --exclude skip` and confirm 0 failures (all smoke tests excluded).
Run `mix test --exclude skip 2>&1 | grep -c "smoke"` confirms no smoke test modules appear in output.
Confirm each smoke test file contains `@moduletag :smoke` with grep.
  </verify>
  <done>
`mix test --exclude skip` passes with 0 failures. All smoke test modules are tagged `:smoke`. ExUnit.start excludes both `:skip` and `:smoke`. CI workflow excludes both tags. Smoke tests remain runnable via `mix test --only smoke`.
  </done>
</task>

</tasks>

<verification>
1. `mix test --exclude skip` -- 0 failures, all unit + integration tests pass
2. `grep -r "@moduletag :smoke" test/smoke/` -- returns 3 matches (one per smoke test file)
3. `grep "exclude.*:smoke" test/test_helper.exs` -- confirms :smoke in exclude list
4. `grep "exclude smoke" .github/workflows/ci.yml` -- confirms CI excludes smoke tests
</verification>

<success_criteria>
- `mix test --exclude skip` exits with 0 failures
- All 3 smoke test modules contain `@moduletag :smoke`
- test_helper.exs excludes both `:skip` and `:smoke`
- CI workflow excludes both `:skip` and `:smoke`
- Smoke tests remain independently runnable with `mix test --only smoke`
</success_criteria>

<output>
After completion, create `.planning/phases/09-testing/09-07-SUMMARY.md`
</output>

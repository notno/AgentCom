---
phase: 09-testing
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - test/agent_com/auth_test.exs
  - test/agent_com/presence_test.exs
  - test/agent_com/router_test.exs
  - test/agent_com/mailbox_test.exs
  - test/agent_com/channels_test.exs
  - test/agent_com/config_test.exs
  - test/agent_com/threads_test.exs
  - test/agent_com/analytics_test.exs
  - test/agent_com/message_history_test.exs
  - test/agent_com/message_test.exs
  - test/agent_com/reaper_test.exs
autonomous: true

must_haves:
  truths:
    - "Auth unit tests cover token generation, verification, revocation, and persistence across restart"
    - "All remaining GenServer modules have at least basic tests covering init and key operations"
    - "Known pitfalls (String.to_integer crashes, Threads walk_to_root infinite recursion) have dedicated test cases"
  artifacts:
    - path: "test/agent_com/auth_test.exs"
      provides: "Auth GenServer unit tests"
      contains: "AgentCom.AuthTest"
    - path: "test/agent_com/mailbox_test.exs"
      provides: "Mailbox GenServer unit tests"
      contains: "AgentCom.MailboxTest"
    - path: "test/agent_com/channels_test.exs"
      provides: "Channels GenServer unit tests"
      contains: "AgentCom.ChannelsTest"
    - path: "test/agent_com/threads_test.exs"
      provides: "Threads GenServer unit tests including walk_to_root edge case"
      contains: "AgentCom.ThreadsTest"
    - path: "test/agent_com/message_test.exs"
      provides: "Message struct unit tests"
      contains: "AgentCom.MessageTest"
  key_links:
    - from: "test/agent_com/auth_test.exs"
      to: "test/support/dets_helpers.ex"
      via: "setup block calls full_test_setup"
      pattern: "DetsHelpers\\.full_test_setup"
    - from: "test/agent_com/threads_test.exs"
      to: "lib/agent_com/threads.ex"
      via: "tests walk_to_root with circular reply chain"
      pattern: "walk_to_root|circular"
---

<objective>
Write unit tests for Auth (deep coverage) and all remaining GenServer modules (basic coverage per tiered priority). Includes dedicated test cases for known pitfalls identified in research.

Purpose: Satisfies TEST-01 (unit tests for every GenServer module). Auth gets deep coverage as a critical-path module. Lower-risk modules (Analytics, Threads, MessageHistory, etc.) get basic init + key operations coverage. Known bugs get documented through failing-scenario tests.

Output: 11 test files covering all remaining GenServer modules and the Message struct
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-testing/09-RESEARCH.md
@.planning/phases/09-testing/09-01-SUMMARY.md

@lib/agent_com/auth.ex
@lib/agent_com/presence.ex
@lib/agent_com/router.ex
@lib/agent_com/mailbox.ex
@lib/agent_com/channels.ex
@lib/agent_com/config.ex
@lib/agent_com/threads.ex
@lib/agent_com/analytics.ex
@lib/agent_com/message_history.ex
@lib/agent_com/message.ex
@lib/agent_com/reaper.ex
@test/support/dets_helpers.ex
@test/support/test_factory.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Auth deep tests and Presence, Router, Mailbox, Channels tests</name>
  <files>
    test/agent_com/auth_test.exs
    test/agent_com/presence_test.exs
    test/agent_com/router_test.exs
    test/agent_com/mailbox_test.exs
    test/agent_com/channels_test.exs
  </files>
  <action>
All test files use `use ExUnit.Case, async: false`. All use DetsHelpers.full_test_setup/full_test_teardown in setup/on_exit. Stop Scheduler in setup for all these tests to prevent interference.

**Auth tests** (`test/agent_com/auth_test.exs`) -- DEEP coverage:
- generate/1 returns {:ok, token_string} and token is a hex string
- verify/1 with valid token returns {:ok, agent_id}
- verify/1 with invalid token returns :error
- revoke/1 removes the token, verify after revoke returns :error
- generate/1 for same agent_id replaces previous token
- Multiple agents can have separate tokens simultaneously
- Token persistence: generate token, restart Auth GenServer (terminate+restart via Supervisor), verify token still works. This tests DETS/JSON persistence.
- list/0 or agents/0 returns all registered agent_ids (check actual API name)

**Presence tests** (`test/agent_com/presence_test.exs`) -- basic:
- register/2 adds agent to presence list
- list/0 returns all registered agents
- unregister/1 removes agent
- update_status/2 changes agent status
- get/1 returns agent info or nil for unregistered

**Router tests** (`test/agent_com/router_test.exs`) -- basic:
- route/1 with direct message to online agent (register a process in AgentRegistry first)
- route/1 with direct message to offline agent (queues to mailbox)
- route/1 with broadcast message (no "to" field)
Read router.ex to understand exact API -- it may take a Message struct.

**Mailbox tests** (`test/agent_com/mailbox_test.exs`) -- basic:
- enqueue/2 stores a message for an agent
- poll/2 returns stored messages with sequence numbers
- ack/2 removes acknowledged messages
- poll after ack returns only unacknowledged messages
- Empty mailbox returns empty list

**Channels tests** (`test/agent_com/channels_test.exs`) -- basic:
- create/1 creates a new channel
- subscribe/2 adds agent to channel
- unsubscribe/2 removes agent
- publish/2 stores message in channel history
- history/1 returns published messages
- list/0 returns all channels

For each file, read the corresponding source module FIRST to get the exact public API signatures and return values. Do not assume -- the API names and arities may differ from what's listed above.
  </action>
  <verify>
Run each test file individually with --trace:
`MIX_ENV=test mix test test/agent_com/auth_test.exs --trace`
`MIX_ENV=test mix test test/agent_com/presence_test.exs --trace`
`MIX_ENV=test mix test test/agent_com/router_test.exs --trace`
`MIX_ENV=test mix test test/agent_com/mailbox_test.exs --trace`
`MIX_ENV=test mix test test/agent_com/channels_test.exs --trace`
All pass. Auth has >= 7 tests. Others have >= 3 tests each.
  </verify>
  <done>
Auth has deep test coverage (generate, verify, revoke, persistence, multiple agents).
Presence, Router, Mailbox, Channels each have basic tests covering init and key operations.
All tests use DETS isolation and pass cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write Config, Threads, Analytics, MessageHistory, Message, Reaper tests</name>
  <files>
    test/agent_com/config_test.exs
    test/agent_com/threads_test.exs
    test/agent_com/analytics_test.exs
    test/agent_com/message_history_test.exs
    test/agent_com/message_test.exs
    test/agent_com/reaper_test.exs
  </files>
  <action>
All test files use `use ExUnit.Case, async: false`. Stop Scheduler in setup.

**Config tests** (`test/agent_com/config_test.exs`) -- basic:
- get/1 returns default value for unset key (heartbeat_interval_ms defaults)
- put/2 stores a value, get/1 retrieves it
- put/2 overwrites previous value
- Persistence: put a value, restart Config GenServer, get returns the stored value

**Threads tests** (`test/agent_com/threads_test.exs`) -- basic + known bug test:
- index/1 stores a message (create via AgentCom.Message.new)
- get_thread/1 returns the thread containing a message
- get_replies/1 returns direct replies
- get_root/1 returns root of reply chain
- Reply chain: index parent message, then index child with reply_to pointing to parent. get_thread returns both in order.
- **KNOWN BUG TEST (Pitfall #5):** Create a circular reply chain: message A with reply_to=B, message B with reply_to=A. Call get_thread or get_root on A. This tests the infinite recursion risk in walk_to_root/1. Mark this test with `@tag :known_bug` or document with a comment that this test demonstrates the circular reference issue. If it hangs, it confirms the bug. Use `Task.async` with a timeout to prevent the test suite from hanging forever:
  ```elixir
  test "walk_to_root handles circular reply chains without infinite loop" do
    # This test documents a known bug: circular reply chains cause infinite recursion
    # If this test passes, the bug has been fixed. If it times out, the bug is confirmed.
    task = Task.async(fn ->
      AgentCom.Threads.get_root("msg-a")
    end)
    case Task.yield(task, 2000) || Task.shutdown(task) do
      {:ok, _result} -> :ok  # Bug fixed
      nil -> flunk("walk_to_root infinite loop on circular reply chain (known bug)")
    end
  end
  ```
  Tag with `@tag :skip` if it's a known unresolved bug that would fail CI. Document why.

**Analytics tests** (`test/agent_com/analytics_test.exs`) -- basic:
- record_message/1 increments counters (read source for exact API)
- get_stats/1 returns agent stats
- Analytics uses ETS (volatile), so no DETS path needed -- but still stop Scheduler

**MessageHistory tests** (`test/agent_com/message_history_test.exs`) -- basic:
- store/1 saves a message
- recent/0 or list/0 returns stored messages
- Respects max limit (10k) -- test with a few messages, verify retrieval

**Message tests** (`test/agent_com/message_test.exs`) -- basic:
- This tests the Message struct module, NOT a GenServer. Does not need DETS helpers.
- `use ExUnit.Case, async: true` -- this CAN be async since it's a pure data module
- Message.new/1 creates struct with id, timestamp, defaults
- Message.to_json/1 converts to string-keyed map
- Message.from_json/1 converts from string-keyed map back to struct
- Round-trip: new -> to_json -> from_json preserves data

**Reaper tests** (`test/agent_com/reaper_test.exs`) -- basic:
- Read reaper.ex to understand what it does (likely periodic cleanup)
- Test that it starts without errors
- If it has a sweep function, test that calling it doesn't crash on empty state

For each file, READ THE SOURCE MODULE FIRST. Get exact function names, arities, return types. Do not guess.
  </action>
  <verify>
Run all test files:
`MIX_ENV=test mix test test/agent_com/config_test.exs test/agent_com/threads_test.exs test/agent_com/analytics_test.exs test/agent_com/message_history_test.exs test/agent_com/message_test.exs test/agent_com/reaper_test.exs --trace`
All pass (except possibly the known-bug circular chain test which should be tagged :skip if it fails).
  </verify>
  <done>
Config, Threads, Analytics, MessageHistory, Message, Reaper all have basic unit tests.
Threads test includes documented test case for walk_to_root circular reply chain (known bug).
Message tests run with async: true (pure data module, no GenServer).
All tests use DETS isolation where applicable and pass cleanly.
  </done>
</task>

</tasks>

<verification>
1. `MIX_ENV=test mix test test/agent_com/` -- all unit tests pass
2. Every GenServer module has at least one test file
3. Auth has >= 7 deep tests
4. Threads test includes circular reply chain edge case
5. Message tests use async: true (no GenServer dependency)
6. All tests use DETS isolation
</verification>

<success_criteria>
- All 11 test files exist and pass
- Auth has deep coverage (generate, verify, revoke, persistence, multi-agent)
- Known pitfalls from research have dedicated test cases (circular walk_to_root)
- Every GenServer module in the codebase has a corresponding test file
- Tests correctly handle Scheduler interference (stopped in setup)
</success_criteria>

<output>
After completion, create `.planning/phases/09-testing/09-03-SUMMARY.md`
</output>

---
phase: 17-enriched-task-format
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/agent_com/task_queue.ex
  - lib/agent_com/validation/schemas.ex
  - lib/agent_com/validation.ex
  - test/agent_com/task_queue_test.exs
  - test/agent_com/validation_test.exs
autonomous: true

must_haves:
  truths:
    - "A task submitted with context fields (repo, branch, file_hints) stores them in the task map"
    - "A task submitted with success_criteria and verification_steps stores them in the task map"
    - "A task submitted without enrichment fields gets nil/empty-list defaults and works identically to v1.0/v1.1 tasks"
    - "Invalid enrichment fields (wrong types) are rejected with validation errors at submission time"
    - "Verification steps exceeding the soft limit (10) produce a warning in the response but still succeed"
  artifacts:
    - path: "lib/agent_com/task_queue.ex"
      provides: "Extended task map with enrichment fields in submit handler"
      contains: "file_hints"
    - path: "lib/agent_com/validation/schemas.ex"
      provides: "Extended post_task schema with optional enrichment fields"
      contains: "file_hints"
    - path: "lib/agent_com/validation.ex"
      provides: "Nested validation for file_hints list items"
      contains: "validate_file_hints"
  key_links:
    - from: "lib/agent_com/validation/schemas.ex"
      to: "lib/agent_com/validation.ex"
      via: "Schema defines types, Validation enforces them"
      pattern: "post_task.*file_hints"
    - from: "lib/agent_com/task_queue.ex"
      to: "lib/agent_com/validation/schemas.ex"
      via: "TaskQueue reads validated params containing enrichment fields"
      pattern: "file_hints|success_criteria|verification_steps|complexity_tier"
---

<objective>
Add enrichment fields to the task data model and extend input validation to cover them.

Purpose: TASK-01, TASK-02, TASK-03, TASK-04 require tasks to carry context, success criteria, verification steps, and complexity tier. This plan adds the fields to the task map at submission time and ensures they are validated through the existing Phase 12 validation infrastructure. Plan 03 will wire the Complexity module (from Plan 01) and propagate these fields through the pipeline.

Output: Extended TaskQueue.submit with enrichment fields, extended validation schemas, and tests.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-enriched-task-format/17-RESEARCH.md
@lib/agent_com/task_queue.ex
@lib/agent_com/validation/schemas.ex
@lib/agent_com/validation.ex
@lib/agent_com/endpoint.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend validation schemas and add nested file_hints/verification_steps validation</name>
  <files>lib/agent_com/validation/schemas.ex, lib/agent_com/validation.ex, test/agent_com/validation_test.exs</files>
  <action>
    **In `lib/agent_com/validation/schemas.ex`:**

    1. Add enrichment fields to the `post_task` HTTP schema's `optional` map:
       - `"repo" => :string` -- explicit repo override (per locked decision: inherit-plus-override)
       - `"branch" => :string` -- optional source branch (discretion: nil means always-from-main)
       - `"file_hints" => {:list, :map}` -- list of `%{"path" => string, "reason" => string}`
       - `"success_criteria" => {:list, :string}` -- list of plain testable condition strings
       - `"verification_steps" => {:list, :map}` -- list of `%{"type" => string, "target" => string, "description" => string(optional)}`
       - `"complexity_tier" => :string` -- one of "trivial", "standard", "complex", "unknown"

    2. Add a new `@length_limits` entry: `"repo" => 512` for repo URL length limit.

    **In `lib/agent_com/validation.ex`:**

    3. Add a new public function `validate_enrichment_fields/1` that performs nested validation on enrichment fields AFTER the standard schema validation passes. This function:
       - Validates each item in `file_hints` has a `"path"` key that is a non-empty string. `"reason"` is optional but if present must be a string.
       - Validates each item in `verification_steps` has `"type"` (non-empty string) and `"target"` (non-empty string). `"description"` is optional string.
       - Validates `complexity_tier` is one of "trivial", "standard", "complex", "unknown" if present.
       - Returns `{:ok, params}` or `{:error, errors}` with standard error map format.

    4. Add a `verify_step_soft_limit/1` function that checks if `length(verification_steps) > 10` and returns either `:ok` or `{:warn, "Task has N verification steps (soft limit: 10). Consider splitting into smaller tasks."}`.

    **In `test/agent_com/validation_test.exs`:**

    5. Add test cases in a new `describe "enrichment field validation"` block:
       - Valid task with all enrichment fields passes validation
       - Valid task without enrichment fields passes (backward compat)
       - Invalid file_hints (missing path) returns error
       - Invalid verification_steps (missing type) returns error
       - Invalid complexity_tier ("mega") returns error
       - Valid complexity_tier values ("trivial", "standard", "complex", "unknown") all pass
       - Verification steps at soft limit (10) passes with no warning
       - Verification steps exceeding soft limit (11) returns warning

    Do NOT change the core `validate_against_schema` logic -- enrichment validation is a separate pass called by the endpoint/TaskQueue after standard schema validation.
  </action>
  <verify>
    `mix test test/agent_com/validation_test.exs` -- all tests pass including new enrichment tests.
    `mix compile --warnings-as-errors` -- no warnings.
  </verify>
  <done>
    post_task schema includes all 6 enrichment optional fields. Nested validation catches invalid file_hints, verification_steps, and complexity_tier. Soft limit warning works at threshold 10. All new and existing validation tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add enrichment fields to TaskQueue.submit and extend format_task</name>
  <files>lib/agent_com/task_queue.ex, lib/agent_com/endpoint.ex, test/agent_com/task_queue_test.exs</files>
  <action>
    **In `lib/agent_com/task_queue.ex`:**

    1. In `handle_call({:submit, params}, _from, state)` (line ~197), add enrichment fields to the task map AFTER the existing 19 fields. Use `Map.get(params, :key, Map.get(params, "key", default))` pattern for both atom and string key support:
       - `repo: Map.get(params, :repo, Map.get(params, "repo", nil))` -- nil means use agent's default_repo at assignment time
       - `branch: Map.get(params, :branch, Map.get(params, "branch", nil))` -- nil means always-from-main
       - `file_hints: Map.get(params, :file_hints, Map.get(params, "file_hints", []))` -- list of %{path, reason}
       - `success_criteria: Map.get(params, :success_criteria, Map.get(params, "success_criteria", []))` -- list of strings
       - `verification_steps: Map.get(params, :verification_steps, Map.get(params, "verification_steps", []))` -- list of %{type, target, description}
       - `complexity: nil` -- placeholder, will be set by Plan 03 when Complexity module is wired in

    2. Do NOT call AgentCom.Complexity.build here yet -- that wiring happens in Plan 03 to avoid a compile dependency before the module exists.

    **In `lib/agent_com/endpoint.ex`:**

    3. In the `POST /api/tasks` route (line ~849), after `Validation.validate_http(:post_task, params)` succeeds, call `Validation.validate_enrichment_fields(params)`. If it returns `{:error, errors}`, return validation error. Extract the enrichment fields from params and include them in `task_params` passed to `TaskQueue.submit/1`:
       ```
       task_params = %{
         # ... existing fields ...
         repo: params["repo"],
         branch: params["branch"],
         file_hints: params["file_hints"] || [],
         success_criteria: params["success_criteria"] || [],
         verification_steps: params["verification_steps"] || []
       }
       ```

    4. Also in the POST /api/tasks response, include a `"warnings"` list if `Validation.verify_step_soft_limit(params)` returns a warning. The response should include `"warnings": ["Task has N verification steps..."]` alongside the existing fields.

    5. In the `format_task/1` private function (line ~1265), add the enrichment fields to the output map. Use `Map.get(task, :field, default)` to handle old tasks that lack these keys:
       ```
       "repo" => Map.get(task, :repo),
       "branch" => Map.get(task, :branch),
       "file_hints" => Map.get(task, :file_hints, []),
       "success_criteria" => Map.get(task, :success_criteria, []),
       "verification_steps" => Map.get(task, :verification_steps, []),
       "complexity" => format_complexity(Map.get(task, :complexity))
       ```

    6. Add a `format_complexity/1` helper that handles nil (old tasks) and map (new tasks):
       ```
       defp format_complexity(nil), do: nil
       defp format_complexity(c) when is_map(c) do
         %{
           "effective_tier" => to_string(Map.get(c, :effective_tier)),
           "explicit_tier" => case Map.get(c, :explicit_tier) do nil -> nil; t -> to_string(t) end,
           "source" => to_string(Map.get(c, :source)),
           "inferred" => case Map.get(c, :inferred) do
             nil -> nil
             inf -> %{
               "tier" => to_string(Map.get(inf, :tier)),
               "confidence" => Map.get(inf, :confidence)
             }
           end
         }
       end
       ```

    **In `test/agent_com/task_queue_test.exs`:**

    7. Add a new `describe "enriched task submission"` block with tests:
       - Submit task with all enrichment fields, verify they are stored and retrievable via get/1
       - Submit task without enrichment fields (backward compat), verify defaults (nil repo, nil branch, empty lists)
       - Verify old-format tasks (simulated by reading a task and confirming Map.get works for missing keys)
  </action>
  <verify>
    `mix test test/agent_com/task_queue_test.exs` -- all tests pass including new enrichment tests.
    `mix test test/agent_com/validation_test.exs` -- still passing.
    `mix compile --warnings-as-errors` -- no warnings.
  </verify>
  <done>
    TaskQueue.submit stores enrichment fields in the task map. Endpoint POST /api/tasks validates enrichment fields and passes them through. format_task includes enrichment fields with backward-compatible defaults. All existing and new tests pass.
  </done>
</task>

</tasks>

<verification>
- `mix test` -- full test suite passes (no regressions)
- Submit a task via HTTP with enrichment fields, GET it back, verify all fields present
- Submit a task via HTTP without enrichment fields, GET it back, verify defaults
- Submit a task with invalid file_hints, verify 422 validation error
</verification>

<success_criteria>
- TASK-01: Tasks carry structured context (repo, branch, file_hints) as optional fields -- stored in task map
- TASK-02: Tasks carry success_criteria as optional fields -- stored in task map
- TASK-03: Tasks carry verification_steps as optional fields -- stored in task map
- TASK-04 partial: complexity_tier accepted and validated but not yet wired to heuristic engine (Plan 03)
- Backward compat: Tasks without enrichment fields work identically to v1.0/v1.1
- Validation: Invalid enrichment fields rejected with errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-enriched-task-format/17-02-SUMMARY.md`
</output>

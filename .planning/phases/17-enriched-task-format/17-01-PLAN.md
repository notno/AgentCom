---
phase: 17-enriched-task-format
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/agent_com/complexity.ex
  - test/agent_com/complexity_test.exs
autonomous: true

must_haves:
  truths:
    - "A task with explicit complexity tier 'standard' returns effective_tier :standard with source :explicit"
    - "A task without explicit tier gets an inferred classification with confidence score between 0.0 and 1.0"
    - "Heuristic always runs even when explicit tier is provided, producing an inferred result alongside the explicit one"
    - "Unknown tier is supported as a valid explicit tier and treated conservatively"
  artifacts:
    - path: "lib/agent_com/complexity.ex"
      provides: "Complexity heuristic engine with build/1 and infer/1 functions"
      exports: ["build", "infer"]
      contains: "defmodule AgentCom.Complexity"
    - path: "test/agent_com/complexity_test.exs"
      provides: "Unit tests for complexity heuristic"
      contains: "describe"
  key_links:
    - from: "lib/agent_com/complexity.ex"
      to: "lib/agent_com/task_queue.ex"
      via: "Called by TaskQueue.submit to build complexity map"
      pattern: "AgentCom\\.Complexity\\.build"
---

<objective>
Build the complexity heuristic engine as a pure-function module using TDD.

Purpose: TASK-04 and TASK-05 require complexity classification. The heuristic engine infers tier from task content when submitter does not specify, and always runs alongside explicit tags for observability and disagreement logging. This is the foundation that Plan 03 will wire into the task pipeline.

Output: `lib/agent_com/complexity.ex` with full test coverage in `test/agent_com/complexity_test.exs`.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-enriched-task-format/17-RESEARCH.md
@lib/agent_com/task_queue.ex
</context>

<feature>
  <name>Complexity Heuristic Engine</name>
  <files>lib/agent_com/complexity.ex, test/agent_com/complexity_test.exs</files>
  <behavior>
    AgentCom.Complexity.build/1 takes a task params map and returns a complexity classification map.

    Per locked decisions:
    - Four tiers: :trivial, :standard, :complex, :unknown
    - Explicit submitter tag always wins over heuristic inference
    - Heuristic engine always runs, even when submitter provides explicit tier (for observability)
    - Inferred complexity includes a confidence score (0.0-1.0)
    - :unknown tier gets conservative routing (treated as standard or higher)

    Per research discretion recommendations, use four signals:
    1. Word count of description (short = trivial, medium = standard, long = complex)
    2. File hint count (0 = trivial signal, 1-3 = standard, 4+ = complex)
    3. Verification step count (0 = trivial signal, 1-3 = standard, 4+ = complex)
    4. Keyword detection (words like "refactor", "architect", "migration", "redesign" = complex signal; "fix typo", "update readme", "bump version" = trivial signal)

    Cases:
    - build(%{"complexity_tier" => "standard"}) -> %{effective_tier: :standard, explicit_tier: :standard, inferred: %{tier: ..., confidence: ..., signals: ...}, source: :explicit}
    - build(%{"description" => "fix typo in readme"}) -> %{effective_tier: :trivial, explicit_tier: nil, inferred: %{tier: :trivial, confidence: 0.9, signals: ...}, source: :inferred}
    - build(%{"description" => "Refactor the entire authentication system to support OAuth2 with multiple providers, migrate existing user tokens, and update all API endpoints", "file_hints" => [%{"path" => "a.ex"}, %{"path" => "b.ex"}, %{"path" => "c.ex"}, %{"path" => "d.ex"}, %{"path" => "e.ex"}]}) -> %{effective_tier: :complex, ...}
    - build(%{"complexity_tier" => "trivial", "description" => "Refactor the entire auth system..."}) -> %{effective_tier: :trivial, source: :explicit, inferred: %{tier: :complex, ...}}
    - build(%{"complexity_tier" => "unknown"}) -> %{effective_tier: :unknown, source: :explicit, ...}
    - build(%{}) -> %{effective_tier: :unknown, explicit_tier: nil, inferred: %{tier: :unknown, confidence: 0.0, ...}, source: :inferred}

    Confidence is clamped to [0.0, 1.0].
  </behavior>
  <implementation>
    Create `lib/agent_com/complexity.ex` as a pure-function module (no GenServer).

    Module structure:
    - `@valid_explicit_tiers [:trivial, :standard, :complex, :unknown]`
    - `build(params)` -- public entry point. Extracts explicit tier from params, runs infer, returns combined map.
    - `infer(params)` -- public for testing. Gathers signals, classifies, returns `%{tier: atom, confidence: float, signals: map}`.
    - `gather_signals(params)` -- private. Returns `%{word_count: int, file_count: int, verification_count: int, keywords: list}`.
    - `classify(signals)` -- private. Scores signals, picks tier, computes confidence.
    - `parse_explicit_tier(params)` -- private. Handles both atom and string keys, validates against @valid_explicit_tiers.

    Signal thresholds (per research recommendation):
    - Word count: <10 = trivial signal, 10-50 = standard, >50 = complex
    - File count: 0 = trivial, 1-3 = standard, 4+ = complex
    - Verification count: 0 = trivial, 1-3 = standard, 4+ = complex
    - Keywords: scan description for trivial/complex keyword lists

    Classification: Score each signal as :trivial/:standard/:complex, majority wins. Confidence = agreement ratio (e.g., 4/4 signals agree = 1.0, 3/4 = 0.75). If no signals available (empty params), return :unknown with 0.0 confidence.

    Emit telemetry when explicit and inferred disagree:
    `:telemetry.execute([:agent_com, :complexity, :disagreement], %{}, %{task_description: ..., explicit: ..., inferred: ...})`
  </implementation>
</feature>

<verification>
- `mix test test/agent_com/complexity_test.exs` -- all tests pass
- `mix compile --warnings-as-errors` -- no warnings
</verification>

<success_criteria>
- AgentCom.Complexity.build/1 correctly classifies tasks with explicit tiers, inferred tiers, and mixed scenarios
- Confidence scores are clamped to [0.0, 1.0]
- Heuristic always runs even when explicit tier is provided
- :unknown tier is handled correctly
- All test cases pass including edge cases (empty params, invalid tier strings, mixed atom/string keys)
</success_criteria>

<output>
After completion, create `.planning/phases/17-enriched-task-format/17-01-SUMMARY.md`
</output>

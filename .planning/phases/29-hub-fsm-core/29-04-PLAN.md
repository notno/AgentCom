---
phase: 29-hub-fsm-core
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/agent_com/dashboard.ex
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Dashboard displays a transition timeline showing last 20 transitions with from/to states, reason, timestamp, and duration"
    - "Timeline loads from /api/hub/history on page load"
    - "Timeline updates in real-time when hub_fsm_state_change WebSocket events arrive"
  artifacts:
    - path: "lib/agent_com/dashboard.ex"
      provides: "Transition timeline HTML section and JavaScript fetch/render/update logic"
      contains: "hub-fsm-timeline"
  key_links:
    - from: "dashboard.ex (JS)"
      to: "/api/hub/history"
      via: "fetch on load"
      pattern: "fetch.*api/hub/history"
    - from: "dashboard.ex (JS)"
      to: "WebSocket hub_fsm_state event"
      via: "prepend to timeline on state change"
      pattern: "hub_fsm_state.*timeline"
---

<objective>
Close the single gap from Phase 29 verification: dashboard missing transition timeline visualization.

Purpose: FSM-05 requires "Dashboard shows current FSM state, transition timeline, and state duration metrics in real time." The current dashboard shows state, cycles, transitions, and last change but does NOT display a timeline of transitions. The API endpoint GET /api/hub/history already returns transition data — the dashboard just needs to consume and display it.

Output: Updated dashboard.ex with timeline section and JS logic.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-hub-fsm-core/29-02-SUMMARY.md
@lib/agent_com/dashboard.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add transition timeline HTML and JavaScript to Hub FSM dashboard panel</name>
  <files>lib/agent_com/dashboard.ex</files>
  <action>
This is a single-file change to lib/agent_com/dashboard.ex — HTML and inline JavaScript only.

**Part A: Add HTML timeline section (after line 1009, before the closing panel div at line 1010-1011)**

Insert a transition timeline section between the pause button div and the closing panel div. Structure:

```html
<div id="hub-fsm-timeline-section" style="margin-top: 12px; border-top: 1px solid #2a2a3a; padding-top: 8px;">
  <div style="font-size: 0.85em; color: #888; margin-bottom: 6px;">Transition Timeline</div>
  <div id="hub-fsm-timeline" style="max-height: 280px; overflow-y: auto; font-size: 0.8em;"></div>
  <div id="hub-fsm-timeline-empty" class="empty-state" style="font-size: 0.8em;">No transitions recorded</div>
</div>
```

**Part B: Add JavaScript functions (near the existing renderHubFSM function, around line 2360)**

Add three JS functions:

1. `fetchHubFSMTimeline()` — fetches GET /api/hub/history?limit=20, parses JSON, calls renderHubFSMTimeline(data.transitions).

2. `renderHubFSMTimeline(transitions)` — renders the transitions array into #hub-fsm-timeline. Each transition is a row showing:
   - A colored dot for the to_state (use existing hubFsmStateColors map)
   - from_state arrow to_state (e.g., "resting -> executing")
   - reason text (truncated to ~40 chars if long)
   - relative timestamp (use existing formatRelativeTime function, the timestamp field is epoch ms)
   - Duration: compute from consecutive timestamps (current transition timestamp minus previous transition timestamp). Display as "Xs" or "Xm". For the oldest entry, show "--".

   Style each row as a compact horizontal bar:
   ```
   [dot] resting -> executing  |  queue_active  |  5s ago  |  dur: 12s
   ```
   Use a simple div-per-row layout with inline styles matching the dark dashboard theme (background: #1e1e2e borders, #e0e0e0 text, muted #888 labels). Hide the empty-state div when transitions exist, show it when empty.

3. `prependHubFSMTransition(data)` — called from the existing WebSocket hub_fsm_state case. When a hub_fsm_state event arrives with data containing fsm_state and timestamp, prepend a new row to the timeline. To get from_state, read the current first row's to_state, or use the previous hub-fsm-state element text. Trim timeline to 20 rows max (remove oldest). Also record data.reason if present (the WebSocket event may not include reason — if absent, use "tick").

**Part C: Wire up fetch on load and WebSocket updates**

1. In the existing DOMContentLoaded or initialization section (look for where the initial snapshot request happens), add a call to `fetchHubFSMTimeline()` after the WebSocket connects.

2. In the existing WebSocket message handler switch case for 'hub_fsm_state' (around line 2736-2738), add a call to `prependHubFSMTransition(ev.data)` right after `renderHubFSM(ev.data)`.

**Important implementation notes:**
- Do NOT add any external dependencies — this is pure vanilla JS + inline HTML
- Match the existing dashboard styling conventions (dark theme, #1e1e2e backgrounds, #2a2a3a borders, #e0e0e0 text)
- The /api/hub/history response shape is: `{"transitions": [{"from_state": "resting", "to_state": "executing", "reason": "queue_active", "timestamp": 1707840000000, "cycle_count": 5}]}`
- Transitions come newest-first from the API
- The WebSocket hub_fsm_state event shape is: `{type: "hub_fsm_state", data: {fsm_state: "executing", paused: false, last_state_change: 1707840000000, cycle_count: 5, timestamp: 1707840000000}}`
- The WebSocket event does NOT include from_state or reason — infer from_state from the previous timeline entry's to_state, default reason to "tick"
  </action>
  <verify>
1. `mix compile` succeeds with no errors
2. Start the server with `mix run --no-halt` and open the dashboard
3. The Hub FSM panel now has a "Transition Timeline" section below the pause button
4. If FSM has transitions, they appear as rows with colored dots, state transitions, reasons, timestamps, and durations
5. Triggering a state change (e.g., submitting a goal) adds a new row to the timeline in real-time without page refresh
  </verify>
  <done>
Dashboard Hub FSM panel displays a transition timeline that:
- Loads last 20 transitions from /api/hub/history on page load
- Shows from/to states with color-coded dots, reason, relative timestamp, and duration
- Updates in real-time via WebSocket when new state changes occur
- FSM-05 requirement fully satisfied
  </done>
</task>

</tasks>

<verification>
1. `mix compile` — no warnings or errors
2. Open dashboard in browser, Hub FSM panel shows "Transition Timeline" section
3. If no transitions exist, shows "No transitions recorded" empty state
4. After FSM runs and accumulates transitions, refresh shows timeline with colored state dots, from/to labels, reasons, timestamps, and durations
5. Open dashboard, trigger a state change via goal submission or API, verify new transition row appears at top of timeline without page refresh
6. Timeline does not exceed 20 rows
</verification>

<success_criteria>
- FSM-05 gap closed: Dashboard shows current FSM state, transition timeline, and state duration metrics in real time
- Transition timeline is populated from /api/hub/history
- Timeline updates in real-time via WebSocket
- Visual styling matches existing dashboard dark theme
</success_criteria>

<output>
After completion, create `.planning/phases/29-hub-fsm-core/29-04-SUMMARY.md`
</output>

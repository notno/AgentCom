---
phase: 29-hub-fsm-core
plan: 03
type: tdd
wave: 2
depends_on: ["29-01"]
files_modified:
  - test/agent_com/hub_fsm_test.exs
  - test/agent_com/hub_fsm/predicates_test.exs
  - test/agent_com/hub_fsm/history_test.exs
autonomous: true

must_haves:
  truths:
    - "Predicates.evaluate/2 returns correct transitions for all 2-state combinations"
    - "History module records, lists, trims, and clears transitions correctly"
    - "HubFSM GenServer starts in :resting, transitions on tick when goals exist"
    - "Pause halts all transitions; resume restarts them"
    - "Watchdog timeout forces transition to :resting"
    - "Invalid transitions are rejected"
    - "Budget exhaustion triggers transition to :resting from :executing"
  artifacts:
    - path: "test/agent_com/hub_fsm/predicates_test.exs"
      provides: "Unit tests for pure predicate functions"
      contains: "Predicates.evaluate"
    - path: "test/agent_com/hub_fsm/history_test.exs"
      provides: "Unit tests for ETS history module"
      contains: "History."
    - path: "test/agent_com/hub_fsm_test.exs"
      provides: "Integration tests for HubFSM GenServer"
      contains: "HubFSM"
  key_links:
    - from: "test/agent_com/hub_fsm/predicates_test.exs"
      to: "lib/agent_com/hub_fsm/predicates.ex"
      via: "Tests all evaluate/2 paths"
      pattern: "evaluate"
    - from: "test/agent_com/hub_fsm_test.exs"
      to: "lib/agent_com/hub_fsm.ex"
      via: "Tests GenServer lifecycle, transitions, pause/resume"
      pattern: "HubFSM\\."
---

<objective>
Comprehensive TDD test suite for the HubFSM system: pure predicate unit tests, ETS history unit tests, and GenServer integration tests covering transitions, pause/resume, watchdog, and tick-based evaluation.

Purpose: The FSM is the brain of autonomous behavior -- correctness is critical. Tests verify transition logic, timer management, pause safety, and budget integration.

Output: Three test files covering predicates, history, and GenServer integration.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-hub-fsm-core/29-01-SUMMARY.md
@lib/agent_com/hub_fsm.ex
@lib/agent_com/hub_fsm/predicates.ex
@lib/agent_com/hub_fsm/history.ex
@test/agent_com/cost_ledger_test.exs (reference pattern: GenServer testing with DETS/ETS isolation)
@test/agent_com/goal_backlog_test.exs (reference pattern: GenServer testing)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD for Predicates and History modules</name>
  <files>test/agent_com/hub_fsm/predicates_test.exs, test/agent_com/hub_fsm/history_test.exs</files>
  <action>
Create `test/agent_com/hub_fsm/predicates_test.exs`:
- `use ExUnit.Case, async: true` (pure functions, no shared state)
- `alias AgentCom.HubFSM.Predicates`

Test cases for evaluate/2:
1. `:resting` with pending_goals > 0, budget ok -> `{:transition, :executing, _reason}`
2. `:resting` with pending_goals == 0, budget ok -> `:stay`
3. `:resting` with budget_exhausted: true -> `:stay` (already resting)
4. `:resting` with pending_goals > 0, budget_exhausted: true -> `:stay` (budget overrides)
5. `:executing` with pending_goals == 0, active_goals == 0, budget ok -> `{:transition, :resting, _reason}`
6. `:executing` with pending_goals > 0, active_goals == 0, budget ok -> `:stay`
7. `:executing` with pending_goals == 0, active_goals > 0, budget ok -> `:stay`
8. `:executing` with budget_exhausted: true -> `{:transition, :resting, _reason}` (budget takes priority)
9. `:executing` with pending_goals > 0, active_goals > 0, budget ok -> `:stay`

Create `test/agent_com/hub_fsm/history_test.exs`:
- `use ExUnit.Case` (NOT async: true -- ETS named table is global)
- `alias AgentCom.HubFSM.History`
- In setup callback: call History.init_table() then History.clear() to ensure clean state. Use on_exit to call History.clear().

Test cases:
1. `init_table/0` creates the ETS table (idempotent -- calling twice doesn't crash)
2. `record/4` inserts an entry retrievable by `list/0`
3. `list/1` returns entries newest-first
4. `list/1` respects :limit option
5. `current_state/0` returns most recent `to` state
6. `current_state/0` returns nil when history is empty
7. `trim` caps history at 200 entries (insert 210 entries, verify only 200 remain)
8. `clear/0` removes all entries

RED->GREEN->REFACTOR cycle:
- Write all test cases first (RED: tests fail or don't compile)
- Verify source modules make tests pass (GREEN)
- Refactor if needed (REFACTOR)
  </action>
  <verify>
Run `mix test test/agent_com/hub_fsm/predicates_test.exs test/agent_com/hub_fsm/history_test.exs --trace`. All tests pass.
  </verify>
  <done>
9 predicate tests and 8 history tests pass. All 2-state transition paths are covered. History ETS operations are verified including init, record, list, current_state, trim, and clear.
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD for HubFSM GenServer integration</name>
  <files>test/agent_com/hub_fsm_test.exs</files>
  <action>
Create `test/agent_com/hub_fsm_test.exs`:
- `use ExUnit.Case` (NOT async -- uses named GenServers)
- Setup: Start required dependencies (PubSub, Config, CostLedger, GoalBacklog) if not already started. Start HubFSM with `start_supervised!`. Use on_exit to clean up ETS tables.
- Important: HubFSM relies on GoalBacklog.stats() and CostLedger.check_budget(). These need to be running or mocked. Prefer starting the real GenServers (follow the pattern used in existing tests like goal_backlog_test.exs and cost_ledger_test.exs). If test isolation is difficult, use Mox or stub the gather_system_state function.

Test cases:

**Lifecycle tests:**
1. HubFSM starts in :resting state
2. get_state/0 returns correct initial state map (fsm_state: :resting, paused: false, cycle_count: 0)
3. history/0 returns initial transition entry (nil -> :resting)

**Transition tests:**
4. Submitting a goal to GoalBacklog then waiting for tick causes HubFSM to transition to :executing (submit a goal, wait ~1.5s for tick, check state)
5. When in :executing with no goals, HubFSM transitions back to :resting (transition to executing, delete/complete goals, wait for tick)
6. Cycle count increments on resting->executing transition

**Pause/resume tests:**
7. pause/0 returns :ok and sets paused: true
8. pause/0 when already paused returns {:error, :already_paused}
9. resume/0 returns :ok and sets paused: false
10. resume/0 when not paused returns {:error, :not_paused}
11. While paused, no transitions occur even with pending goals (submit goal, pause, wait 2s, verify still :resting or unchanged)

**Force transition tests:**
12. force_transition/2 with valid transition succeeds
13. force_transition/2 with invalid transition returns error

**History tests:**
14. Transitions are recorded in history with correct from/to/reason
15. History returns entries in newest-first order

**Timer/watchdog tests (optional, may be slow):**
16. If feasible: test watchdog by using a very short watchdog timeout (e.g., override @watchdog_ms for testing, or use force_transition and check that watchdog eventually fires). This test may be skipped if it requires modifying the module for testability -- note it as a known gap.

Note: For tests that depend on tick timing, use `Process.sleep/1` with generous margins (e.g., wait 2000ms for a 1000ms tick). Alternatively, if HubFSM supports a test mode with shorter tick intervals, use that.

RED->GREEN->REFACTOR cycle:
- Write all test cases first
- Fix any source issues found
- Refactor for clarity
  </action>
  <verify>
Run `mix test test/agent_com/hub_fsm_test.exs --trace`. All tests pass. Run `mix test` to verify no regressions across the full test suite.
  </verify>
  <done>
HubFSM integration tests pass covering lifecycle, transitions, pause/resume, force_transition, and history. Full test suite has zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `mix test test/agent_com/hub_fsm/ --trace` -- all predicate and history tests pass
2. `mix test test/agent_com/hub_fsm_test.exs --trace` -- all GenServer integration tests pass
3. `mix test` -- full suite passes with zero regressions
</verification>

<success_criteria>
All HubFSM tests pass: predicate logic covers all 2-state paths, history ETS operations work correctly, GenServer lifecycle and transitions are verified, and pause/resume safety is proven. Full test suite has zero regressions.
</success_criteria>

<output>
After completion, create `.planning/phases/29-hub-fsm-core/29-03-SUMMARY.md`
</output>

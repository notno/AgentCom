---
phase: 14-metrics-alerting
plan: 04
type: execute
wave: 4
depends_on: ["14-03"]
files_modified:
  - lib/agent_com/dashboard.ex
autonomous: true
must_haves:
  truths:
    - "A dedicated metrics tab shows time-series charts for queue depth, task latency, agent utilization, and error rates"
    - "Active alerts are visible as a banner/strip on the main dashboard (not just the metrics page)"
    - "Operators can acknowledge alerts from the dashboard via a button that calls the WebSocket acknowledge flow"
    - "Charts update in real time as metrics_snapshot events arrive via WebSocket"
  artifacts:
    - path: "lib/agent_com/dashboard.ex"
      provides: "Metrics tab with uPlot charts, alert banner on main page, acknowledge buttons"
      contains: "uPlot"
  key_links:
    - from: "lib/agent_com/dashboard.ex"
      to: "uPlot CDN"
      via: "script tag loading uPlot.iife.min.js and uPlot.min.css"
      pattern: "unpkg.com/uplot"
    - from: "lib/agent_com/dashboard.ex"
      to: "DashboardSocket WebSocket"
      via: "JavaScript handles metrics_snapshot, alert_fired, alert_cleared, alert_acknowledged events"
      pattern: "metrics_snapshot"
---

<objective>
Add a dedicated metrics tab with time-series charts to the dashboard, an alert banner on the main page, and alert acknowledgment buttons. Uses uPlot for charting via CDN.

Purpose: Satisfies the locked decisions for dashboard presentation: dedicated metrics tab, time-series charts, alert banner on main dashboard, acknowledge capability. Operators can see system health at a glance.
Output: Updated dashboard.ex with metrics tab, alert banner, uPlot integration.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-metrics-alerting/14-RESEARCH.md
@.planning/phases/14-metrics-alerting/14-01-SUMMARY.md
@.planning/phases/14-metrics-alerting/14-02-SUMMARY.md
@.planning/phases/14-metrics-alerting/14-03-SUMMARY.md
@lib/agent_com/dashboard.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tab navigation, alert banner, and metrics tab HTML/CSS to dashboard</name>
  <files>lib/agent_com/dashboard.ex</files>
  <action>
Modify the dashboard HTML to add tab-based navigation and a metrics tab. The dashboard is a self-contained inline HTML page (no build step).

**1. Add uPlot CDN resources to the HTML head:**
```html
<link rel="stylesheet" href="https://unpkg.com/uplot@1.6.31/dist/uPlot.min.css">
<script src="https://unpkg.com/uplot@1.6.31/dist/uPlot.iife.min.js"></script>
```

**2. Add tab navigation bar** at the top of the page (above existing content):
```html
<nav class="tab-bar">
  <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
  <button class="tab-btn" data-tab="metrics" onclick="switchTab('metrics')">Metrics</button>
</nav>
```

**3. Wrap existing dashboard content** in a tab container div:
```html
<div id="tab-dashboard" class="tab-content active">
  <!-- All existing dashboard HTML goes here -->
</div>
```

**4. Add alert banner** at the very top of the page (above tabs), visible on ALL tabs:
```html
<div id="alert-banner" class="alert-banner" style="display:none;">
  <div class="alert-banner-content">
    <span class="alert-icon">&#9888;</span>
    <span id="alert-banner-text">No active alerts</span>
    <button class="alert-banner-dismiss" onclick="toggleAlertDetails()">Details</button>
  </div>
  <div id="alert-details" class="alert-details" style="display:none;">
    <!-- Populated by JavaScript -->
  </div>
</div>
```

**5. Add metrics tab content:**
```html
<div id="tab-metrics" class="tab-content" style="display:none;">
  <h2>System Metrics</h2>

  <div class="metrics-grid">
    <!-- Summary cards row -->
    <div class="metrics-cards">
      <div class="metric-card">
        <h4>Queue Depth</h4>
        <div class="metric-value" id="mc-queue-depth">--</div>
        <div class="metric-detail" id="mc-queue-trend">1h avg: --</div>
      </div>
      <div class="metric-card">
        <h4>Task Latency (p50)</h4>
        <div class="metric-value" id="mc-latency-p50">--</div>
        <div class="metric-detail" id="mc-latency-range">p90: -- / p99: --</div>
      </div>
      <div class="metric-card">
        <h4>Agent Utilization</h4>
        <div class="metric-value" id="mc-utilization">--</div>
        <div class="metric-detail" id="mc-agents-status">-- online / -- idle</div>
      </div>
      <div class="metric-card">
        <h4>Error Rate</h4>
        <div class="metric-value" id="mc-error-rate">--</div>
        <div class="metric-detail" id="mc-error-count">-- failures/hr</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="chart-container">
      <h3>Queue Depth</h3>
      <div id="chart-queue-depth"></div>
    </div>
    <div class="chart-container">
      <h3>Task Latency</h3>
      <div id="chart-latency"></div>
    </div>
    <div class="chart-container">
      <h3>Agent Utilization</h3>
      <div id="chart-utilization"></div>
    </div>
    <div class="chart-container">
      <h3>Error Rate</h3>
      <div id="chart-errors"></div>
    </div>

    <!-- Active Alerts Section -->
    <div class="alerts-section">
      <h3>Active Alerts</h3>
      <div id="alerts-list" class="alerts-list">
        <p class="no-alerts">No active alerts</p>
      </div>
    </div>

    <!-- Per-Agent Table -->
    <div class="agent-metrics-section">
      <h3>Per-Agent Metrics</h3>
      <table class="agent-metrics-table" id="agent-metrics-table">
        <thead>
          <tr>
            <th>Agent</th>
            <th>State</th>
            <th>Utilization</th>
            <th>Tasks/hr</th>
            <th>Avg Duration</th>
          </tr>
        </thead>
        <tbody id="agent-metrics-tbody">
        </tbody>
      </table>
    </div>
  </div>
</div>
```

**6. CSS additions** (add to existing inline `<style>` block):

Style the tab bar, alert banner, metrics cards, chart containers, alerts list, and agent metrics table. Use the existing dashboard color scheme and design language. Key styles:

- `.tab-bar`: flexbox row, sticky at top, background matching header
- `.tab-btn`: padding, border-bottom highlight when active, cursor pointer
- `.alert-banner`: full-width strip, yellow/amber for WARNING, red for CRITICAL, position sticky below tabs
- `.metric-card`: flex item in a 4-column grid, background card with value/detail
- `.chart-container`: full-width, min-height 300px, margin-bottom for spacing
- `.alerts-list`: card-style list with severity color coding and acknowledge button per alert
- `.alert-item.critical`: red left border; `.alert-item.warning`: amber left border
- Responsive: 2-column grid on medium screens, 1-column on small

**IMPORTANT:** The dashboard.ex file is ~1344 lines. Make surgical additions -- do not rewrite existing content. Add the tab wrapper around existing content, prepend the alert banner and tab bar, and append the metrics tab content.
  </action>
  <verify>
Run `mix compile` -- no errors.
Visit http://localhost:4000/dashboard -- page loads with tab bar, both tabs switchable. Existing dashboard content unchanged. Metrics tab visible when clicked.
  </verify>
  <done>
Dashboard has tab navigation (Dashboard | Metrics), alert banner at top visible on all tabs, metrics tab with summary cards, chart containers, alerts list, and per-agent table. CSS styles match existing design language.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add JavaScript for uPlot charts, real-time updates, and alert management</name>
  <files>lib/agent_com/dashboard.ex</files>
  <action>
Add JavaScript to the dashboard's inline `<script>` section for chart initialization, real-time data updates, and alert interaction.

**1. Tab switching function:**
```javascript
function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tabName).style.display = 'block';
  document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');

  // Resize uPlot charts when metrics tab becomes visible (uPlot needs visible container)
  if (tabName === 'metrics' && window.metricsCharts) {
    Object.values(window.metricsCharts).forEach(chart => {
      if (chart && chart.root) {
        const width = chart.root.parentElement.clientWidth;
        chart.setSize({width: width, height: 300});
      }
    });
  }
}
```

**2. uPlot chart initialization** (call after DOM ready, in the existing DOMContentLoaded or equivalent):

Create 4 charts stored in `window.metricsCharts`:
- `queueDepth`: Single series (depth) over time
- `latency`: Three series (p50, p90, p99) over time
- `utilization`: Single series (system utilization %) over time
- `errors`: Two series (failure rate %, error count) over time

Each chart config:
- Width: container width (responsive)
- Height: 300px
- Series with distinct colors matching the dashboard palette
- X-axis: time (uPlot auto-formats from Unix seconds)
- Y-axis: appropriate labels (count, ms, %, etc.)

Data format: `[timestamps[], series1[], series2[], ...]` -- initialize as empty arrays.

Keep a max of 360 data points per chart (1 hour at 10s intervals). When exceeding, shift all arrays.

**3. WebSocket message handler extension:**

In the existing WebSocket `onmessage` handler (or create a new handler that chains with the existing one), add cases for the new message types:

```javascript
// Inside the message handler:
if (msg.type === 'metrics_snapshot') {
  updateMetricsDisplay(msg.data);
}
if (msg.type === 'alert_fired') {
  addAlert(msg.data);
  updateAlertBanner();
}
if (msg.type === 'alert_cleared') {
  removeAlert(msg.rule_id);
  updateAlertBanner();
}
if (msg.type === 'alert_acknowledged') {
  markAlertAcknowledged(msg.rule_id);
}
if (msg.type === 'alert_ack_result') {
  // Handle ack confirmation -- update UI
}
// Also handle initial snapshot with alerts
if (msg.type === 'snapshot' && msg.alerts) {
  msg.alerts.forEach(a => addAlert(a));
  updateAlertBanner();
}
// Handle batched events containing metrics/alert events
if (msg.type === 'events' && msg.data) {
  msg.data.forEach(evt => {
    if (evt.type === 'metrics_snapshot') updateMetricsDisplay(evt.data);
    if (evt.type === 'alert_fired') { addAlert(evt.data); updateAlertBanner(); }
    if (evt.type === 'alert_cleared') { removeAlert(evt.rule_id); updateAlertBanner(); }
    if (evt.type === 'alert_acknowledged') markAlertAcknowledged(evt.rule_id);
  });
}
```

**4. `updateMetricsDisplay(data)` function:**
- Update summary cards (#mc-queue-depth, #mc-latency-p50, etc.) with current values
- Format durations: if > 60000ms show as "Xm Ys", if > 1000ms show as "X.Xs", otherwise "Xms"
- Append data point to each chart's data arrays
- Call `chart.setData(data)` on each uPlot instance to update
- Update per-agent table rows (clear tbody, create new rows from agent_utilization.per_agent)

**5. Alert management functions:**
- `addAlert(alert)`: Store in `window.activeAlerts` object (keyed by rule_id). Render into #alerts-list as card with severity color, message, timestamp, and Acknowledge button.
- `removeAlert(ruleId)`: Remove from activeAlerts, remove DOM element.
- `markAlertAcknowledged(ruleId)`: Update alert card UI to show "Acknowledged" badge, disable button.
- `updateAlertBanner()`: If any active unacknowledged alerts exist, show banner. Set banner class to highest severity (critical > warning). Set text to count of alerts. If no active alerts, hide banner.
- `acknowledgeAlert(ruleId)`: Send `{"type": "acknowledge_alert", "rule_id": ruleId}` via WebSocket.
- `toggleAlertDetails()`: Show/hide the expanded alert details panel under the banner.

**6. Format helpers:**
- `formatMs(ms)`: Human-readable duration
- `formatPct(pct)`: "X.Y%"
- `formatTimestamp(ms)`: Local time string
- `severityClass(severity)`: Returns CSS class name

**IMPORTANT:** Integrate with the existing WebSocket connection -- do NOT create a second WebSocket. The existing dashboard JavaScript already manages a WebSocket at /ws/dashboard. Find the existing onmessage handler and extend it with the new message types. If the existing code uses a switch/case or if/else chain, add the new cases.

**IMPORTANT:** Initialize charts only when the DOM is ready AND after uPlot script has loaded. Use the existing DOM ready mechanism. Charts should handle the case where no data has arrived yet (empty arrays render as blank charts).
  </action>
  <verify>
Run `mix compile` -- no errors.
Visit http://localhost:4000/dashboard:
1. Tab bar shows "Dashboard" and "Metrics" tabs
2. Click "Metrics" tab -- charts render (may be empty if no data yet)
3. After 10 seconds, metrics cards update with real values
4. Charts show data points accumulating over time
5. Switch back to "Dashboard" tab -- existing content unchanged
6. If any alerts are active, alert banner is visible at top of both tabs
  </verify>
  <done>
Dashboard has fully functional metrics tab with 4 uPlot time-series charts (queue depth, task latency, agent utilization, error rate), summary cards with real-time values, per-agent metrics table, active alerts list with acknowledge buttons, and alert banner on main page. All update in real time via WebSocket.
  </done>
</task>

</tasks>

<verification>
1. `mix compile` succeeds with no warnings
2. `mix test` passes (no regressions)
3. Visit dashboard at http://localhost:4000/dashboard:
   a. Tab bar is visible at top with "Dashboard" and "Metrics" tabs
   b. Alert banner appears when alerts are active (test by stopping agents)
   c. Metrics tab shows 4 charts that update every 10 seconds
   d. Summary cards show current values (queue depth, latency, utilization, error rate)
   e. Per-agent table shows each registered agent with utilization breakdown
   f. Acknowledge button on alerts sends WebSocket message and updates UI
   g. Switching between tabs preserves state
4. Charts resize properly when switching to metrics tab (uPlot resize on visibility)
5. Existing dashboard functionality is completely unaffected
</verification>

<success_criteria>
- Dedicated metrics tab with 4 uPlot time-series charts (queue depth, latency, utilization, errors)
- Summary cards show current metric values with formatted display
- Per-agent metrics table shows utilization breakdown per agent
- Active alerts list with severity color coding and acknowledge buttons
- Alert banner on main dashboard page (visible on all tabs)
- All charts and cards update in real time from WebSocket metrics_snapshot events
- Alert banner updates in real time from WebSocket alert events
- Tab switching works cleanly with chart resize handling
- All existing dashboard functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/14-metrics-alerting/14-04-SUMMARY.md`
</output>

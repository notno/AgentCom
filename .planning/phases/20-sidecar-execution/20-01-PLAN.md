---
phase: 20-sidecar-execution
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - sidecar/lib/execution/cost-calculator.js
  - sidecar/lib/execution/progress-emitter.js
  - sidecar/test/cost-calculator.test.js
  - sidecar/test/progress-emitter.test.js
autonomous: true

must_haves:
  truths:
    - "Cost calculator returns $0 for Ollama models and correct USD cost for Claude models"
    - "Cost calculator returns equivalent Claude cost for local Ollama tasks showing savings"
    - "Progress emitter batches high-frequency token events into 100ms windows"
  artifacts:
    - path: "sidecar/lib/execution/cost-calculator.js"
      provides: "calculateCost function with static model-to-price lookup"
      exports: ["calculateCost", "COST_TABLE"]
    - path: "sidecar/lib/execution/progress-emitter.js"
      provides: "ProgressEmitter class that batches and emits execution events"
      exports: ["ProgressEmitter"]
    - path: "sidecar/test/cost-calculator.test.js"
      provides: "Tests for cost calculation edge cases"
    - path: "sidecar/test/progress-emitter.test.js"
      provides: "Tests for event batching behavior"
  key_links:
    - from: "sidecar/lib/execution/cost-calculator.js"
      to: "COST_TABLE constant"
      via: "findCostEntry prefix match"
      pattern: "findCostEntry.*model"
---

<objective>
TDD implementation of cost calculator and progress event emitter -- the two pure-function modules that all three executors depend on.

Purpose: Provides the cost estimation logic (per-task cost breakdown, equivalent Claude cost for Ollama tasks per locked decision) and the progress streaming infrastructure (100ms batching to prevent WebSocket backpressure per research pitfall #6). These are pure functions with well-defined I/O, ideal for TDD.

Output: Two tested modules in `sidecar/lib/execution/` ready for use by Plan 03 executors.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-sidecar-execution/20-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cost calculator and progress emitter (TDD)</name>
  <files>
    sidecar/lib/execution/cost-calculator.js
    sidecar/lib/execution/progress-emitter.js
    sidecar/test/cost-calculator.test.js
    sidecar/test/progress-emitter.test.js
  </files>
  <action>
    Create `sidecar/lib/execution/` directory. Write tests first (RED), then implement (GREEN).

    ## Cost Calculator (cost-calculator.js)

    Pure function: `calculateCost(model, tokensIn, tokensOut) -> { cost_usd, equivalent_claude_cost_usd }`

    **Test cases (write these first):**
    - `calculateCost('claude-sonnet-4.5', 1000, 500)` -> `{ cost_usd: 0.0105, equivalent_claude_cost_usd: null }` (3.00/M * 1000 + 15.00/M * 500)
    - `calculateCost('claude-opus-4.6', 1000, 500)` -> `{ cost_usd: 0.0175, equivalent_claude_cost_usd: null }` (5.00/M * 1000 + 25.00/M * 500)
    - `calculateCost('llama3.2:latest', 1000, 500)` -> `{ cost_usd: 0, equivalent_claude_cost_usd: 0.0105 }` (Ollama = $0, equivalent uses _claude_equivalent Sonnet baseline)
    - `calculateCost('none', 0, 0)` -> `{ cost_usd: 0, equivalent_claude_cost_usd: null }` (trivial task, no tokens)
    - `calculateCost(null, 0, 0)` -> `{ cost_usd: 0, equivalent_claude_cost_usd: null }` (null model edge case)
    - `calculateCost('claude-sonnet-4.5:latest', 1000, 0)` -> prefix match works for model variants with tags

    **Implementation:** Export `calculateCost(model, tokensIn, tokensOut)` and `COST_TABLE`. Use `findCostEntry(model)` with exact match then prefix match. Return `{ cost_usd: number, equivalent_claude_cost_usd: number|null }`. When no cost entry found (Ollama models) and tokens > 0, compute equivalent using `_claude_equivalent`.

    **COST_TABLE** must include (per locked decision -- Claude pricing):
    - claude-sonnet-4.5: input 3.00/M, output 15.00/M
    - claude-opus-4.5: input 5.00/M, output 25.00/M
    - claude-haiku-4.5: input 1.00/M, output 5.00/M
    - claude-opus-4.6: input 5.00/M, output 25.00/M
    - _claude_equivalent: input 3.00/M, output 15.00/M (Sonnet as baseline for savings comparison)

    ## Progress Emitter (progress-emitter.js)

    Class: `ProgressEmitter` that batches token events and calls a flush callback.

    Constructor: `new ProgressEmitter(onFlush, { batchIntervalMs: 100 })`

    **Test cases (write these first):**
    - Single token event emitted immediately if no pending batch
    - Multiple rapid token events within 100ms window are batched into one flush
    - `emit({ type: 'status', message: 'Ollama retry 1/2...' })` flushes immediately (status/error events never batched)
    - `emit({ type: 'stdout', text: 'line1\n' })` flushes immediately (stdout events never batched)
    - `flush()` sends any accumulated tokens immediately
    - `destroy()` flushes remaining and clears interval
    - Token batching accumulates text and updates tokens_so_far to latest value

    **Implementation:** Export `ProgressEmitter` class. Use `setInterval` for batch window. Accumulate token text in buffer. On flush, emit single event with concatenated text and latest tokens_so_far. Non-token events bypass batching entirely.

    **Batching rule:** Only `type: 'token'` events are batched. All other event types (`status`, `error`, `stdout`, `stderr`) flush immediately because they represent discrete state changes (per locked decision: retry attempts stream in real-time).

    Tests use Node.js built-in test runner (`node --test`). If sidecar tests use a different runner, match existing convention (check `sidecar/test/` for existing patterns).
  </action>
  <verify>Run `node --test sidecar/test/cost-calculator.test.js sidecar/test/progress-emitter.test.js` -- all tests pass.</verify>
  <done>Cost calculator correctly prices Claude models, returns $0 for Ollama with equivalent cost, handles edge cases. Progress emitter batches tokens at 100ms, flushes status/stdout immediately, cleans up on destroy.</done>
</task>

</tasks>

<verification>
- `node --test sidecar/test/cost-calculator.test.js` passes all cases
- `node --test sidecar/test/progress-emitter.test.js` passes all cases
- Both modules export expected functions/classes
- `require('./sidecar/lib/execution/cost-calculator')` loads without error
- `require('./sidecar/lib/execution/progress-emitter')` loads without error
</verification>

<success_criteria>
1. Cost calculator returns correct USD amounts for all Claude models in COST_TABLE
2. Ollama models return cost_usd=0 with non-null equivalent_claude_cost_usd when tokens > 0
3. Progress emitter batches token events within 100ms windows
4. Status/error/stdout events bypass batching and flush immediately
5. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-sidecar-execution/20-01-SUMMARY.md`
</output>

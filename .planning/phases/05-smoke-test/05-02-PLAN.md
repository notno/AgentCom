---
phase: 05-smoke-test
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - test/smoke/basic_test.exs
  - test/smoke/failure_test.exs
  - test/smoke/scale_test.exs
autonomous: false

must_haves:
  truths:
    - "10 trivial tasks complete across 2 simulated agents with 10/10 success"
    - "Assignment latency is under 5 seconds for all 10 tasks"
    - "Token overhead is under 500 per task (tokens_used field)"
    - "Killing one agent mid-task results in task returning to queue and completing via remaining agent"
    - "No duplicate completions occur after agent kill and recovery"
    - "4 agents processing 20 tasks achieve even distribution within +/-2 tasks per agent"
    - "No priority lane starvation when mixing urgent, high, normal, low priorities"
  artifacts:
    - path: "test/smoke/basic_test.exs"
      provides: "TEST-01 basic pipeline validation"
      contains: "10 tasks complete across 2 agents"
    - path: "test/smoke/failure_test.exs"
      provides: "TEST-02 failure recovery validation"
      contains: "kill_connection"
    - path: "test/smoke/scale_test.exs"
      provides: "TEST-03 scale distribution validation"
      contains: "4 agents"
  key_links:
    - from: "test/smoke/basic_test.exs"
      to: "test/smoke/helpers/agent_sim.ex"
      via: "AgentSim.start_link for simulated agents"
      pattern: "Smoke\\.AgentSim\\.start_link"
    - from: "test/smoke/basic_test.exs"
      to: "test/smoke/helpers/http_helpers.ex"
      via: "HTTP task submission"
      pattern: "Smoke\\.Http\\.submit_task"
    - from: "test/smoke/basic_test.exs"
      to: "lib/agent_com/task_queue.ex"
      via: "Direct TaskQueue.get for assertions"
      pattern: "AgentCom\\.TaskQueue\\.get"
    - from: "test/smoke/failure_test.exs"
      to: "test/smoke/helpers/agent_sim.ex"
      via: "kill_connection for abrupt disconnect"
      pattern: "Smoke\\.AgentSim\\.kill_connection"
    - from: "test/smoke/scale_test.exs"
      to: "test/smoke/helpers/assertions.ex"
      via: "assert_all_completed for batch verification"
      pattern: "Smoke\\.Assertions\\.assert_all_completed"
---

<objective>
Implement the 3 smoke test scenarios (TEST-01 basic pipeline, TEST-02 failure recovery, TEST-03 scale distribution) that validate the full task pipeline works end-to-end.

Purpose: These tests are the quality gate for Phases 1-4. They exercise the complete flow: task submission via HTTP API, scheduler matching, WebSocket task delivery, agent completion with generation tracking, and failure recovery. Passing all 3 proves the system is ready for production workloads.

Output: 3 ExUnit test files covering all Phase 5 success criteria, runnable via `mix test test/smoke/`.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-smoke-test/05-RESEARCH.md
@.planning/phases/05-smoke-test/05-01-SUMMARY.md
@lib/agent_com/socket.ex
@lib/agent_com/task_queue.ex
@lib/agent_com/scheduler.ex
@lib/agent_com/agent_fsm.ex
@test/smoke/helpers/agent_sim.ex
@test/smoke/helpers/http_helpers.ex
@test/smoke/helpers/assertions.ex
@test/smoke/helpers/setup.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement TEST-01 basic pipeline and TEST-02 failure recovery tests</name>
  <files>test/smoke/basic_test.exs, test/smoke/failure_test.exs</files>
  <action>
**test/smoke/basic_test.exs (Smoke.BasicTest):**

ExUnit test module for TEST-01. Uses `async: false` (tests modify shared state).

Setup:
1. Call `Smoke.Setup.reset_all()` to clear DETS
2. Create tokens for 2 agents: `Smoke.Setup.create_test_tokens(["smoke-basic-1", "smoke-basic-2"])`
3. Also create an admin/submitter token for HTTP API calls
4. On exit, call `Smoke.Setup.cleanup_agents(agent_ids)` and stop any agent sims

Test: "TEST-01: 10 tasks complete across 2 agents":
1. Start 2 AgentSim processes with `on_task_assign: :complete` and their tokens
2. Wait for both agents to be identified (poll `AgentSim.identified?/1` with timeout)
3. Submit 10 tasks via `Smoke.Http.submit_task("Write number #{n} to file", token)` collecting task_ids
4. Call `Smoke.Assertions.assert_all_completed(task_ids, timeout: 30_000)`
5. Assert all 10 tasks are `:completed` via `AgentCom.TaskQueue.get/1`
6. Assert assignment latency: for each task, get the task record, compute `assigned_at - created_at` (both are millisecond timestamps in the task map), assert < 5000ms
7. Assert token overhead: for each completed task, check `tokens_used` is 0 or nil (trivial tasks use no tokens, which is under 500)
8. Assert both agents did work: check `AgentSim.completed_count/1` for each agent is > 0 (both participated)
9. Stop both agents

IMPORTANT: Use the correct field names from the TaskQueue task map. The task is a map with atom keys including `:status`, `:assigned_at`, `:created_at`, `:generation`, etc. Check the task_queue.ex source for exact field names.

IMPORTANT: Connect agents BEFORE submitting tasks (Research Pitfall 2). The scheduler fires on task_submitted and checks for idle agents. If agents aren't connected yet, they won't be found.

**test/smoke/failure_test.exs (Smoke.FailureTest):**

ExUnit test module for TEST-02. Uses `async: false`.

Setup: Same pattern as BasicTest -- reset DETS, create tokens for 2 agents.

Test: "TEST-02: killed agent's task reclaimed and completed by survivor":
1. Start agent1 ("smoke-victim") with `on_task_assign: {:delay, 10_000}` (accepts but delays completion)
2. Start agent2 ("smoke-survivor") with `on_task_assign: :complete` (completes immediately)
3. Wait for both identified
4. Submit 1 task via HTTP
5. Wait for agent1 to receive the task: poll `AgentSim.received_tasks(agent1)` until length > 0
6. Kill agent1's connection abruptly: `Smoke.AgentSim.kill_connection(agent1)`
7. Wait for the task to complete via agent2: `Smoke.Assertions.assert_task_completed(task_id, timeout: 60_000)` -- use 60s timeout because the AgentFSM needs to detect the :DOWN, reclaim the task, and scheduler needs to reassign. The stuck sweep runs every 30s, but :DOWN should trigger faster via AgentFSM monitor.
8. Verify task completed exactly once: `AgentCom.TaskQueue.get(task_id)` returns `:completed` status
9. Verify no duplicates: Check task history -- there should be exactly one completion event
10. Verify agent2 was the completer: `AgentSim.completed_count(agent2)` == 1

Test: "TEST-02b: multiple tasks, one agent killed, all complete":
1. Start 2 agents, submit 5 tasks
2. Wait for at least 1 task to be assigned to agent1 (via received_tasks)
3. Kill agent1
4. Assert all 5 tasks complete (some via agent1 before kill, rest via agent2 after recovery)
5. Assert no duplicate completions (total completed across both agents equals 5)

IMPORTANT: After killing agent1, the AgentFSM :DOWN handler should trigger `reclaim_task` which broadcasts `:task_reclaimed` to PubSub, causing the Scheduler to reassign. This is the expected recovery path -- NOT the 30s stuck sweep.

IMPORTANT: For kill_connection, the WebSocket process itself must die abruptly. Do NOT send a clean close frame. The goal is to trigger the AgentFSM's Process.monitor :DOWN handler.
  </action>
  <verify>
1. Files exist: `ls test/smoke/basic_test.exs test/smoke/failure_test.exs`
2. `mix compile` succeeds
3. `mix test test/smoke/basic_test.exs` -- all tests pass (10/10 tasks complete, latency under 5s)
4. `mix test test/smoke/failure_test.exs` -- all tests pass (killed agent's task recovered, no duplicates)
  </verify>
  <done>
TEST-01 passes: 10 tasks complete across 2 simulated agents with under 5s assignment latency and under 500 tokens overhead. TEST-02 passes: killed agent's task is reclaimed and completed by survivor with no duplicates and no lost tasks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement TEST-03 scale distribution test</name>
  <files>test/smoke/scale_test.exs</files>
  <action>
**test/smoke/scale_test.exs (Smoke.ScaleTest):**

ExUnit test module for TEST-03. Uses `async: false`.

Setup: Reset DETS, create tokens for 4 agents and 1 submitter.

Test: "TEST-03: 4 agents, 20 tasks, even distribution":
1. Start 4 AgentSim processes ("smoke-scale-1" through "smoke-scale-4") with `on_task_assign: :complete`
2. Wait for all 4 to be identified
3. Submit 20 tasks via HTTP, with mixed priorities to test no starvation:
   - 4 tasks priority "urgent"
   - 4 tasks priority "high"
   - 8 tasks priority "normal"
   - 4 tasks priority "low"
4. Call `Smoke.Assertions.assert_all_completed(task_ids, timeout: 30_000)`
5. Assert all 20 tasks completed
6. Check distribution: For each agent, call `AgentSim.completed_count/1`. Each should have completed between 3 and 7 tasks (20/4 = 5, +/-2 means 3-7 range).
7. Assert no starvation: Verify that ALL priority levels had tasks completed. Check task records to confirm urgent, high, normal, and low tasks all reached `:completed` status.
8. Assert assignment order respects priority: urgent tasks should have been assigned (assigned_at) before low tasks on average. Collect assigned_at timestamps grouped by priority, verify urgent mean < low mean.

Test: "TEST-03b: no starvation under sequential submission":
1. Start 4 agents
2. Submit tasks one at a time with alternating priorities (urgent, low, urgent, low, ...) to test that low-priority tasks aren't starved by urgent ones
3. Assert all complete
4. Assert low-priority tasks complete (not stuck in queue forever)

IMPORTANT: The scheduler uses a greedy matching loop that iterates ALL queued tasks (not just queue head), so head-of-line blocking shouldn't occur. But priority ordering means higher-priority tasks get assigned first when multiple are queued simultaneously.

IMPORTANT: Distribution evenness depends on how fast agents complete. Since simulated agents complete instantly (:complete mode), the scheduler may batch-assign. The even distribution assertion allows +/-2 (3-7 range for 5 expected) which should accommodate any reasonable scheduling variance.
  </action>
  <verify>
1. File exists: `ls test/smoke/scale_test.exs`
2. `mix compile` succeeds
3. `mix test test/smoke/scale_test.exs` -- all tests pass (even distribution, no starvation)
4. `mix test test/smoke/` -- ALL smoke tests pass together (basic + failure + scale)
  </verify>
  <done>
TEST-03 passes: 4 agents process 20 tasks with even distribution (each agent completes 3-7 tasks, within +/-2 of expected 5). No priority lane starvation -- all priority levels (urgent, high, normal, low) have their tasks completed. All 3 smoke test files pass when run together via `mix test test/smoke/`.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify all smoke tests pass</name>
  <files>test/smoke/basic_test.exs, test/smoke/failure_test.exs, test/smoke/scale_test.exs</files>
  <action>
CHECKPOINT: Human verification that the complete smoke test suite passes and exercises the real pipeline.

What was built: Complete smoke test suite validating the full task pipeline (Phases 1-4) with 3 test scenarios: basic throughput (TEST-01), failure recovery (TEST-02), and scale distribution (TEST-03). All tests use simulated WebSocket agents connecting to the real hub.

How to verify:
1. Run all smoke tests: `cd C:/Users/nrosq/src/AgentCom && mix test test/smoke/`
2. Expected output: All tests pass (green)
   - TEST-01: 10/10 tasks complete, latency under 5s
   - TEST-02: Killed agent's task recovered, no duplicates
   - TEST-03: 20 tasks distributed evenly across 4 agents, no starvation
3. If any test fails, report the failure output

Resume signal: Type "approved" if all tests pass, or paste the failure output for diagnosis.
  </action>
  <verify>All smoke tests pass with green output from `mix test test/smoke/`</verify>
  <done>Human has verified that all 3 smoke test scenarios pass, confirming the full pipeline works end-to-end.</done>
</task>

</tasks>

<verification>
1. `mix test test/smoke/` passes all tests
2. TEST-01 criteria met: 10/10 completion, <5s latency, <500 tokens overhead
3. TEST-02 criteria met: task recovery after agent kill, no duplicates, no lost tasks
4. TEST-03 criteria met: even distribution (+/-2), no starvation across priority lanes
5. Sidecar generation bug fixed (verified in Plan 01)
</verification>

<success_criteria>
- All 3 ExUnit test files exist and compile
- `mix test test/smoke/basic_test.exs` passes (TEST-01: 10 tasks, 2 agents, 10/10 success, <5s latency, <500 tokens)
- `mix test test/smoke/failure_test.exs` passes (TEST-02: agent kill, task recovery, no duplicates)
- `mix test test/smoke/scale_test.exs` passes (TEST-03: 4 agents, 20 tasks, +/-2 distribution, no starvation)
- `mix test test/smoke/` runs all 3 together without interference
- Human verification confirms tests are actually exercising the real pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/05-smoke-test/05-02-SUMMARY.md`
</output>

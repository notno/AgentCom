---
phase: 44-hub-fsm-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/agent_com/hub_endpoint_test.exs
autonomous: true

must_haves:
  truths:
    - "GET /api/hub/state returns JSON with fsm_state, paused, cycle_count"
    - "POST /api/hub/pause with auth returns 200 and pauses FSM"
    - "POST /api/hub/pause without auth returns 401"
    - "POST /api/hub/resume with auth returns 200 and resumes FSM"
    - "POST /api/hub/resume when not paused returns not_paused status"
    - "GET /api/hub/history returns transition entries array"
    - "GET /api/hub/history?limit=N respects limit parameter"
    - "POST /api/hub/stop and /api/hub/start work with auth"
    - "GET /api/hub/healing-history returns healing audit log"
  artifacts:
    - path: "test/agent_com/hub_endpoint_test.exs"
      provides: "HTTP endpoint integration tests for Hub FSM API"
      min_lines: 150
  key_links:
    - from: "test/agent_com/hub_endpoint_test.exs"
      to: "lib/agent_com/endpoint.ex"
      via: "Plug.Test.conn + AgentCom.Endpoint.call"
      pattern: "Plug\\.Test\\.conn|Endpoint\\.call"
---

<objective>
Create HTTP endpoint tests for all Hub FSM API routes using Plug.Test.

Purpose: Validate that the HTTP control endpoints (/api/hub/pause, resume, stop, start, state, history, healing-history) return correct responses with proper authentication enforcement.

Output: test/agent_com/hub_endpoint_test.exs with comprehensive endpoint tests
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
@C:/Users/nrosq/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/44-hub-fsm-testing/44-RESEARCH.md

@lib/agent_com/endpoint.ex (lines 1445-1565 for Hub FSM API section)
@lib/agent_com/plugs/require_auth.ex
@test/agent_com/webhook_endpoint_test.exs (reference pattern for Plug.Test usage)
@test/support/dets_helpers.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hub FSM HTTP endpoint tests</name>
  <files>test/agent_com/hub_endpoint_test.exs</files>
  <action>
Create `test/agent_com/hub_endpoint_test.exs` with `use ExUnit.Case, async: false`.

Setup block: Follow webhook_endpoint_test.exs pattern exactly:
- DetsHelpers.full_test_setup()
- Terminate/restart HubFSM with History.init_table()/clear()
- on_exit with terminate + full_test_teardown

Helper functions:
- `call_endpoint(conn)` -- `AgentCom.Endpoint.call(conn, AgentCom.Endpoint.init([]))`
- `auth_conn(method, path, body \\ nil)` -- creates conn with valid Bearer token via `AgentCom.Auth.generate("test-hub-admin")`
- `noauth_conn(method, path)` -- creates conn without auth header

Describe block "GET /api/hub/state" with tests:

1. **"returns current FSM state (no auth required)"**
   - Plug.Test.conn(:get, "/api/hub/state") |> call_endpoint()
   - Assert status 200
   - Decode body, assert body["fsm_state"] == "resting"
   - Assert body["paused"] == false
   - Assert is_integer(body["cycle_count"])

2. **"returns correct state after force_transition"**
   - HubFSM.force_transition(:executing, "test")
   - GET /api/hub/state
   - Assert body["fsm_state"] == "executing"

Describe block "POST /api/hub/pause" with tests:

3. **"with auth pauses FSM and returns 200"**
   - auth_conn(:post, "/api/hub/pause") |> call_endpoint()
   - Assert status 200, body["status"] == "paused"
   - Verify via HubFSM.get_state().paused == true

4. **"without auth returns 401"**
   - noauth_conn(:post, "/api/hub/pause") |> call_endpoint()
   - Assert status 401

5. **"when already paused returns already_paused"**
   - HubFSM.pause()
   - auth_conn(:post, "/api/hub/pause") |> call_endpoint()
   - Assert status 200, body["status"] == "already_paused"

Describe block "POST /api/hub/resume" with tests:

6. **"with auth resumes FSM and returns 200"**
   - HubFSM.pause() first
   - auth_conn(:post, "/api/hub/resume") |> call_endpoint()
   - Assert status 200, body["status"] == "resumed"
   - Verify HubFSM.get_state().paused == false

7. **"when not paused returns not_paused"**
   - auth_conn(:post, "/api/hub/resume") |> call_endpoint()
   - Assert status 200, body["status"] == "not_paused"

Describe block "POST /api/hub/stop and /api/hub/start" with tests:

8. **"stop pauses and transitions to resting"**
   - HubFSM.force_transition(:executing, "setup")
   - auth_conn(:post, "/api/hub/stop") |> call_endpoint()
   - Assert status 200, body["status"] == "stopped"
   - Verify HubFSM.get_state() has paused: true, fsm_state: :resting

9. **"start resumes from stopped state"**
   - HubFSM.stop_fsm()
   - auth_conn(:post, "/api/hub/start") |> call_endpoint()
   - Assert status 200, body["status"] == "started"

Describe block "GET /api/hub/history" with tests:

10. **"returns transition history array"**
    - GET /api/hub/history (no auth)
    - Assert status 200
    - Assert is_list(body["transitions"])
    - Assert length >= 1 (initial nil->resting)

11. **"respects limit parameter"**
    - Force a few transitions
    - GET /api/hub/history?limit=2
    - Assert length(body["transitions"]) <= 2

Describe block "GET /api/hub/healing-history" with tests:

12. **"returns healing history (empty initially)"**
    - GET /api/hub/healing-history
    - Assert status 200
    - Assert body["history"] is a list
    - Assert body["count"] == 0
  </action>
  <verify>
Run: `mix test test/agent_com/hub_endpoint_test.exs --trace`
All 12 tests pass.
  </verify>
  <done>
12 HTTP endpoint tests pass covering GET /api/hub/state, POST /api/hub/pause (with/without auth, already paused), POST /api/hub/resume (normal, not paused), POST /api/hub/stop and /api/hub/start, GET /api/hub/history (with and without limit), and GET /api/hub/healing-history.
  </done>
</task>

</tasks>

<verification>
```bash
mix test test/agent_com/hub_endpoint_test.exs --trace
```
All tests pass. No warnings. Test count >= 12.
</verification>

<success_criteria>
- 12+ HTTP endpoint tests covering all hub API routes
- Auth enforcement verified (401 without token, 200 with token)
- State correctness verified (GET /api/hub/state reflects actual FSM state)
- History endpoints return properly formatted arrays
- All tests use DetsHelpers isolation and Plug.Test pattern
- Zero test failures
</success_criteria>

<output>
After completion, create `.planning/phases/44-hub-fsm-testing/44-02-SUMMARY.md`
</output>

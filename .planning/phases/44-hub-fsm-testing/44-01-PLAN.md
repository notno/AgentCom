---
phase: 44-hub-fsm-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/agent_com/hub_fsm_integration_test.exs
autonomous: true

must_haves:
  truths:
    - "Tests exercise resting -> executing -> resting cycle with real goal submission"
    - "Tests exercise resting -> improving -> contemplating -> resting cycle via messages"
    - "Tests exercise resting -> improving -> executing -> resting cycle (urgent work during improvement)"
    - "Tests verify cycle_count increments, transition_count tracks, history records all transitions"
    - "Tests trigger healing state via force_transition and verify exit to resting via healing_cycle_complete"
    - "Tests verify healing cooldown prevents immediate re-entry"
    - "Tests verify healing watchdog forces transition to resting"
  artifacts:
    - path: "test/agent_com/hub_fsm_integration_test.exs"
      provides: "FSM cycle integration tests and healing state tests"
      min_lines: 200
  key_links:
    - from: "test/agent_com/hub_fsm_integration_test.exs"
      to: "lib/agent_com/hub_fsm.ex"
      via: "HubFSM.force_transition/2, HubFSM.get_state/0, HubFSM.history/1"
      pattern: "HubFSM\\.(force_transition|get_state|history)"
---

<objective>
Create integration tests covering all 5 FSM state cycles and healing behavior.

Purpose: Validate that the HubFSM correctly transitions between all 5 states (resting, executing, improving, contemplating, healing), increments counters, records history, and that healing exits properly including cooldown and watchdog timeout.

Output: test/agent_com/hub_fsm_integration_test.exs with comprehensive FSM cycle and healing tests
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
@C:/Users/nrosq/.claude/get-shit-done/references/checkpoints.md
@C:/Users/nrosq/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/44-hub-fsm-testing/44-RESEARCH.md

@lib/agent_com/hub_fsm.ex
@lib/agent_com/hub_fsm/predicates.ex
@lib/agent_com/hub_fsm/history.ex
@lib/agent_com/hub_fsm/healing.ex
@lib/agent_com/hub_fsm/healing_history.ex
@test/agent_com/hub_fsm_test.exs
@test/support/dets_helpers.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FSM full-cycle integration tests</name>
  <files>test/agent_com/hub_fsm_integration_test.exs</files>
  <action>
Create `test/agent_com/hub_fsm_integration_test.exs` with `use ExUnit.Case, async: false`.

Setup block: Follow the exact pattern from hub_fsm_test.exs -- DetsHelpers.full_test_setup(), terminate/restart HubFSM, History.init_table()/clear(), on_exit cleanup.

Describe block "FSM full cycles" with these tests:

1. **"resting -> executing -> resting cycle with goal submission"**
   - Submit goal via GoalBacklog.submit(%{description: ..., success_criteria: ...})
   - send(pid, :tick), sleep 100
   - Assert fsm_state == :executing, cycle_count incremented
   - Delete goal, send tick again
   - Assert fsm_state == :resting
   - Assert history has both transitions

2. **"resting -> improving -> contemplating -> resting via messages"**
   - force_transition to :improving
   - Assert fsm_state == :improving, cycle_count incremented
   - Send {:improvement_cycle_complete, {:ok, %{findings: 0}}} to pid
   - Sleep 100, assert fsm_state == :contemplating (because findings==0 and contemplating budget not available will default)
   - Note: contemplating_budget_available depends on CostLedger -- if not available, improving exits to resting directly. To make this work: the test should check what happens. If CostLedger.check_budget(:contemplating) returns :ok (fresh DETS), this should transition to :contemplating. If not, assert resting.
   - Actually, fresh CostLedger with no usage should return :ok for check_budget, so contemplating transition should work.
   - Send {:contemplation_cycle_complete, %{}} to pid
   - Sleep 100, assert fsm_state == :resting

3. **"resting -> improving -> executing when goals arrive during improvement"**
   - force_transition to :improving
   - Submit a goal via GoalBacklog.submit
   - Send {:improvement_cycle_complete, {:ok, %{findings: 1}}} to pid (findings > 0 but goals exist)
   - Sleep 100, assert fsm_state == :executing (goals take priority)
   - Delete goal, send tick
   - Assert resting

4. **"transition_count increments on every transition"**
   - Record initial transition_count from get_state
   - force_transition to :executing, check +1
   - force_transition to :resting, check +2

5. **"history records all transitions with correct from/to/reason"**
   - force_transition :executing then :resting
   - Call HubFSM.history()
   - Assert entries include both transitions with correct from/to/reason fields
  </action>
  <verify>
Run: `mix test test/agent_com/hub_fsm_integration_test.exs --exclude healing`
All FSM cycle tests pass.
  </verify>
  <done>
5 FSM cycle tests pass covering resting->executing->resting, resting->improving->contemplating->resting, resting->improving->executing->resting, transition counting, and history recording.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add healing state and watchdog integration tests</name>
  <files>test/agent_com/hub_fsm_integration_test.exs</files>
  <action>
In the same test file, add describe block "healing state" with these tests:

1. **"force_transition to healing and exit via healing_cycle_complete"**
   - force_transition to :healing
   - Assert fsm_state == :healing
   - Send {:healing_cycle_complete, %{issues_found: 1, actions_taken: 1}} to pid
   - Sleep 100
   - Assert fsm_state == :resting
   - Assert history records both transitions

2. **"healing cooldown prevents immediate re-entry"**
   - force_transition to :healing
   - Send {:healing_cycle_complete, %{}} to pid, sleep 100
   - Assert :resting
   - Now try force_transition to :healing again -- this should succeed since force_transition bypasses predicates
   - Instead, test via predicates: call Predicates.evaluate(:resting, %{health_report: %{critical_count: 5}, healing_cooldown_active: true, healing_attempts_exhausted: false, ...})
   - Assert :stay (cooldown active blocks healing)
   - Then call with healing_cooldown_active: false
   - Assert {:transition, :healing, _reason}

3. **"healing attempts exhaustion prevents re-entry"**
   - Call Predicates.evaluate(:resting, %{health_report: %{critical_count: 5}, healing_cooldown_active: false, healing_attempts_exhausted: true, ...})
   - Assert :stay

4. **"healing watchdog forces transition to resting"**
   - force_transition to :healing
   - Assert :healing
   - Send :healing_watchdog message directly to pid
   - Sleep 100
   - Assert :resting
   - Check that healing history contains watchdog_timeout entry (HealingHistory.list should have entry with category :watchdog_timeout)

5. **"healing from any state via predicates"**
   - Test that Predicates.evaluate returns {:transition, :healing, _} for :resting, :executing, :improving, :contemplating when critical issues exist and no cooldown
   - Test that Predicates.evaluate(:healing, ...) returns :stay (already healing)

Add @tag :healing to healing tests if desired, but not required.
  </action>
  <verify>
Run: `mix test test/agent_com/hub_fsm_integration_test.exs`
All tests pass (both cycle and healing tests).
  </verify>
  <done>
5 healing tests pass covering healing entry/exit, cooldown prevention, attempts exhaustion, watchdog timeout with audit logging, and healing transition from all states.
  </done>
</task>

</tasks>

<verification>
```bash
mix test test/agent_com/hub_fsm_integration_test.exs --trace
```
All tests pass. No warnings. Test count >= 10.
</verification>

<success_criteria>
- 10+ integration tests covering all 5 FSM states
- Full cycle tests: resting->executing->resting, resting->improving->contemplating->resting, resting->improving->executing->resting
- Healing tests: entry, exit, cooldown, attempts exhaustion, watchdog timeout
- All tests use DetsHelpers isolation and manual tick/message control
- Zero test failures
</success_criteria>

<output>
After completion, create `.planning/phases/44-hub-fsm-testing/44-01-SUMMARY.md`
</output>

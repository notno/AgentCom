---
phase: 40-sidecar-tool-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidecar/lib/tools/tool-registry.js
  - sidecar/lib/tools/sandbox.js
  - sidecar/test/tools/tool-registry.test.js
  - sidecar/test/tools/sandbox.test.js
autonomous: true
must_haves:
  truths:
    - "ToolRegistry exports exactly 5 tool definitions in Ollama function-calling JSON format"
    - "Sandbox rejects file paths that resolve outside the workspace root"
    - "Sandbox rejects symlinks that point outside the workspace root"
    - "Sandbox blocks dangerous commands (sudo, rm -rf /, shutdown, etc.)"
  artifacts:
    - path: "sidecar/lib/tools/tool-registry.js"
      provides: "5 tool definitions in Ollama format"
      exports: ["getToolDefinitions", "getToolByName", "TOOLS"]
    - path: "sidecar/lib/tools/sandbox.js"
      provides: "Path validation, command blocking, SandboxError"
      exports: ["validatePath", "isCommandBlocked", "SandboxError"]
    - path: "sidecar/test/tools/tool-registry.test.js"
      provides: "Registry unit tests"
    - path: "sidecar/test/tools/sandbox.test.js"
      provides: "Sandbox security tests"
  key_links:
    - from: "sidecar/lib/tools/sandbox.js"
      to: "workspace root from WorkspaceManager"
      via: "validatePath(requestedPath, workspaceRoot)"
      pattern: "path\\.resolve.*startsWith"
---

<objective>
Create the tool definition registry and sandbox security module for the sidecar's tool execution layer.

Purpose: Provide Ollama-compatible tool definitions that Phase 41's ReAct loop will pass to /api/chat, and a security sandbox that all tool executions must pass through before touching the filesystem or running commands.

Output: tool-registry.js with 5 tool definitions, sandbox.js with path validation and command blocking, plus comprehensive unit tests for both.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-sidecar-tool-infrastructure/40-RESEARCH.md
@sidecar/lib/workspace-manager.js
@sidecar/lib/execution/shell-executor.js
@sidecar/lib/log.js
@sidecar/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tool registry with 5 Ollama-format definitions</name>
  <files>sidecar/lib/tools/tool-registry.js, sidecar/test/tools/tool-registry.test.js</files>
  <action>
Create `sidecar/lib/tools/tool-registry.js` exporting 5 tool definitions in Ollama function-calling format.

Each tool definition follows this structure:
```javascript
{ type: 'function', function: { name, description, parameters: { type: 'object', properties: {...}, required: [...] } } }
```

**5 tools to define:**

1. **read_file** — Read file contents with optional line range
   - params: `path` (string, required), `start_line` (integer, optional), `end_line` (integer, optional)
   - description: "Read the contents of a file. Returns content with line numbers. Use start_line/end_line to read a specific range."

2. **write_file** — Write/overwrite file contents
   - params: `path` (string, required), `content` (string, required), `create_dirs` (boolean, optional, default true)
   - description: "Write content to a file. Creates parent directories if needed. Overwrites existing content."

3. **list_directory** — List files and directories
   - params: `path` (string, required), `recursive` (boolean, optional, default false), `pattern` (string, optional)
   - description: "List files and directories at the given path. Use recursive=true for deep listing. Use pattern for glob filtering."

4. **run_command** — Execute a shell command
   - params: `command` (string, required), `timeout_ms` (integer, optional, default 30000)
   - description: "Execute a shell command in the workspace directory. Returns stdout, stderr, and exit code. Timeout default 30 seconds."

5. **search_files** — Regex search across files
   - params: `pattern` (string, required), `path` (string, optional, default "."), `file_pattern` (string, optional), `max_results` (integer, optional, default 50)
   - description: "Search for a regex pattern across files. Returns matching lines with file paths and line numbers. Max 50 results."

Exports: `getToolDefinitions()` returns the array, `getToolByName(name)` finds by name, `TOOLS` is the raw array.

**Test file** `sidecar/test/tools/tool-registry.test.js` using Node.js built-in test runner:
- Verify exactly 5 tools returned
- Each tool has type 'function' and function.name, function.description, function.parameters
- Each tool's parameters has type 'object' and required array
- getToolByName returns correct tool and null for unknown
- All 5 expected names present: read_file, write_file, list_directory, run_command, search_files
  </action>
  <verify>
Run `node --test sidecar/test/tools/tool-registry.test.js` — all tests pass.
Verify `node -e "const r = require('./sidecar/lib/tools/tool-registry'); console.log(r.getToolDefinitions().length)"` prints 5.
  </verify>
  <done>
ToolRegistry exports exactly 5 tool definitions, each with valid Ollama function-calling JSON structure, all tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sandbox module with path validation and command blocking</name>
  <files>sidecar/lib/tools/sandbox.js, sidecar/test/tools/sandbox.test.js</files>
  <action>
Create `sidecar/lib/tools/sandbox.js` with three exports:

**1. SandboxError class** — extends Error with a `code` property for structured error reporting.
Codes: `PATH_OUTSIDE_WORKSPACE`, `SYMLINK_OUTSIDE_WORKSPACE`, `COMMAND_BLOCKED`, `FILE_TOO_LARGE`.

**2. validatePath(requestedPath, workspaceRoot)** — returns the resolved absolute path or throws SandboxError.
Steps:
  a. `path.resolve(workspaceRoot, requestedPath)` to canonicalize
  b. Check resolved path starts with workspaceRoot (normalize with path.sep for Windows compatibility)
  c. If file exists, also `fs.realpathSync()` and check the real path starts with `fs.realpathSync(workspaceRoot)`
  d. On any violation, throw SandboxError with appropriate code

Edge cases to handle:
  - `../../../etc/passwd` — blocked by startsWith check
  - Absolute paths like `/etc/passwd` or `C:\Windows\system32` — blocked (doesn't start with workspace root)
  - `.` and `./foo` — allowed (within workspace)
  - Paths with trailing slashes — normalize before checking

**3. isCommandBlocked(command)** — returns boolean.
Blocked patterns (regex array):
  - `^sudo\b` — privilege escalation
  - `\brm\s+-rf\s+[/~]` — destructive deletes outside workspace
  - `^shutdown\b`, `^reboot\b` — system control
  - `^format\b`, `^mkfs\b` — disk formatting
  - `^dd\s+` — raw disk access
  - `^curl\b`, `^wget\b` — network access (agent communicates through hub)
  - `^nc\b`, `^netcat\b` — network access
  - `^python.*-m\s+http` — HTTP server
  - `^node.*--inspect` — debugger (security risk)

Also export the `BLOCKED_PATTERNS` array for test inspection.

**Test file** `sidecar/test/tools/sandbox.test.js`:
- validatePath allows relative paths within workspace
- validatePath allows `.` and `./subdir/file.txt`
- validatePath rejects `../../../etc/passwd`
- validatePath rejects absolute paths outside workspace
- validatePath rejects paths that resolve outside via many `..` levels
- SandboxError has correct code property
- isCommandBlocked blocks sudo, rm -rf /, shutdown, curl, wget, nc
- isCommandBlocked allows normal commands: `npm test`, `git status`, `ls`, `cat file.txt`, `node index.js`
- isCommandBlocked allows `rm file.txt` (non-destructive, within workspace)

Note: Symlink test can be skipped on Windows (use `process.platform !== 'win32'` guard) since symlinks require elevated privileges on Windows.
  </action>
  <verify>
Run `node --test sidecar/test/tools/sandbox.test.js` — all tests pass.
Manually verify: `node -e "const s = require('./sidecar/lib/tools/sandbox'); try { s.validatePath('../../etc/passwd', '/tmp/ws'); } catch(e) { console.log(e.code); }"` prints `PATH_OUTSIDE_WORKSPACE`.
  </verify>
  <done>
Sandbox validates all paths against workspace root, blocks dangerous commands, throws SandboxError with typed codes, and comprehensive tests pass.
  </done>
</task>

</tasks>

<verification>
1. `node --test sidecar/test/tools/tool-registry.test.js` — all pass
2. `node --test sidecar/test/tools/sandbox.test.js` — all pass
3. `node -e "const r = require('./sidecar/lib/tools/tool-registry'); console.log(JSON.stringify(r.getToolDefinitions()[0], null, 2))"` — outputs valid Ollama tool JSON
4. `node -e "const s = require('./sidecar/lib/tools/sandbox'); console.log(s.isCommandBlocked('sudo rm -rf /'))"` — outputs `true`
5. `node -e "const s = require('./sidecar/lib/tools/sandbox'); console.log(s.isCommandBlocked('npm test'))"` — outputs `false`
</verification>

<success_criteria>
- ToolRegistry exports 5 tool definitions matching Ollama function-calling JSON format (AGENT-01)
- Sandbox path validation blocks traversal attacks (AGENT-02 partial)
- Sandbox command blocking prevents dangerous operations (AGENT-02 partial)
- All unit tests pass
- Zero new npm dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/40-sidecar-tool-infrastructure/40-01-SUMMARY.md`
</output>

---
phase: 22-self-verification-loop
plan: 03
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - lib/agent_com/dashboard.ex
autonomous: true

must_haves:
  truths:
    - "When a task has verification_attempts > 1, the dashboard shows an attempt count badge (e.g., '2/3 attempts')"
    - "The verification badge shows the LATEST report status (pass/fail/error) as the primary indicator"
    - "Clicking the expandable details shows per-iteration summary with check pass/fail counts per attempt"
    - "Tasks with verification_attempts of 0 or 1 display exactly as before (no 'attempts' badge, backward compatible)"
  artifacts:
    - path: "lib/agent_com/dashboard.ex"
      provides: "Verification history display with per-iteration expandable details"
      contains: "verification_attempts"
  key_links:
    - from: "lib/agent_com/dashboard.ex"
      to: "lib/agent_com/task_queue.ex"
      via: "task.verification_history read in dashboard render"
      pattern: "verification_history"
---

<objective>
Extend the dashboard to display verification retry history with per-iteration results.

Purpose: Success Criterion 3 requires each verification retry iteration to be visible in the task result. The dashboard's renderVerifyBadge function is extended to show attempt count and per-iteration check results for tasks that went through the retry loop, while remaining identical for single-attempt tasks.

Output: Updated dashboard.ex with enhanced renderVerifyBadge showing retry iteration history.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-self-verification-loop/22-RESEARCH.md
@.planning/phases/22-self-verification-loop/22-01-SUMMARY.md

@lib/agent_com/dashboard.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS styles for verification retry display</name>
  <files>lib/agent_com/dashboard.ex</files>
  <action>
Find the existing CSS block that defines verification badge styles (`.vbadge`, `.vpass`, `.vfail`, etc.) in the dashboard HTML. Add these new styles after the existing verification CSS:

```css
.v-attempts {
  font-size: 0.75em;
  color: #aaa;
  margin-left: 4px;
}
.v-retry-history {
  margin-top: 4px;
  padding-left: 8px;
  border-left: 2px solid #333;
}
.v-retry-row {
  font-size: 0.8em;
  color: #bbb;
  padding: 2px 0;
}
.v-retry-row .v-attempt-num {
  color: #888;
  font-weight: bold;
  margin-right: 4px;
}
.v-retry-pass { color: #4ade80; }
.v-retry-fail { color: #f87171; }
```

These styles are minimal -- they add an attempt count badge and an expandable per-iteration history section without changing the existing badge appearance.
  </action>
  <verify>
    Grep for `v-attempts` in dashboard.ex returns a match.
  </verify>
  <done>
    CSS styles for verification retry display are added to the dashboard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance renderVerifyBadge to show retry history</name>
  <files>lib/agent_com/dashboard.ex</files>
  <action>
Modify the `renderVerifyBadge(report)` JavaScript function in dashboard.ex to handle verification retry history. The function currently receives a single `report` object. The task's completed data now also includes `verification_history` (array of reports) and `verification_attempts` (integer).

Update the function signature to accept a second parameter: `renderVerifyBadge(report, task)` where `task` is the full completed task object (or null).

**Changes to renderVerifyBadge:**

1. After the existing badge HTML construction (the `var html = '<span class="vbadge ...">'` line), add:
   ```javascript
   // Show attempt count badge if multiple attempts
   var attempts = (task && task.verification_attempts) || 0;
   var history = (task && task.verification_history) || [];
   if (attempts > 1) {
     html += '<span class="v-attempts">' + attempts + ' attempts</span>';
   }
   ```

2. After the existing `</details>` for check results (the `checks.forEach` block), add a retry history section that appears when there are multiple iterations:
   ```javascript
   if (history.length > 1) {
     html += '<details class="verify-details"><summary>Retry history (' + history.length + ' runs)</summary>';
     html += '<div class="v-retry-history">';
     history.forEach(function(run, idx) {
       var runSummary = run.summary || {};
       var passed = runSummary.passed || 0;
       var total = runSummary.total || 0;
       var failed = total - passed;
       var statusCls = run.status === 'pass' ? 'v-retry-pass' : 'v-retry-fail';
       html += '<div class="v-retry-row">';
       html += '<span class="v-attempt-num">Run ' + (idx + 1) + ':</span>';
       html += '<span class="' + statusCls + '">' + escapeHtml(run.status || 'unknown') + '</span>';
       html += ' (' + passed + '/' + total + ' passed)';
       if (run.duration_ms) html += ' ' + formatDuration(run.duration_ms);
       html += '</div>';
     });
     html += '</div></details>';
   }
   ```

3. Find all call sites of `renderVerifyBadge(c.verification_report)` in dashboard.ex and update them to pass the task object: `renderVerifyBadge(c.verification_report, c)`. There should be one call site in the recent tasks table row rendering (around line 1798 area).

4. In the `handle_info({:push_task, task}, state)` section of socket.ex (already modified in Plan 02), the `verification_history` field on the completed task is available through the task data sent to the dashboard via PubSub. Verify that the dashboard state's completed tasks ring buffer includes `verification_history` and `verification_attempts` -- these come from the task_queue completed task struct which already stores these fields (added in Plan 02).

Ensure backward compatibility: when `task` is null/undefined or `verification_attempts` is 0/1, the function behaves exactly as before (no "attempts" badge, no retry history section).
  </action>
  <verify>
    `cd C:/Users/nrosq/src/AgentCom && mix compile --warnings-as-errors` compiles without errors. Grep for `v-attempts` and `verification_history` in dashboard.ex each return matches. Grep for `renderVerifyBadge(c.verification_report, c)` shows the updated call site.
  </verify>
  <done>
    Dashboard shows attempt count badge for multi-attempt tasks. Expandable retry history displays per-iteration pass/fail summary. Single-attempt tasks display identically to before.
  </done>
</task>

</tasks>

<verification>
- `mix compile --warnings-as-errors` passes
- Dashboard renderVerifyBadge handles both single-attempt and multi-attempt cases
- CSS for retry display is present
- Call sites updated to pass task object
</verification>

<success_criteria>
- Tasks with multiple verification attempts show attempt count badge
- Expandable retry history shows per-iteration pass/fail counts
- Single-attempt tasks display unchanged (backward compatible)
- Dashboard compiles without warnings
</success_criteria>

<output>
After completion, create `.planning/phases/22-self-verification-loop/22-03-SUMMARY.md`
</output>

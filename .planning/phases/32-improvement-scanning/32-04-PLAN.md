---
phase: 32-improvement-scanning
plan: 04
type: tdd
wave: 2
depends_on: ["32-01", "32-02"]
files_modified:
  - test/agent_com/self_improvement/finding_test.exs
  - test/agent_com/self_improvement/improvement_history_test.exs
  - test/agent_com/self_improvement/deterministic_scanner_test.exs
  - test/agent_com/self_improvement/credo_scanner_test.exs
  - test/agent_com/self_improvement/dialyzer_scanner_test.exs
  - test/agent_com/self_improvement_test.exs
autonomous: true

must_haves:
  truths:
    - "Finding struct creation and field validation tested"
    - "ImprovementHistory DETS operations tested (record, cooldown, oscillation)"
    - "Anti-oscillation detection correctly identifies inverse patterns"
    - "File cooldowns correctly block re-scanning within window"
    - "DeterministicScanner detects test gaps, doc gaps, and dead deps from fixture data"
    - "CredoScanner correctly parses sample Credo JSON output"
    - "DialyzerScanner correctly parses sample Dialyzer short output"
    - "SelfImprovement orchestrator applies filtering and respects max_findings budget"
  artifacts:
    - path: "test/agent_com/self_improvement/finding_test.exs"
      provides: "Finding struct tests"
      contains: "FindingTest"
    - path: "test/agent_com/self_improvement/improvement_history_test.exs"
      provides: "History, cooldown, oscillation tests"
      contains: "ImprovementHistoryTest"
    - path: "test/agent_com/self_improvement/deterministic_scanner_test.exs"
      provides: "Test gap, doc gap, dead dep tests"
      contains: "DeterministicScannerTest"
  key_links:
    - from: "test/agent_com/self_improvement/improvement_history_test.exs"
      to: "lib/agent_com/self_improvement/improvement_history.ex"
      via: "Tests DETS init/record/cooldown/oscillation APIs"
      pattern: "ImprovementHistory\\."
---

<objective>
Create comprehensive test suite for the SelfImprovement modules using TDD.

Purpose: Validate all scanning, filtering, and anti-Sisyphus protections work correctly. Tests use fixtures and mocks to avoid requiring actual Credo/Dialyzer/git installations in CI.

Output: Test suite covering Finding struct, ImprovementHistory, all three deterministic scanners, and the SelfImprovement orchestrator.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-improvement-scanning/32-RESEARCH.md
@.planning/phases/32-improvement-scanning/32-01-SUMMARY.md
@.planning/phases/32-improvement-scanning/32-02-SUMMARY.md
@lib/agent_com/self_improvement/finding.ex
@lib/agent_com/self_improvement/improvement_history.ex
@lib/agent_com/self_improvement/credo_scanner.ex
@lib/agent_com/self_improvement/dialyzer_scanner.ex
@lib/agent_com/self_improvement/deterministic_scanner.ex
@test/support/dets_helpers.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test Finding struct and ImprovementHistory</name>
  <files>
    test/agent_com/self_improvement/finding_test.exs
    test/agent_com/self_improvement/improvement_history_test.exs
  </files>
  <action>
**Create `test/agent_com/self_improvement/finding_test.exs`:**
- Module: `AgentCom.SelfImprovement.FindingTest`
- `use ExUnit.Case, async: true` (pure struct, no shared state)
- Tests:
  - `test "creates finding with all required fields"` -- verify struct creation
  - `test "finding has correct field types"` -- verify scanner is atom, line_number is integer, etc.
  - `test "finding fields are accessible"` -- basic field access pattern

**Create `test/agent_com/self_improvement/improvement_history_test.exs`:**
- Module: `AgentCom.SelfImprovement.ImprovementHistoryTest`
- `use ExUnit.Case, async: false` (DETS shared state)
- Use DetsHelpers for test isolation: follow the pattern from existing tests. In setup, initialize ImprovementHistory with a test-specific data dir (via Application.put_env), call init(), and on_exit call close() + cleanup.

Setup:
```elixir
setup do
  test_dir = Path.join(System.tmp_dir!(), "test_improvement_history_#{:erlang.unique_integer([:positive])}")
  File.mkdir_p!(test_dir)
  Application.put_env(:agent_com, :improvement_history_data_dir, test_dir)

  AgentCom.SelfImprovement.ImprovementHistory.init()

  on_exit(fn ->
    AgentCom.SelfImprovement.ImprovementHistory.close()
    File.rm_rf!(test_dir)
    Application.delete_env(:agent_com, :improvement_history_data_dir)
  end)

  :ok
end
```

Tests:
- `test "init creates DETS table"` -- init returns :ok
- `test "record_improvement stores entry"` -- record then all_records confirms data
- `test "record_improvement keeps last 10 entries"` -- record 12, verify only 10 stored
- `test "cooled_down? returns true within cooldown window"` -- record, immediately check = true
- `test "cooled_down? returns false after cooldown expires"` -- record with timestamp manipulation or use a very short cooldown_ms
- `test "cooled_down? returns false for unknown file"` -- check unrecorded file
- `test "oscillating? returns false with fewer than 3 records"` -- 0, 1, 2 records
- `test "oscillating? detects add/remove inverse pattern"` -- record "add function", "remove function", "add function" -> true
- `test "oscillating? detects extract/inline inverse pattern"` -- record with extract/inline descriptions -> true
- `test "oscillating? returns false for non-inverse descriptions"` -- record "fix typo", "add test", "update docs" -> false
- `test "filter_cooled_down removes cooled-down findings"` -- create findings, record one file, filter removes it
- `test "filter_oscillating removes oscillating findings"` -- create findings for oscillating file, filter removes it
- `test "clear removes all records"` -- record, clear, all_records returns empty
  </action>
  <verify>
    `mix test test/agent_com/self_improvement/finding_test.exs test/agent_com/self_improvement/improvement_history_test.exs --trace` -- all tests pass.
  </verify>
  <done>
    Finding struct tests validate creation and field access. ImprovementHistory tests cover DETS persistence, cooldown window behavior, oscillation detection with inverse patterns, and filter functions. All anti-Sisyphus protections are tested.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test scanners and SelfImprovement orchestrator</name>
  <files>
    test/agent_com/self_improvement/deterministic_scanner_test.exs
    test/agent_com/self_improvement/credo_scanner_test.exs
    test/agent_com/self_improvement/dialyzer_scanner_test.exs
    test/agent_com/self_improvement_test.exs
  </files>
  <action>
**Create `test/agent_com/self_improvement/deterministic_scanner_test.exs`:**
- Module: `AgentCom.SelfImprovement.DeterministicScannerTest`
- `use ExUnit.Case, async: true`
- Create temporary fixture directory structure in setup:
  ```
  tmp/test_repo/
    mix.exs (with {:jason, "~> 1.4"}, {:unused_dep, "~> 0.1"})
    lib/
      my_app.ex (has defmodule, has @moduledoc)
      my_app/
        no_doc.ex (has defmodule, NO @moduledoc)
        with_test.ex (has defmodule, has @moduledoc)
    test/
      my_app/
        with_test_test.exs (exists)
  ```
- Tests:
  - `test "detects test gap for module without test file"` -- my_app.ex and no_doc.ex have no test files
  - `test "does not flag module with existing test file"` -- with_test.ex has with_test_test.exs
  - `test "detects doc gap for module without @moduledoc"` -- no_doc.ex missing moduledoc
  - `test "does not flag module with @moduledoc"` -- my_app.ex has moduledoc
  - `test "detects dead dependency"` -- :unused_dep not referenced in source
  - `test "does not flag used dependency"` -- :jason referenced as Jason in source
  - `test "returns empty for non-existent repo"` -- scan non-existent path returns []
- Cleanup fixture dir in on_exit

**Create `test/agent_com/self_improvement/credo_scanner_test.exs`:**
- Module: `AgentCom.SelfImprovement.CredoScannerTest`
- `use ExUnit.Case, async: true`
- Test the parsing logic directly by testing the module's internal behavior:
  - `test "returns empty for repo without credo"` -- create fixture with mix.exs lacking :credo
  - `test "returns empty for non-existent repo"` -- scan "/tmp/nonexistent_xyz" returns []
- Note: Cannot easily test actual Credo execution in unit tests. The parsing logic is straightforward JSON decode. Focus on edge cases and the has_credo? check.

**Create `test/agent_com/self_improvement/dialyzer_scanner_test.exs`:**
- Module: `AgentCom.SelfImprovement.DialyzerScannerTest`
- `use ExUnit.Case, async: true`
- Similar approach:
  - `test "returns empty for repo without dialyxir"` -- fixture without :dialyxir
  - `test "returns empty for non-existent repo"` -- scan non-existent path

**Create `test/agent_com/self_improvement_test.exs`:**
- Module: `AgentCom.SelfImprovementTest`
- `use ExUnit.Case, async: false` (uses ImprovementHistory DETS)
- Setup: create test fixture repo dir AND initialize ImprovementHistory (same pattern as history test)
- Tests:
  - `test "scan_repo returns findings from deterministic scanner"` -- scan fixture repo, verify findings returned
  - `test "scan_repo respects max_findings budget"` -- set max_findings: 1, verify only 1 finding returned
  - `test "scan_repo filters cooled-down files"` -- record an improvement for a file, scan again, that file excluded
  - `test "submit_findings_as_goals creates low-priority goals"` -- mock or start GoalBacklog, submit findings, verify goal priority is "low" and source is "self_improvement"

For the GoalBacklog integration test: if GoalBacklog is already started in test setup (check test_helper.exs), use it directly. Otherwise, start it with a test-specific DETS dir. Follow existing test patterns.
  </action>
  <verify>
    `mix test test/agent_com/self_improvement/ --trace` -- all tests pass.
    `mix test test/agent_com/self_improvement_test.exs --trace` -- orchestrator tests pass.
  </verify>
  <done>
    DeterministicScanner tests verify test gap, doc gap, and dead dep detection using fixture directories. Credo and Dialyzer scanner tests verify graceful handling of missing tools. SelfImprovement orchestrator tests verify budget enforcement, cooldown filtering, and goal submission with correct priority. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `mix test test/agent_com/self_improvement/ --trace` -- all tests pass
2. `mix test test/agent_com/self_improvement_test.exs --trace` -- orchestrator tests pass
3. No test isolation issues (DETS tests use unique temp dirs)
4. Coverage: Finding struct, ImprovementHistory (cooldowns + oscillation), DeterministicScanner (3 gap types), CredoScanner (skip logic), DialyzerScanner (skip logic), SelfImprovement (budget + filtering + goal submission)
</verification>

<success_criteria>
Comprehensive test suite validates all SelfImprovement modules. Anti-Sisyphus protections (cooldowns and oscillation detection) have dedicated test coverage. Scanner tests use fixtures to avoid external tool dependencies. Orchestrator tests verify end-to-end flow from scanning through goal submission.
</success_criteria>

<output>
After completion, create `.planning/phases/32-improvement-scanning/32-04-SUMMARY.md`
</output>

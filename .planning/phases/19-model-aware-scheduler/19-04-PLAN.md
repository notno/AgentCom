---
phase: 19-model-aware-scheduler
plan: 04
type: execute
wave: 3
depends_on: ["19-02"]
files_modified:
  - lib/agent_com/endpoint.ex
  - lib/agent_com/dashboard_state.ex
  - priv/static/dashboard.html
autonomous: true

must_haves:
  truths:
    - "Task detail in API response includes routing_decision fields"
    - "Dashboard task row shows routing summary (tier + endpoint)"
    - "Fallback tasks have a visual indicator (badge/icon)"
    - "Routing detail is expandable to show full decision trace"
    - "Dashboard snapshot includes aggregate routing stats (count by tier, fallback rate)"
  artifacts:
    - path: "lib/agent_com/endpoint.ex"
      provides: "routing_decision in task API response via format_task"
      contains: "routing_decision"
    - path: "lib/agent_com/dashboard_state.ex"
      provides: "Routing stats in dashboard snapshot"
      contains: "routing_stats"
    - path: "priv/static/dashboard.html"
      provides: "Routing column, fallback badge, expandable detail in task table"
      contains: "routing"
  key_links:
    - from: "lib/agent_com/endpoint.ex"
      to: "lib/agent_com/task_queue.ex"
      via: "format_task includes routing_decision from task map"
      pattern: "routing_decision"
    - from: "priv/static/dashboard.html"
      to: "lib/agent_com/dashboard_state.ex"
      via: "Dashboard reads routing_stats from snapshot"
      pattern: "routing_stats"
---

<objective>
Add routing visibility to the HTTP API and dashboard -- routing decision in task responses, routing column in dashboard task table, fallback badge indicator, and expandable routing trace detail.

Purpose: Implement the locked decision for routing transparency -- summary by default, expandable detail, visual indicator for fallback tasks. Operators can see where each task was routed and why.

Output: Routing decision in API responses, dashboard routing column with expandable detail, aggregate routing stats.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-model-aware-scheduler/19-CONTEXT.md
@.planning/phases/19-model-aware-scheduler/19-02-SUMMARY.md
@lib/agent_com/endpoint.ex
@lib/agent_com/dashboard_state.ex
@priv/static/dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Include routing_decision in API responses and dashboard snapshot</name>
  <files>
    lib/agent_com/endpoint.ex
    lib/agent_com/dashboard_state.ex
  </files>
  <action>
    **Endpoint (lib/agent_com/endpoint.ex):**

    In the `format_task/1` function (which serializes tasks for HTTP API responses), include the routing_decision field:

    ```elixir
    routing_decision = Map.get(task, :routing_decision)
    ```

    Add to the response map. If routing_decision is nil (task hasn't been routed yet), omit or return null. If present, serialize the atom keys to strings for JSON compatibility:

    ```elixir
    routing_decision: format_routing_decision(Map.get(task, :routing_decision))
    ```

    Add helper `format_routing_decision/1`:
    - nil -> nil
    - map -> Convert atom keys/values to strings for JSON: effective_tier, target_type, selected_endpoint, selected_model, fallback_used, fallback_from_tier, fallback_reason, candidate_count, classification_reason, estimated_cost_tier, decided_at

    **DashboardState (lib/agent_com/dashboard_state.ex):**

    In the `snapshot/0` function (or wherever the dashboard state is assembled), add aggregate routing stats. The DashboardState already aggregates task and agent data for the dashboard.

    Add a `routing_stats` section to the snapshot:

    ```elixir
    routing_stats: compute_routing_stats(tasks)
    ```

    `compute_routing_stats/1` iterates over recent assigned/completed tasks (those with routing_decision != nil) and computes:
    - `by_tier: %{"trivial" => count, "standard" => count, "complex" => count}`
    - `by_target: %{"sidecar" => count, "ollama" => count, "claude" => count}`
    - `fallback_count: integer` (count of tasks where fallback_used == true)
    - `total_routed: integer`

    Use the existing tasks from the snapshot data (DashboardState already has access to task lists).
  </action>
  <verify>
    `mix compile --warnings-as-errors` -- no warnings.
    GET /api/tasks/:id returns routing_decision in response body when task has been routed.
    DashboardState.snapshot() includes routing_stats key.
  </verify>
  <done>
    API task responses include routing_decision with serialized fields. Dashboard snapshot includes routing_stats with tier counts, target counts, and fallback rate.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add routing column, fallback badge, and expandable detail to dashboard</name>
  <files>priv/static/dashboard.html</files>
  <action>
    **Dashboard (priv/static/dashboard.html):**

    In the task table section of the dashboard:

    1. **Add "Routing" column header** to the task table (after Status or before Actions).

    2. **Routing cell content:** For each task row, display:
       - If routing_decision is nil: "-" (not yet routed)
       - If routing_decision exists: Show tier badge + endpoint summary
         - Tier badge: colored label matching tier (green=trivial, blue=standard, purple=complex)
         - Endpoint: shortened display (e.g., "192.168.1.10" or "claude" or "sidecar")
       - If fallback_used: Add a small "FB" badge (orange background) or a warning icon next to the tier badge. Per locked decision: "Visual indicator for fallback tasks: badge or icon on tasks that didn't run on their preferred tier"

    3. **Expandable detail:** Per locked decision: "Expandable detail on dashboard: summary by default, click to expand full routing trace."
       - Add a small expand/collapse toggle (chevron or [+]) next to the routing summary
       - When expanded, show a detail block below the row (or inline) with:
         - Classification reason (from routing_decision.classification_reason)
         - Candidate count
         - Selected model
         - Fallback reason (if applicable)
         - Estimated cost tier
         - Decided at timestamp
       - Use CSS for the expand/collapse (hidden by default, shown on click)
       - JavaScript toggle: add a click handler that toggles a `routing-detail` div

    4. **Routing stats summary:** In the dashboard header/summary area (where queue depth and agent counts are shown), add a small routing summary:
       - "Routed: {total} (trivial: {n}, standard: {n}, complex: {n}, fallbacks: {n})"
       - Read from the routing_stats in the snapshot data

    Implementation notes:
    - The dashboard uses vanilla HTML/JS with WebSocket updates from the hub
    - Follow existing patterns for adding columns and data display
    - Keep the styling consistent with existing badge/label patterns in the dashboard
    - The dashboard already receives task data via WebSocket -- routing_decision will be included if present in the task map
    - For the expandable detail, use a simple CSS class toggle pattern (no framework needed)
  </action>
  <verify>
    Open dashboard in browser. Verify:
    1. Routing column appears in task table
    2. Routed tasks show tier badge + endpoint
    3. Fallback tasks show orange "FB" badge
    4. Clicking expand toggle shows full routing trace
    5. Routing stats appear in summary area
    `mix compile --warnings-as-errors` -- no warnings (dashboard is static HTML, no compilation).
  </verify>
  <done>
    Dashboard shows routing summary by default with tier badge and endpoint. Fallback tasks have visual FB indicator. Expandable detail shows full routing trace. Routing stats in dashboard header.
  </done>
</task>

</tasks>

<verification>
1. `mix compile --warnings-as-errors` -- no warnings
2. `mix test` -- full test suite passes, no regressions
3. API task responses include routing_decision
4. Dashboard displays routing column, fallback badge, expandable detail
5. Dashboard shows aggregate routing stats
</verification>

<success_criteria>
- Every routed task's routing_decision is visible via API and dashboard
- Fallback tasks are visually distinguishable from normally-routed tasks
- Full routing trace is available via expandable detail (not cluttering the default view)
- Aggregate routing stats give operators a quick overview of routing distribution
</success_criteria>

<output>
After completion, create `.planning/phases/19-model-aware-scheduler/19-04-SUMMARY.md`
</output>

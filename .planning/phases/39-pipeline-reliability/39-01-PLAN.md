---
phase: 39-pipeline-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidecar/index.js
  - sidecar/lib/wake.js
autonomous: true
must_haves:
  truths:
    - "Task with no wake_command and no routing_decision immediately fails with clear error"
    - "Sidecar sends wake_result message to hub after wake command exits (success or failure)"
    - "Hub rejects stale wake_result for tasks already requeued"
  artifacts:
    - path: "sidecar/index.js"
      provides: "Fail-fast for missing wake_command, wake_result reporting"
    - path: "sidecar/lib/wake.js"
      provides: "Wake result message construction"
  key_links:
    - from: "sidecar/index.js wakeAgent()"
      to: "hub via WebSocket"
      via: "wake_result message"
      pattern: "type.*wake_result"
---

<objective>
Fix the critical no-wake-command hang and add wake failure reporting to the sidecar.

Purpose: PIPE-07 is the highest-priority bug -- tasks silently hang forever when wake_command is not configured and no routing_decision is present. PIPE-01 adds wake_result reporting so the hub knows whether waking succeeded or failed.

Output: Sidecar fails fast on missing wake prerequisites, reports wake outcomes to hub.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-pipeline-reliability/39-RESEARCH.md
@sidecar/index.js
@sidecar/lib/wake.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: PIPE-07 -- No-wake-command fail-fast</name>
  <files>sidecar/index.js</files>
  <action>
Fix the `wakeAgent()` function (lines 95-151) to fail immediately when no wake_command is configured AND the task has no routing_decision with a non-wake target_type.

Current broken code (lines 96-104):
```javascript
if (!wakeCommand) {
    log('info', 'wake_skipped', { task_id: task.task_id, reason: 'no wake_command configured' });
    task.status = 'working';
    saveQueue(QUEUE_PATH, _queue);
    return;
}
```

Replace with fail-fast logic:
```javascript
if (!wakeCommand) {
    log('error', 'no_wake_command', {
        task_id: task.task_id,
        reason: 'wake_command not configured and no execution routing available'
    });
    task.status = 'failed';
    saveQueue(QUEUE_PATH, _queue);
    hub.sendTaskFailed(task.task_id, 'no_wake_command_configured');
    _queue.active = null;
    saveQueue(QUEUE_PATH, _queue);
    return;
}
```

Note: This code path is only reached for tasks going through the wake flow (line 726-728 in handleTaskAssign). Tasks with routing_decision already go through executeTask() at line 723-724, so we don't need to check routing_decision here -- if we're in wakeAgent(), we already know there's no routing_decision.
  </action>
  <verify>
1. Read the modified wakeAgent() function and confirm the no-wake path now sets status to 'failed', sends task_failed to hub, and clears the active task.
2. Confirm the log level is 'error' (not 'info').
3. Confirm _queue.active is set to null after failure (prevents sidecar from being stuck "busy").
  </verify>
  <done>When wakeAgent() is called with no wake_command configured, the task is immediately failed with reason 'no_wake_command_configured', reported to the hub, and the sidecar returns to idle (active=null).</done>
</task>

<task type="auto">
  <name>Task 2: PIPE-01 -- Wake result reporting</name>
  <files>sidecar/index.js, sidecar/lib/wake.js</files>
  <action>
Add wake_result reporting to the wakeAgent() function so the hub knows whether the wake command succeeded or failed.

1. After a successful wake command execution (line 120-127), send a wake_result message to the hub:
```javascript
hub.send({
    type: 'wake_result',
    task_id: task.task_id,
    status: 'success',
    attempt: attempt
});
```

2. After all wake retries are exhausted and the task fails (line 137-148), the existing sendTaskFailed() already reports failure. Add a wake_result message before it for symmetry and explicit wake-level reporting:
```javascript
hub.send({
    type: 'wake_result',
    task_id: task.task_id,
    status: 'failed',
    attempt: attempt,
    error: err.message
});
```

3. For the fail-fast case from Task 1 (no wake_command), also send a wake_result:
```javascript
hub.send({
    type: 'wake_result',
    task_id: task.task_id,
    status: 'failed',
    attempt: 0,
    error: 'no_wake_command_configured'
});
```

4. After the confirmation timeout fires (line 162-178), send a wake_result with status 'timeout':
```javascript
hub.send({
    type: 'wake_result',
    task_id: task.task_id,
    status: 'timeout',
    reason: 'confirmation_timeout'
});
```

Note: The hub side handling of wake_result messages will be added in Plan 39-02 (hub-side changes). For now, the hub will log "unknown_message_type" for wake_result -- that is expected and harmless.
  </action>
  <verify>
1. Search the modified index.js for all occurrences of 'wake_result' -- should find 4 (success, failed, no-wake-command, confirmation timeout).
2. Each wake_result message must include type, task_id, and status fields.
3. Existing sendTaskFailed() calls are preserved (wake_result is additional, not a replacement).
  </verify>
  <done>Sidecar sends wake_result messages on all wake outcomes: success (after wake command exits 0), failed (after retries exhausted), failed/no-wake (when wake_command not configured), and timeout (when confirmation timer fires).</done>
</task>

</tasks>

<verification>
1. No-wake-command scenario: wakeAgent() with no wake_command immediately fails and clears active task
2. Wake success scenario: wake command succeeds, wake_result(success) sent, confirmation timeout starts
3. Wake failure scenario: all retries exhausted, wake_result(failed) sent, sendTaskFailed() called
4. Confirmation timeout: timer fires, wake_result(timeout) sent, sendTaskFailed() called
5. Existing routing_decision flow is unchanged (tasks with routing go to executeTask(), not wakeAgent())
</verification>

<success_criteria>
- PIPE-07: Task with missing wake_command fails immediately (not silently stuck in working state)
- PIPE-01: Sidecar reports wake success/failure via wake_result WebSocket message on every wake outcome
- No regression: tasks with routing_decision still execute via executeTask()
- No regression: wake command retry logic (3 attempts with 5s/15s/30s delays) still works
</success_criteria>

<output>
After completion, create `.planning/phases/39-pipeline-reliability/39-01-SUMMARY.md`
</output>

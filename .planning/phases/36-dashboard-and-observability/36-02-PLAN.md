---
phase: 36-dashboard-and-observability
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - lib/agent_com/dashboard.ex
autonomous: true

must_haves:
  truths:
    - "Dashboard shows Goal Progress panel with pending/active/completed counts and per-goal lifecycle rows with task progress"
    - "Dashboard shows Cost Tracking panel with hourly/daily/session invocation counts and per-state budget utilization bars"
    - "Dashboard Hub FSM panel shows state duration metrics (time in current state)"
    - "Goal events from WebSocket update goal progress panel in real-time"
    - "Color-coded FSM states: green=Executing, gray=Resting, blue=Improving, yellow=Contemplating, red=Paused"
  artifacts:
    - path: "lib/agent_com/dashboard.ex"
      provides: "Goal Progress panel, Cost Tracking panel, enhanced Hub FSM panel with state duration"
      contains: "panel-goal-progress"
  key_links:
    - from: "lib/agent_com/dashboard.ex"
      to: "DashboardState snapshot"
      via: "applyFullSnapshot JS function"
      pattern: "renderGoalProgress|renderCostTracking"
    - from: "lib/agent_com/dashboard.ex"
      to: "WebSocket events"
      via: "event switch in JS"
      pattern: "goal_event"
---

<objective>
Add Goal Progress and Cost Tracking panels to the dashboard HTML, plus enhance the existing Hub FSM panel with state duration metrics.

Purpose: With backend data wired in 36-01, this plan adds the frontend rendering: a Goal Progress panel showing backlog depth and per-goal lifecycle with task progress, a Cost Tracking panel showing hub CLI invocation counts with budget utilization bars, and enhanced Hub FSM panel showing time spent in current state.

Output: Three visible panels in the dashboard providing full Hub FSM observability per locked decisions (DASH-01, DASH-02).
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-dashboard-and-observability/36-RESEARCH.md
@.planning/phases/36-dashboard-and-observability/36-01-SUMMARY.md
@lib/agent_com/dashboard.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Goal Progress and Cost Tracking panel HTML</name>
  <files>lib/agent_com/dashboard.ex</files>
  <action>
Add two new panels to the Dashboard tab HTML, placed after the existing Hub FSM panel (after the `</div>` that closes `panel-hub-fsm`). Follow existing panel structure with `.panel`, `.panel-title`, `.throughput-cards`, `.tp-card`, `.tp-value`, `.tp-label` classes.

**Goal Progress Panel:**
```html
<div class="panel" id="panel-goal-progress">
  <div class="panel-title">Goal Progress <span class="panel-count" id="goal-total-count" style="background: #2a2a3a; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; margin-left: 8px;">0</span></div>
  <div class="throughput-cards">
    <div class="tp-card">
      <div class="tp-value" id="goal-pending-count" style="color: #fbbf24;">0</div>
      <div class="tp-label">Pending</div>
    </div>
    <div class="tp-card">
      <div class="tp-value" id="goal-active-count" style="color: #4ade80;">0</div>
      <div class="tp-label">Active</div>
    </div>
    <div class="tp-card">
      <div class="tp-value" id="goal-complete-count" style="color: #60a5fa;">0</div>
      <div class="tp-label">Complete</div>
    </div>
    <div class="tp-card">
      <div class="tp-value" id="goal-failed-count" style="color: #ef4444;">0</div>
      <div class="tp-label">Failed</div>
    </div>
  </div>
  <div id="goal-lifecycle-list" style="margin-top: 10px; max-height: 300px; overflow-y: auto;"></div>
  <div id="goal-empty" class="empty-state" style="display: none;">No active goals</div>
</div>
```

**Cost Tracking Panel:**
```html
<div class="panel" id="panel-cost-tracking">
  <div class="panel-title">Hub Invocation Costs</div>
  <div class="throughput-cards">
    <div class="tp-card">
      <div class="tp-value" id="cost-hourly-total">0</div>
      <div class="tp-label">This Hour</div>
    </div>
    <div class="tp-card">
      <div class="tp-value" id="cost-daily-total">0</div>
      <div class="tp-label">Today</div>
    </div>
    <div class="tp-card">
      <div class="tp-value" id="cost-session-total">0</div>
      <div class="tp-label">Session</div>
    </div>
  </div>
  <div id="cost-budget-bars" style="margin-top: 10px;"></div>
</div>
```

Also **enhance the existing Hub FSM panel:** Add a new tp-card for state duration after the "Last Change" tp-card:
```html
<div class="tp-card">
  <div class="tp-value" id="hub-fsm-duration">--</div>
  <div class="tp-label">In State</div>
</div>
```
  </action>
  <verify>Run `mix compile --warnings-as-errors` to confirm valid Elixir heredoc HTML.</verify>
  <done>Dashboard HTML contains Goal Progress panel with 4 count cards and lifecycle list area, Cost Tracking panel with 3 count cards and budget bars area, and Hub FSM panel has state duration card.</done>
</task>

<task type="auto">
  <name>Task 2: Add JavaScript render functions and event handling</name>
  <files>lib/agent_com/dashboard.ex</files>
  <action>
Add JavaScript functions in the dashboard's inline `<script>` section. Place after the existing `renderHubFSM` function.

**1. renderGoalProgress function:**
```javascript
function renderGoalProgress(stats, activeGoals) {
  var byStatus = (stats && stats.by_status) || {};
  var submitted = byStatus.submitted || 0;
  var decomposing = byStatus.decomposing || 0;
  var executing = byStatus.executing || 0;
  var verifying = byStatus.verifying || 0;
  var complete = byStatus.complete || 0;
  var failed = byStatus.failed || 0;

  document.getElementById('goal-pending-count').textContent = submitted;
  document.getElementById('goal-active-count').textContent = decomposing + executing + verifying;
  document.getElementById('goal-complete-count').textContent = complete;
  document.getElementById('goal-failed-count').textContent = failed;
  document.getElementById('goal-total-count').textContent = (stats && stats.total) || 0;

  var container = document.getElementById('goal-lifecycle-list');
  var emptyEl = document.getElementById('goal-empty');
  var goals = activeGoals || [];

  if (goals.length === 0) {
    container.innerHTML = '';
    emptyEl.style.display = '';
    return;
  }
  emptyEl.style.display = 'none';

  var stages = ['submitted', 'decomposing', 'executing', 'verifying', 'complete'];
  var stageColors = {submitted: '#6b7280', decomposing: '#fbbf24', executing: '#4ade80', verifying: '#60a5fa', complete: '#a78bfa'};

  var html = goals.map(function(goal) {
    var currentIdx = stages.indexOf(String(goal.status));
    var progressPct = goal.tasks_total > 0 ? Math.round((goal.tasks_complete / goal.tasks_total) * 100) : 0;

    var stageHtml = stages.map(function(stage, i) {
      var dotColor = i < currentIdx ? stageColors[stage] : (i === currentIdx ? stageColors[stage] : '#3a3a4a');
      var opacity = i <= currentIdx ? '1' : '0.4';
      return '<span style="display: inline-flex; align-items: center; gap: 2px; opacity: ' + opacity + ';">'
        + '<span style="width: 8px; height: 8px; border-radius: 50%; background: ' + dotColor + '; display: inline-block;"></span>'
        + '<span style="font-size: 0.7em; color: #aaa;">' + stage.charAt(0).toUpperCase() + '</span>'
        + '</span>';
    }).join('<span style="color: #3a3a4a; margin: 0 2px;">&rarr;</span>');

    var progressBar = goal.tasks_total > 0
      ? '<div style="flex: 1; background: #1a1a2e; border-radius: 3px; height: 8px; margin-left: 8px;">'
        + '<div style="width: ' + progressPct + '%; background: #4ade80; height: 100%; border-radius: 3px; transition: width 0.3s;"></div>'
        + '</div>'
        + '<span style="font-size: 0.75em; color: #aaa; margin-left: 6px; white-space: nowrap;">' + goal.tasks_complete + '/' + goal.tasks_total + '</span>'
      : '';

    return '<div style="padding: 6px 0; border-bottom: 1px solid #2a2a3a;">'
      + '<div style="display: flex; justify-content: space-between; align-items: center;">'
      + '<span style="color: #e0e0e0; font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%;">' + escapeHtml(String(goal.description).substring(0, 80)) + '</span>'
      + '<div style="display: flex; align-items: center; flex: 1; margin-left: 8px;">' + progressBar + '</div>'
      + '</div>'
      + '<div style="display: flex; align-items: center; gap: 4px; margin-top: 4px;">' + stageHtml + '</div>'
      + '</div>';
  }).join('');

  container.innerHTML = html;
}
```

**2. renderCostTracking function:**
```javascript
function renderCostTracking(stats) {
  if (!stats) return;

  var hourly = stats.hourly || {};
  var daily = stats.daily || {};
  var session = stats.session || {};
  var budgets = stats.budgets || {};

  document.getElementById('cost-hourly-total').textContent = hourly.total || 0;
  document.getElementById('cost-daily-total').textContent = daily.total || 0;
  document.getElementById('cost-session-total').textContent = session.total || 0;

  // Render per-state budget bars
  var barsContainer = document.getElementById('cost-budget-bars');
  var states = ['executing', 'improving', 'contemplating'];
  var stateLabels = {executing: 'Executing', improving: 'Improving', contemplating: 'Contemplating'};

  var barsHtml = states.map(function(st) {
    var budget = budgets[st] || {};
    var hourlyLimit = budget.hourly_limit || 0;
    var dailyLimit = budget.daily_limit || 0;
    var hourlyUsed = (hourly[st] !== undefined) ? hourly[st] : (hourly[String(st)] || 0);
    var dailyUsed = (daily[st] !== undefined) ? daily[st] : (daily[String(st)] || 0);

    if (hourlyLimit === 0 && dailyLimit === 0) return '';

    var hourlyPct = hourlyLimit > 0 ? Math.min(100, (hourlyUsed / hourlyLimit) * 100) : 0;
    var dailyPct = dailyLimit > 0 ? Math.min(100, (dailyUsed / dailyLimit) * 100) : 0;
    var hourlyColor = hourlyPct > 80 ? '#ef4444' : hourlyPct > 50 ? '#fbbf24' : '#4ade80';
    var dailyColor = dailyPct > 80 ? '#ef4444' : dailyPct > 50 ? '#fbbf24' : '#4ade80';

    return '<div style="margin-bottom: 8px;">'
      + '<div style="color: #aaa; font-size: 0.8em; margin-bottom: 2px;">' + (stateLabels[st] || st) + '</div>'
      + '<div style="display: flex; gap: 8px; align-items: center;">'
      + '<span style="font-size: 0.75em; color: #888; width: 50px;">Hourly</span>'
      + '<div style="flex: 1; background: #1a1a2e; border-radius: 3px; height: 12px;">'
      + '<div style="width: ' + hourlyPct + '%; background: ' + hourlyColor + '; height: 100%; border-radius: 3px;"></div>'
      + '</div>'
      + '<span style="font-size: 0.75em; color: #aaa; width: 60px; text-align: right;">' + hourlyUsed + '/' + hourlyLimit + '</span>'
      + '</div>'
      + '<div style="display: flex; gap: 8px; align-items: center; margin-top: 2px;">'
      + '<span style="font-size: 0.75em; color: #888; width: 50px;">Daily</span>'
      + '<div style="flex: 1; background: #1a1a2e; border-radius: 3px; height: 12px;">'
      + '<div style="width: ' + dailyPct + '%; background: ' + dailyColor + '; height: 100%; border-radius: 3px;"></div>'
      + '</div>'
      + '<span style="font-size: 0.75em; color: #aaa; width: 60px; text-align: right;">' + dailyUsed + '/' + dailyLimit + '</span>'
      + '</div>'
      + '</div>';
  }).join('');

  barsContainer.innerHTML = barsHtml || '<div class="empty-state" style="font-size: 0.8em;">No budget limits configured</div>';
}
```

**3. Enhance renderHubFSM with state duration:**
In the existing `renderHubFSM` function, add computation and display of time in current state. After the existing `lastChangeEl.textContent = ...` line, add:

```javascript
var durationEl = document.getElementById('hub-fsm-duration');
if (durationEl && data.last_state_change) {
  var durationMs = Date.now() - data.last_state_change;
  if (durationMs < 60000) {
    durationEl.textContent = Math.floor(durationMs / 1000) + 's';
  } else if (durationMs < 3600000) {
    durationEl.textContent = Math.floor(durationMs / 60000) + 'm';
  } else {
    durationEl.textContent = Math.floor(durationMs / 3600000) + 'h ' + Math.floor((durationMs % 3600000) / 60000) + 'm';
  }
}
```

**4. Wire into applyFullSnapshot:**
In the existing `applyFullSnapshot` function, after `renderHubFSM(data.hub_fsm || null);`, add:
```javascript
renderGoalProgress(data.goal_stats || null, data.active_goals || []);
renderCostTracking(data.cost_stats || null);
```

**5. Handle goal_event in WebSocket event switch:**
In the existing event type switch (where `hub_fsm_state` is handled), add a case for `goal_event`:
```javascript
case 'goal_event':
  // Request fresh snapshot to update goal panel with latest data
  if (ws && ws.readyState === 1) {
    ws.send(JSON.stringify({type: 'request_snapshot'}));
  }
  break;
```

This is simpler than incremental updates and avoids maintaining client-side goal state. Goal events are infrequent so the snapshot request cost is negligible.

**6. Set up a periodic duration updater:**
Add a setInterval to update Hub FSM duration display every 10 seconds (so the "In State" counter ticks up without waiting for a snapshot):
```javascript
setInterval(function() {
  var durationEl = document.getElementById('hub-fsm-duration');
  if (durationEl && window._lastHubFsmStateChange) {
    var durationMs = Date.now() - window._lastHubFsmStateChange;
    // ... same formatting as above
  }
}, 10000);
```

Store `window._lastHubFsmStateChange = data.last_state_change;` in renderHubFSM when data is present.

**Important:** Use the `escapeHtml` function that already exists in the dashboard JS for goal descriptions.
  </action>
  <verify>Run `mix compile --warnings-as-errors` to confirm the Elixir heredoc string is valid. Start the application with `mix run --no-halt` and visit http://localhost:4000 to verify the new panels render.</verify>
  <done>Dashboard displays Goal Progress panel with backlog depth cards (pending/active/complete/failed), per-goal lifecycle visualization with progress bars, Cost Tracking panel with hourly/daily/session invocation counts and per-state budget utilization bars, and Hub FSM panel shows "In State" duration. All update in real-time via WebSocket.</done>
</task>

</tasks>

<verification>
1. `mix compile --warnings-as-errors` passes cleanly
2. `mix test` passes (existing tests not broken)
3. Dashboard at http://localhost:4000 shows:
   - Goal Progress panel with pending/active/complete/failed count cards
   - Per-goal lifecycle rows with stage dots and progress bars (when goals exist)
   - Cost Tracking panel with hourly/daily/session counts
   - Per-state budget bars with color-coded utilization (green < 50%, yellow 50-80%, red > 80%)
   - Hub FSM panel has "In State" duration that updates periodically
4. Submitting a goal via API causes the Goal Progress panel to update via WebSocket
</verification>

<success_criteria>
Dashboard shows three functional panels: Goal Progress (backlog depth + per-goal lifecycle), Cost Tracking (invocation counts + budget bars), and enhanced Hub FSM (state duration). Real-time updates work via WebSocket for all panels.
</success_criteria>

<output>
After completion, create `.planning/phases/36-dashboard-and-observability/36-02-SUMMARY.md`
</output>

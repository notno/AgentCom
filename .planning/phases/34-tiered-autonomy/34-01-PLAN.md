---
phase: 34-tiered-autonomy
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/agent_com/risk_classifier.ex
  - lib/agent_com/config.ex
  - test/agent_com/risk_classifier_test.exs
autonomous: true

must_haves:
  truths:
    - "Completed tasks are classified into tier 1, 2, or 3 based on diff metadata and task complexity"
    - "Tier 3 is assigned when protected paths are touched or verification failed"
    - "Tier 1 requires trivial/standard complexity, <20 lines, <=3 files, tests present, no new files, verification passed"
    - "Tier 2 is the default for anything not matching Tier 1 or Tier 3"
    - "Missing diff metadata defaults to Tier 2 (never Tier 1)"
    - "All thresholds are read from Config GenServer with sensible defaults"
  artifacts:
    - path: "lib/agent_com/risk_classifier.ex"
      provides: "Pure function risk classification module"
      exports: ["classify/2"]
    - path: "lib/agent_com/config.ex"
      provides: "Config defaults for risk tier thresholds"
      contains: "risk_tier1_max_lines"
    - path: "test/agent_com/risk_classifier_test.exs"
      provides: "Comprehensive test suite for risk classification"
      min_lines: 80
  key_links:
    - from: "lib/agent_com/risk_classifier.ex"
      to: "lib/agent_com/config.ex"
      via: "Config.get/1 calls for thresholds"
      pattern: "Config\\.get\\(:risk_"
---

<objective>
Build the RiskClassifier pure function module using TDD. This module classifies completed tasks into risk tiers (1/2/3) based on actual code change metrics (lines changed, files touched, protected paths, test coverage) combined with task complexity.

Purpose: Risk tiers enable differentiated PR review -- trivial changes can be fast-tracked while risky changes get scrutiny. This is the core logic that the sidecar integration (Plan 02) will consume.

Output: Working, fully-tested `AgentCom.RiskClassifier` module with `classify/2` entry point, plus Config GenServer defaults for all thresholds.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/34-tiered-autonomy/34-RESEARCH.md
@lib/agent_com/complexity.ex
@lib/agent_com/config.ex
@test/agent_com/complexity_test.exs
</context>

<feature>
  <name>RiskClassifier -- Pure function risk tier classification</name>
  <files>lib/agent_com/risk_classifier.ex, lib/agent_com/config.ex, test/agent_com/risk_classifier_test.exs</files>
  <behavior>
    classify/2 takes a task map and a diff_meta map, returns a classification map.

    Input task map shape:
    - :complexity => %{effective_tier: :trivial | :standard | :complex | :unknown}
    - :verification_report => %{status: :pass} | %{"status" => "pass"} | nil

    Input diff_meta map shape:
    - :lines_added => non_neg_integer
    - :lines_deleted => non_neg_integer
    - :files_changed => [String.t()]
    - :files_added => [String.t()]
    - :tests_exist => boolean

    Output classification map:
    - :tier => 1 | 2 | 3
    - :reasons => [String.t()]
    - :auto_merge_eligible => boolean (always false in v1.3)
    - :signals => map (internal signal state for debugging)

    Cases:
    -- Tier 3 (escalate):
    - Protected path touched (config/, rel/, .github/, Dockerfile, mix.exs, mix.lock) -> tier 3
    - Auth path touched (lib/agent_com/auth, lib/agent_com/plugs/require_auth, priv/cert, priv/key) -> tier 3
    - Verification failed -> tier 3
    - Both protected path AND verification failed -> tier 3 with both reasons

    -- Tier 1 (auto-merge candidate):
    - complexity :trivial or :standard, lines_changed < 20, file_count <= 3, no new files, tests exist, verification passed -> tier 1
    - All conditions must be met simultaneously

    -- Tier 2 (default review):
    - complexity :complex -> tier 2
    - lines_changed >= 20 -> tier 2
    - file_count > 3 -> tier 2
    - new files present -> tier 2
    - tests missing -> tier 2
    - nil/empty diff_meta -> tier 2 (safe default)

    -- Config-driven thresholds:
    - :risk_tier1_max_lines (default 20)
    - :risk_tier1_max_files (default 3)
    - :risk_tier1_allowed_tiers (default [:trivial, :standard])
    - :risk_tier3_protected_paths (default list of config/deploy/CI paths)
    - :risk_tier3_auth_paths (default list of auth-related paths)
    - :risk_auto_merge_tier1 (default false)
    - :risk_auto_merge_tier2 (default false)
    - :risk_auto_merge_threshold (default 20)

    -- Edge cases:
    - classify(task, nil) -> treat as empty diff_meta -> tier 2
    - classify(task, %{}) -> no diff data -> tier 2
    - Task with no complexity field -> :unknown -> not in allowed tiers -> tier 2
  </behavior>
  <implementation>
    Follow the gather-signals-then-classify pattern from AgentCom.Complexity:

    1. Register config defaults in Config GenServer @defaults map (risk_tier1_max_lines, etc.)
    2. Create RiskClassifier module with classify/2 entry point
    3. gather_signals/2 collects all signals from task + diff_meta into a flat map
    4. tier3?/1 checks protected paths and verification status (check first -- highest priority)
    5. tier1?/1 checks all Tier 1 criteria (must ALL pass)
    6. Default to Tier 2 if neither Tier 3 nor Tier 1
    7. build_reasons/2 creates human-readable reason list per tier
    8. auto_merge_eligible is tier == 1 AND Config.get(:risk_auto_merge_tier1) == true (always false in v1.3)
    9. Protected path matching uses String.contains?/2 for prefix-style matching (config/ matches config/dev.exs)
    10. Emit :telemetry event [:agent_com, :risk, :classified] with tier, complexity, signals
  </implementation>
</feature>

<verification>
- `mix test test/agent_com/risk_classifier_test.exs` -- all tests pass
- `mix compile --warnings-as-errors` -- no warnings
- Classification logic covers all three tiers with distinct test cases
- Config keys readable via Config.get/1 with correct defaults
</verification>

<success_criteria>
- RiskClassifier.classify/2 correctly classifies tasks into tiers 1, 2, and 3
- Protected paths trigger Tier 3, failed verification triggers Tier 3
- All Tier 1 criteria must simultaneously pass for Tier 1 classification
- Missing/empty diff metadata safely defaults to Tier 2
- All thresholds configurable via Config GenServer
- Test suite has at least 15 test cases covering tiers, edge cases, and config overrides
</success_criteria>

<output>
After completion, create `.planning/phases/34-tiered-autonomy/34-01-SUMMARY.md`
</output>

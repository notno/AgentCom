---
phase: 34-tiered-autonomy
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - lib/agent_com/endpoint.ex
  - sidecar/agentcom-git.js
  - sidecar/index.js
autonomous: true

must_haves:
  truths:
    - "Sidecar gathers diff metadata (lines added/deleted, files changed/added, tests exist) before PR creation"
    - "Sidecar calls hub /api/tasks/:id/classify endpoint with diff metadata and receives risk tier classification"
    - "PR body includes risk classification section with tier label and reasons"
    - "PR gets a risk:tier-N label for GitHub filtering"
    - "Every completed task creates a PR regardless of tier (PR-only mode)"
    - "When hub classify endpoint is unreachable, sidecar defaults to Tier 2 and proceeds with PR creation"
  artifacts:
    - path: "lib/agent_com/endpoint.ex"
      provides: "POST /api/tasks/:task_id/classify endpoint"
      contains: "risk_classifier"
    - path: "sidecar/agentcom-git.js"
      provides: "gatherDiffMeta function and enriched generatePrBody"
      contains: "gatherDiffMeta"
    - path: "sidecar/index.js"
      provides: "Classification call between verification and git submit"
      contains: "classify"
  key_links:
    - from: "sidecar/agentcom-git.js"
      to: "lib/agent_com/endpoint.ex"
      via: "HTTP POST to /api/tasks/:id/classify"
      pattern: "api/tasks.*classify"
    - from: "sidecar/index.js"
      to: "sidecar/agentcom-git.js"
      via: "runGitCommand('submit') with riskClassification parameter"
      pattern: "riskClassification"
    - from: "lib/agent_com/endpoint.ex"
      to: "lib/agent_com/risk_classifier.ex"
      via: "RiskClassifier.classify/2 call"
      pattern: "RiskClassifier\\.classify"
---

<objective>
Wire the RiskClassifier (from Plan 01) into the task completion flow: sidecar gathers diff metadata, calls hub to classify, then includes the classification in the PR body and adds a risk label.

Purpose: Completed tasks get visible risk tiers on their PRs, enabling humans to prioritize review and building the foundation for future auto-merge by tier.

Output: End-to-end flow where every PR created by an agent includes a risk classification section and risk:tier-N label.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/34-tiered-autonomy/34-RESEARCH.md
@.planning/phases/34-tiered-autonomy/34-01-SUMMARY.md
@lib/agent_com/endpoint.ex
@sidecar/agentcom-git.js
@sidecar/index.js
@lib/agent_com/risk_classifier.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add classify endpoint and sidecar diff gathering</name>
  <files>lib/agent_com/endpoint.ex, sidecar/agentcom-git.js</files>
  <action>
    **Endpoint (Elixir side):**

    Add `POST /api/tasks/:task_id/classify` endpoint to endpoint.ex (auth required). Place it after the existing `POST /api/tasks/:task_id/retry` route. The endpoint:
    1. Reads task from TaskQueue via `TaskQueue.get_task(task_id)`
    2. Extracts diff_meta from request body JSON: `lines_added`, `lines_deleted`, `files_changed`, `files_added`, `tests_exist`
    3. Converts string keys to atom keys for the diff_meta map
    4. Calls `RiskClassifier.classify(task, diff_meta)`
    5. Returns 200 with JSON classification: `%{"tier" => tier, "reasons" => reasons, "auto_merge_eligible" => bool}`
    6. Returns 404 if task not found
    7. Add route to the @moduledoc route list

    **Sidecar diff gathering (JS side):**

    Add `gatherDiffMeta(config)` function to agentcom-git.js (after the `submit` function). This function:
    1. Runs `git diff --numstat origin/main...HEAD` to get lines added/deleted per file
    2. Runs `git diff --name-status origin/main...HEAD` to identify new files (status 'A')
    3. Runs `git diff --name-only origin/main...HEAD` to get all changed files
    4. For each changed file, checks if a corresponding test file exists (lib/X.ex -> test/X_test.exs) using fs.existsSync
    5. Returns `{ lines_added, lines_deleted, files_changed, files_added, tests_exist }`
    6. Wraps all git calls in try/catch -- returns empty/zero defaults on failure
    7. Export the function (add to module.exports if pattern used, or keep internal for use by submit)

    **Enhance generatePrBody:**

    Update `generatePrBody` signature to accept an optional 5th parameter `riskClassification`. When provided, add a "Risk Classification" section after the task metadata section:
    ```
    ### Risk Classification

    **Tier 2 (Review required)**

    **Reasons:**
    - lines: 45 (>20)
    - new files: 2
    ```

    Tier labels: `{1: "Tier 1 (Auto-merge candidate)", 2: "Tier 2 (Review required)", 3: "Tier 3 (Escalate)"}`. No emojis (codebase convention).

    **Enhance submit function:**

    Update `submit` to accept optional `risk_classification` in args. Pass it through to generatePrBody. Add a `risk:tier-N` label to the PR alongside existing agent and priority labels. Create the label with `gh label create "risk:tier-N" --force`.
  </action>
  <verify>
    - `mix compile --warnings-as-errors` -- no Elixir compilation warnings
    - `node -e "require('./sidecar/agentcom-git.js')"` -- no JS syntax errors (if module.exports exists)
    - Manual review: endpoint route matches existing patterns, gatherDiffMeta handles all edge cases
  </verify>
  <done>
    - /api/tasks/:task_id/classify endpoint accepts diff metadata and returns risk classification JSON
    - gatherDiffMeta function gathers lines, files, new files, and test existence from git
    - generatePrBody includes risk classification section when provided
    - submit creates risk:tier-N label on PR
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire classification into task completion flow</name>
  <files>sidecar/index.js, sidecar/agentcom-git.js</files>
  <action>
    **Sidecar index.js -- handleResult flow:**

    In `handleResult()` (around line 247), BETWEEN the verification check and the `runGitCommand('submit', ...)` call, add classification step:

    1. After `const skipGit = ...` check (line 246), if NOT skipping git:
    2. Call `gatherDiffMeta(config)` from agentcom-git.js (import or require the function)
    3. Call hub classify endpoint: HTTP POST to `${config.hub_api_url}/api/tasks/${taskId}/classify` with diff_meta as JSON body, including Authorization header from `_config.token`
    4. Parse response JSON to get `riskClassification` (tier, reasons, auto_merge_eligible)
    5. If classify call fails (network error, 404, 500), default to `{ tier: 2, reasons: ["classification unavailable"], auto_merge_eligible: false }`
    6. Pass `riskClassification` to `runGitCommand('submit', { ...existingArgs, risk_classification: riskClassification })`
    7. Also include `risk_classification` in the result object sent to `hub.sendTaskComplete(taskId, result)` so the hub stores it

    **Sidecar agentcom-git.js -- submit function update:**

    Update `submit(args)` to destructure `risk_classification` from args (alongside agent_id, task_id, task). Pass it to `generatePrBody` as the 5th argument. Use `risk_classification.tier` to create the risk label.

    **Hub HTTP helper in sidecar:**

    Create a small helper function `classifyTask(config, taskId, diffMeta)` in index.js (near the HubConnection class) that:
    1. POSTs to `${config.hub_api_url}/api/tasks/${taskId}/classify`
    2. Sends JSON body with diff_meta fields
    3. Includes `Authorization: Bearer ${config.token}` header
    4. Returns parsed JSON response
    5. On any error, returns the Tier 2 default (fail-safe, never blocks PR creation)

    Use Node.js built-in `http`/`https` module (matching existing sidecar patterns -- no new dependencies). Or if the sidecar already uses a fetch pattern, follow that.
  </action>
  <verify>
    - `node -c sidecar/index.js` -- syntax check passes
    - Review: classification call happens AFTER verification but BEFORE git submit
    - Review: failure in classify call does NOT block PR creation (defaults to Tier 2)
    - Review: risk_classification flows through to both PR body and task_complete message
  </verify>
  <done>
    - Task completion flow: verification -> gather diff meta -> classify via hub API -> submit PR with classification
    - Classify failure gracefully defaults to Tier 2 without blocking PR creation
    - PR body contains risk tier section with tier label and reasons
    - PR has risk:tier-N GitHub label
    - task_complete WebSocket message includes risk_classification for hub storage
  </done>
</task>

</tasks>

<verification>
- `mix compile --warnings-as-errors` -- full Elixir compilation clean
- `mix test test/agent_com/risk_classifier_test.exs` -- all risk classifier tests still pass
- `node -c sidecar/index.js && node -c sidecar/agentcom-git.js` -- JS syntax valid
- End-to-end data flow: sidecar gatherDiffMeta -> HTTP POST /classify -> RiskClassifier.classify/2 -> classification in PR body + label
- PR-only mode enforced: no auto-merge logic, every tier creates a PR
</verification>

<success_criteria>
- Completed tasks get risk tier classification embedded in PR description
- PRs have risk:tier-1, risk:tier-2, or risk:tier-3 GitHub labels
- Classification endpoint returns correct tiers for given diff metadata
- Sidecar gracefully handles hub unavailability (defaults to Tier 2)
- No new npm dependencies added to sidecar
</success_criteria>

<output>
After completion, create `.planning/phases/34-tiered-autonomy/34-02-SUMMARY.md`
</output>

---
phase: 25-cost-control-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - lib/agent_com/telemetry.ex
  - lib/agent_com/alerter.ex
  - test/support/dets_helpers.ex
autonomous: true

must_haves:
  truths:
    - "Every Claude Code invocation emits [:agent_com, :hub, :claude_call] telemetry event"
    - "Budget exhaustion emits [:agent_com, :hub, :budget_exhausted] telemetry event"
    - "Alerter evaluates hub_invocation_rate rule each check cycle and fires when hourly invocations exceed threshold"
    - "CostLedger tests run in isolation without polluting other DETS-backed test suites"
  artifacts:
    - path: "lib/agent_com/telemetry.ex"
      provides: "Hub Claude Code invocation telemetry events in catalog and handler attachment"
      contains: "[:agent_com, :hub, :claude_call]"
    - path: "lib/agent_com/alerter.ex"
      provides: "Hub invocation rate alert rule (rule 7)"
      contains: "evaluate_hub_invocation_rate"
    - path: "test/support/dets_helpers.ex"
      provides: "CostLedger DETS isolation for tests"
      contains: ":cost_ledger"
  key_links:
    - from: "lib/agent_com/cost_ledger.ex"
      to: "lib/agent_com/telemetry.ex"
      via: ":telemetry.execute for [:agent_com, :hub, :claude_call] on each record_invocation"
      pattern: ":telemetry\\.execute\\(\\[:agent_com, :hub, :claude_call\\]"
    - from: "lib/agent_com/alerter.ex"
      to: "lib/agent_com/cost_ledger.ex"
      via: "CostLedger.stats() called in evaluate_hub_invocation_rate"
      pattern: "CostLedger\\.stats"
---

<objective>
Wire CostLedger into the existing telemetry, alerting, and test infrastructure so invocations are observable, rate alerts fire when thresholds are approached, and tests run in isolation.

Purpose: COST-04 requires telemetry events wired to the existing Alerter. Test isolation is critical to prevent DETS bleed across test suites (Pitfall #4 from research).

Output: Telemetry events cataloged and handled, Alerter rule 7 (hub_invocation_rate) evaluating each check cycle, DetsHelpers updated for CostLedger isolation.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/25-cost-control-infrastructure/25-RESEARCH.md
@.planning/phases/25-cost-control-infrastructure/25-01-SUMMARY.md

@lib/agent_com/telemetry.ex (event catalog and attach_handlers/0)
@lib/agent_com/alerter.ex (check cycle, evaluate_* pattern, rule list)
@test/support/dets_helpers.ex (DETS isolation pattern)
@lib/agent_com/cost_ledger.ex (record_invocation emits telemetry, stats/0 for alerter)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add telemetry events and wire CostLedger emission</name>
  <files>lib/agent_com/telemetry.ex, lib/agent_com/cost_ledger.ex</files>
  <action>
**telemetry.ex -- Event catalog update:**

Add a new section to the `@moduledoc` event catalog after the "### Verification" section:

```
### Hub Claude Code Invocations

- `[:agent_com, :hub, :claude_call]` - Claude Code CLI invocation completed
  measurements: `%{duration_ms: integer, count: 1}`
  metadata: `%{hub_state: atom, prompt_type: atom}`

- `[:agent_com, :hub, :budget_exhausted]` - Budget check returned exhausted
  measurements: `%{}`
  metadata: `%{hub_state: atom, hourly_count: integer, daily_count: integer}`
```

**telemetry.ex -- Handler attachment update:**

Add two new events to the `events` list in `attach_handlers/0`, after the Verification events and before the DETS spans:

```elixir
# Hub Claude Code invocations
[:agent_com, :hub, :claude_call],
[:agent_com, :hub, :budget_exhausted],
```

**cost_ledger.ex -- Emit telemetry in record_invocation/2:**

In the `handle_call({:record_invocation, ...})` callback, AFTER persisting to DETS and updating ETS, emit:

```elixir
:telemetry.execute(
  [:agent_com, :hub, :claude_call],
  %{duration_ms: record.duration_ms, count: 1},
  %{hub_state: hub_state, prompt_type: record.prompt_type}
)
```

**cost_ledger.ex -- Emit telemetry in check_budget/1:**

In `check_budget/1`, when returning `:budget_exhausted`, emit BEFORE returning:

```elixir
:telemetry.execute(
  [:agent_com, :hub, :budget_exhausted],
  %{},
  %{hub_state: hub_state, hourly_count: hourly_count, daily_count: daily_count}
)
```

Use a try/rescue around the telemetry emit in check_budget/1 so it never fails the budget check itself.
  </action>
  <verify>
Run `mix compile --warnings-as-errors` -- compiles cleanly. Verify telemetry handler count increased: `mix run -e ":telemetry.list_handlers([:agent_com, :hub, :claude_call]) |> IO.inspect()"` -- returns at least one handler.
  </verify>
  <done>
Two new telemetry events (claude_call, budget_exhausted) cataloged in Telemetry module, attached to handler, and emitted by CostLedger on record_invocation and budget exhaustion respectively.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Alerter rule 7 (hub_invocation_rate) and update DetsHelpers</name>
  <files>lib/agent_com/alerter.ex, test/support/dets_helpers.ex</files>
  <action>
**alerter.ex -- Add rule 7:**

1. Update `@moduledoc` to add rule 7 to the list:
   ```
   7. **hub_invocation_rate** (WARNING) -- Hub Claude Code invocation rate exceeds threshold per hour.
   ```

2. In `run_check_cycle/1`, add the new rule to the `rules` list after `:tier_down`:
   ```elixir
   {:hub_invocation_rate, evaluate_hub_invocation_rate(thresholds)}
   ```

3. Add private function `evaluate_hub_invocation_rate/1` after the `evaluate_tier_down` function:

   ```elixir
   # Rule 7: Hub invocation rate (Claude Code CLI calls per hour)
   defp evaluate_hub_invocation_rate(thresholds) do
     hourly_threshold = Map.get(thresholds, :hub_invocations_per_hour_warn, 50)

     total_hourly = try do
       stats = AgentCom.CostLedger.stats()
       get_in(stats, [:hourly, :total]) || 0
     rescue
       _ -> 0
     end

     if total_hourly > hourly_threshold do
       {:triggered, :warning,
        "Hub invocation rate high: #{total_hourly} calls this hour (threshold: #{hourly_threshold})",
        %{hourly_invocations: total_hourly, threshold: hourly_threshold}}
     else
       :ok
     end
   end
   ```

4. Update the `@moduledoc` header to say "7 alert rules" instead of "6 alert rules" (if such count exists in the doc).

5. Add `:hub_invocations_per_hour_warn` to `default_thresholds/0` with value `50`.

**dets_helpers.ex -- Add CostLedger isolation:**

1. In `setup_test_dets/0`, add after the `repo_registry_data_dir` line:
   ```elixir
   Application.put_env(:agent_com, :cost_ledger_data_dir, Path.join(tmp_dir, "cost_ledger"))
   ```

2. In the `File.mkdir_p!` block, add after the `repo_registry` mkdir:
   ```elixir
   File.mkdir_p!(Path.join(tmp_dir, "cost_ledger"))
   ```

3. In `restart_dets_servers/0`, add `AgentCom.CostLedger` to the `stop_order` list -- place it after `AgentCom.DetsBackup` and before `AgentCom.TaskQueue` (CostLedger has no downstream consumers yet):
   ```elixir
   stop_order = [
     AgentCom.Scheduler,
     AgentCom.DetsBackup,
     AgentCom.CostLedger,
     AgentCom.TaskQueue,
     ...
   ]
   ```

4. In the `dets_tables` force-close list, add `:cost_ledger` at the end:
   ```elixir
   dets_tables = [
     :task_queue, :task_dead_letter, :agent_mailbox, :message_history,
     :agent_channels, :channel_history, :agentcom_config, :thread_messages,
     :thread_replies, :repo_registry, :cost_ledger
   ]
   ```
  </action>
  <verify>
Run `mix compile --warnings-as-errors` -- compiles cleanly. Run `mix test test/agent_com/alerter_test.exs` (if exists) -- existing alerter tests still pass. Verify default thresholds include hub key: `mix run -e "AgentCom.Alerter.default_thresholds() |> Map.has_key?(:hub_invocations_per_hour_warn) |> IO.inspect()"`.
  </verify>
  <done>
Alerter rule 7 (hub_invocation_rate) evaluates each check cycle, reading from CostLedger.stats(). DetsHelpers updated with cost_ledger DETS isolation (env override, mkdir, stop/restart order, force-close list).
  </done>
</task>

</tasks>

<verification>
1. `mix compile --warnings-as-errors` passes with zero warnings
2. Telemetry events registered: `mix run -e ":telemetry.list_handlers([:agent_com, :hub, :claude_call]) |> length() |> IO.inspect()"` returns >= 1
3. Alerter default thresholds include hub key: `mix run -e "AgentCom.Alerter.default_thresholds() |> Map.get(:hub_invocations_per_hour_warn) |> IO.inspect()"` returns 50
4. DetsHelpers includes CostLedger: grep for `:cost_ledger` in `test/support/dets_helpers.ex`
</verification>

<success_criteria>
- [:agent_com, :hub, :claude_call] telemetry event defined, attached, and emitted by CostLedger
- [:agent_com, :hub, :budget_exhausted] telemetry event defined, attached, and emitted on budget exhaustion
- Alerter rule 7 evaluates hub_invocation_rate each cycle with configurable threshold (default 50/hr)
- DetsHelpers isolates CostLedger DETS in tests (env var, mkdir, stop order, force-close)
</success_criteria>

<output>
After completion, create `.planning/phases/25-cost-control-infrastructure/25-02-SUMMARY.md`
</output>

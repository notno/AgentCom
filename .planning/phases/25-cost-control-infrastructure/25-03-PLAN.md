---
phase: 25-cost-control-infrastructure
plan: 03
type: tdd
wave: 3
depends_on: ["25-01", "25-02"]
files_modified:
  - test/agent_com/cost_ledger_test.exs
  - lib/agent_com/cost_ledger.ex
autonomous: true

must_haves:
  truths:
    - "All CostLedger public API functions are tested with passing assertions"
    - "Budget enforcement correctly returns :budget_exhausted when limits are exceeded"
    - "Rolling window counts expire correctly (hourly records older than 1 hour do not count)"
    - "DETS history survives GenServer restart and ETS counters are rebuilt accurately"
    - "Per-state budget isolation works (exhausting Executing budget does not affect Improving)"
    - "Stats and history queries return correct data with filtering"
  artifacts:
    - path: "test/agent_com/cost_ledger_test.exs"
      provides: "Comprehensive test suite for CostLedger GenServer"
      contains: "AgentCom.CostLedgerTest"
  key_links:
    - from: "test/agent_com/cost_ledger_test.exs"
      to: "lib/agent_com/cost_ledger.ex"
      via: "Tests exercise check_budget/1, record_invocation/2, stats/0, history/1"
      pattern: "CostLedger\\."
---

<objective>
Create a comprehensive TDD test suite for the CostLedger GenServer covering budget enforcement, invocation recording, rolling windows, restart recovery, stats, and history.

Purpose: CostLedger is the safety gate preventing cost spirals. Every behavior must be proven correct before Phase 26 (ClaudeClient) starts calling through it. TDD ensures the contract is verified, not just the implementation.

Output: Passing test suite in `test/agent_com/cost_ledger_test.exs` with fixes to `cost_ledger.ex` if any tests reveal implementation gaps.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/25-cost-control-infrastructure/25-RESEARCH.md
@.planning/phases/25-cost-control-infrastructure/25-01-SUMMARY.md
@.planning/phases/25-cost-control-infrastructure/25-02-SUMMARY.md

@lib/agent_com/cost_ledger.ex (implementation under test)
@test/agent_com/task_queue_test.exs (pattern: DETS GenServer test with full_test_setup)
@test/support/dets_helpers.ex (isolation setup)
</context>

<feature>
  <name>CostLedger Budget Enforcement and Invocation Tracking</name>
  <files>test/agent_com/cost_ledger_test.exs, lib/agent_com/cost_ledger.ex</files>
  <behavior>
Expected behaviors in testable terms:

**check_budget/1:**
- check_budget(:executing) returns :ok when no invocations recorded
- check_budget(:executing) returns :ok when invocations below hourly limit
- check_budget(:executing) returns :budget_exhausted when hourly limit reached
- check_budget(:executing) returns :budget_exhausted when daily limit reached
- check_budget(:improving) enforces separate limits from :executing (per-state isolation)
- check_budget(:contemplating) enforces separate limits from other states
- check_budget with invalid state raises or returns graceful error

**record_invocation/2:**
- record_invocation(:executing, %{duration_ms: 5000, prompt_type: :decompose}) returns :ok
- record_invocation increments ETS counters (verified via subsequent stats/0)
- record_invocation persists to DETS (verified via history/1)
- Multiple invocations accumulate correctly

**stats/0:**
- stats() returns map with :hourly, :daily, :session, :budgets keys
- stats() hourly/daily/session each have per-state counts and :total
- stats() budgets reflect Config values or defaults

**history/1:**
- history() returns list of record maps sorted by timestamp descending
- history(state: :executing) filters to only :executing records
- history(limit: 5) limits results to 5 records
- history(since: timestamp) filters to records after timestamp

**Rolling window:**
- Records older than 1 hour do not count toward hourly budget
- Records older than 24 hours do not count toward daily budget
- Session count includes all records since GenServer start

**Restart recovery:**
- After GenServer restart, ETS counters are rebuilt from DETS
- Invocations recorded before restart still count toward budget

**Budget configuration:**
- Budget limits read from Config when set
- Default budgets used when Config returns nil
- Budget changes via Config take effect on next check_budget call

**Telemetry:**
- record_invocation emits [:agent_com, :hub, :claude_call] telemetry event
- check_budget emits [:agent_com, :hub, :budget_exhausted] when budget exhausted
  </behavior>
  <implementation>
Follow TDD RED-GREEN-REFACTOR cycle:

**RED phase:** Write all tests in `test/agent_com/cost_ledger_test.exs` following the TaskQueueTest pattern:
- `use ExUnit.Case, async: false` (DETS-backed)
- Setup block: `full_test_setup()` with `on_exit` teardown
- Organize with `describe` blocks per function
- Tests should be specific, one assertion concept per test
- For rolling window tests: use direct DETS inserts with backdated timestamps to simulate old records, then restart CostLedger to rebuild ETS from DETS
- For Config tests: use `AgentCom.Config.put(:hub_invocation_budgets, custom_budgets)` then verify check_budget respects them
- For telemetry tests: attach a test handler before the test, verify events received

**GREEN phase:** Fix any CostLedger implementation gaps revealed by failing tests. Expected areas:
- Edge cases in check_budget when ETS table is empty
- Rolling window boundary conditions
- History filtering and sorting
- Stats aggregation math

**REFACTOR phase:** Clean up any duplication in implementation or tests. Ensure consistent patterns.

Target: 25-35 tests covering all branches. Tests should run in < 5 seconds total.
  </implementation>
</feature>

<verification>
1. `mix test test/agent_com/cost_ledger_test.exs --trace` -- all tests pass
2. `mix test` -- full suite passes (no DETS bleed from CostLedger tests)
3. Test count: at least 25 tests
4. No warnings: `mix test test/agent_com/cost_ledger_test.exs 2>&1 | grep -i warning` -- empty
</verification>

<success_criteria>
- All CostLedger tests pass individually and as part of the full test suite
- Budget enforcement proven correct: exhausted states return :budget_exhausted, fresh states return :ok
- Rolling window proven: old records do not count toward current budget
- Restart recovery proven: ETS counters match DETS history after restart
- Per-state isolation proven: exhausting one state does not affect others
- Telemetry emission proven: events fire on invocation and budget exhaustion
</success_criteria>

<output>
After completion, create `.planning/phases/25-cost-control-infrastructure/25-03-SUMMARY.md`
</output>

---
phase: 41-agentic-execution-loop
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - sidecar/lib/execution/ollama-executor.js
  - sidecar/test/execution/ollama-executor-guardrails.test.js
autonomous: true

must_haves:
  truths:
    - "ReAct loop terminates when max iterations reached (5/10/20 by complexity tier)"
    - "ReAct loop terminates when same tool+args called 3 times consecutively"
    - "ReAct loop terminates when no new file modifications in 5 iterations (stall detection)"
    - "Iteration limit adapts per task complexity tier: trivial=5, standard=10, complex=20"
  artifacts:
    - path: "sidecar/lib/execution/ollama-executor.js"
      provides: "Safety guardrails in agentic loop"
    - path: "sidecar/test/execution/ollama-executor-guardrails.test.js"
      provides: "Guardrail unit tests"
  key_links:
    - from: "sidecar/lib/execution/ollama-executor.js"
      to: "task.complexity.effective_tier"
      via: "Complexity tier determines max iterations"
      pattern: "effective_tier"
---

<objective>
Add safety guardrails to the agentic ReAct loop: adaptive iteration limits by complexity tier, repetition detection, and stall detection.

Purpose: Prevent infinite loops, wasted compute, and stuck execution. These guardrails are external to the loop logic -- they check conditions and force termination with clear reasons.

Output: Guardrailed OllamaExecutor with tested termination conditions.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-agentic-execution-loop/41-CONTEXT.md
@.planning/phases/41-agentic-execution-loop/41-RESEARCH.md
@.planning/phases/41-agentic-execution-loop/41-01-SUMMARY.md
@sidecar/lib/execution/ollama-executor.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Safety guardrails in _agenticLoop</name>
  <files>sidecar/lib/execution/ollama-executor.js</files>
  <action>
Add safety guardrails to `_agenticLoop()` in `sidecar/lib/execution/ollama-executor.js`.

**1. Adaptive iteration limits (AGENT-08):**
Determine max iterations from task complexity tier:
```javascript
const ITERATION_LIMITS = { trivial: 5, standard: 10, complex: 20 };
const tier = task.complexity?.effective_tier || 'standard';
const maxIterations = task._agentic_max_iterations || ITERATION_LIMITS[tier] || 10;
```
Remove the hardcoded default from Plan 01 and replace with this tier-based lookup.

**2. Repetition detection (AGENT-04):**
Add a `_isRepetition(callHistory, newCalls, threshold = 3)` method to OllamaExecutor.
- `callHistory` is an array of arrays (each entry is the tool calls from one iteration)
- Create a key for the new calls: `newCalls.map(c => c.name + ':' + JSON.stringify(c.arguments)).join('|')`
- Check if the last `threshold` entries in history have the same key
- If yes, return true (loop should terminate)

Inside the loop, after parsing tool_calls:
```javascript
callHistory.push(parsed.calls);
if (this._isRepetition(callHistory, parsed.calls)) {
  log('warning', 'agentic_repetition_stop', { task_id: task.task_id, iteration: i, repeated_calls: parsed.calls.map(c => c.name) });
  onProgress({ type: 'status', message: `Stopped: repeated tool calls detected (${parsed.calls.map(c => c.name).join(', ')})` });
  break;
}
```

**3. Stall detection:**
Track file modifications across iterations. After each tool execution round, check if any `write_file` tool was called in the last 5 iterations.
- Maintain a `lastWriteIteration` counter, updated when a write_file tool result has `success: true`
- If `currentIteration - lastWriteIteration >= 5`, force stop with stall message
- Log: `log('warning', 'agentic_stall_stop', { ... })`

**4. Termination reason tracking:**
Add a `_terminationReason` to the loop result. Possible values:
- `'final_answer'` -- model provided final answer (normal exit)
- `'max_iterations'` -- hit iteration limit
- `'repetition'` -- same tool calls repeated 3x
- `'stall'` -- no file writes in 5 iterations
- `'nudge_exhausted'` -- empty responses after 2 nudges

Return the termination reason in the result object: `{ status, output, model_used, tokens_in, tokens_out, error, termination_reason, iterations_used }`.
  </action>
  <verify>
Verify module loads: `cd sidecar && node -e "const { OllamaExecutor } = require('./lib/execution/ollama-executor'); const e = new OllamaExecutor(); console.log('_isRepetition:', typeof e._isRepetition)"`.
Verify no import errors: `cd sidecar && node -e "require('./lib/execution/ollama-executor')"`.
  </verify>
  <done>OllamaExecutor._agenticLoop has 4 termination conditions: max iterations (tier-based), repetition detection, stall detection, and nudge exhaustion. Each termination includes a reason in the result.</done>
</task>

<task type="auto">
  <name>Task 2: Guardrail unit tests</name>
  <files>sidecar/test/execution/ollama-executor-guardrails.test.js</files>
  <action>
Create `sidecar/test/execution/ollama-executor-guardrails.test.js` testing the safety guardrails.

Since _agenticLoop requires a live Ollama endpoint, test the guardrail helper methods directly:

**Test _isRepetition():**
- Returns false when history has fewer than threshold entries
- Returns false when calls are different each time
- Returns true when last 3 iterations have identical tool+args
- Returns true when last 3 iterations have identical multi-tool calls
- Handles empty calls array

**Test iteration limit computation:**
Test the ITERATION_LIMITS constant and tier lookup logic. Extract this into a testable function `_getMaxIterations(task)`:
- trivial tier -> 5
- standard tier -> 10
- complex tier -> 20
- missing tier -> 10 (default)
- task._agentic_max_iterations override -> uses that value

**Test termination reason in result format:**
Create mock scenarios and verify the result object shape includes `termination_reason` and `iterations_used`.

Use Jest. Mock dependencies as needed. Do NOT mock Ollama -- test helper methods and logic in isolation.
  </action>
  <verify>Run `cd sidecar && npx jest test/execution/ollama-executor-guardrails.test.js --verbose` -- all tests pass.</verify>
  <done>Guardrail helper methods tested: repetition detection, iteration limits, termination reason tracking.</done>
</task>

</tasks>

<verification>
1. `cd sidecar && npx jest test/execution/ollama-executor-guardrails.test.js --verbose` -- guardrail tests pass
2. `cd sidecar && npx jest --verbose` -- all existing tests still pass
3. `node -e "require('./sidecar/lib/execution/ollama-executor')"` -- no import errors
</verification>

<success_criteria>
- Iteration limits adapt per complexity tier (trivial:5, standard:10, complex:20) per AGENT-08
- Repetition detection stops loop after 3 identical consecutive tool call rounds per AGENT-04
- Stall detection stops loop after 5 iterations without file writes
- Every termination includes a reason string and iteration count in the result
- Guardrail helper methods have comprehensive unit tests
</success_criteria>

<output>
After completion, create `.planning/phases/41-agentic-execution-loop/41-02-SUMMARY.md`
</output>

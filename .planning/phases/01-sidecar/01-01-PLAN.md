---
phase: 01-sidecar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidecar/package.json
  - sidecar/config.json.example
  - sidecar/.gitignore
  - sidecar/index.js

autonomous: true

must_haves:
  truths:
    - "Sidecar connects to hub via WebSocket and appears in hub presence list"
    - "Sidecar automatically reconnects after WebSocket close with exponential backoff (1s, 2s, 4s... capped at 60s)"
    - "Sidecar sends heartbeat pings and detects silent connection death"
    - "Sidecar loads configuration from config.json file"
    - "Sidecar logs lifecycle events to a structured JSON-lines log file"
  artifacts:
    - path: "sidecar/package.json"
      provides: "Node.js project with ws, write-file-atomic, chokidar dependencies"
      contains: "ws"
    - path: "sidecar/config.json.example"
      provides: "Configuration template for per-agent setup"
      contains: "hub_url"
    - path: "sidecar/.gitignore"
      provides: "Ignores runtime files (config.json, queue.json, sidecar.log, results/)"
      contains: "config.json"
    - path: "sidecar/index.js"
      provides: "Core sidecar process with WebSocket connection, reconnect, heartbeat, logging, shutdown"
      min_lines: 150
  key_links:
    - from: "sidecar/index.js"
      to: "hub /ws endpoint"
      via: "ws library WebSocket connection"
      pattern: "new WebSocket"
    - from: "sidecar/index.js"
      to: "sidecar/config.json"
      via: "fs.readFileSync + JSON.parse"
      pattern: "readFileSync.*config\\.json"
---

<objective>
Scaffold the sidecar project and implement the core WebSocket connection to the hub with exponential backoff reconnect, heartbeat monitoring, structured logging, and graceful shutdown.

Purpose: This is the foundation for all sidecar functionality. The persistent WebSocket connection is the core value proposition -- agents maintain always-on connectivity to the hub even across session restarts and network interruptions.

Output: A working sidecar process that connects to the hub, identifies itself, automatically reconnects on disconnection, and handles graceful shutdown.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-sidecar/01-CONTEXT.md
@.planning/phases/01-sidecar/01-RESEARCH.md
@lib/agent_com/socket.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sidecar project scaffolding</name>
  <files>sidecar/package.json, sidecar/config.json.example, sidecar/.gitignore</files>
  <action>
Create the `sidecar/` directory at the repo root.

**sidecar/package.json:**
```json
{
  "name": "agentcom-sidecar",
  "version": "1.0.0",
  "description": "Always-on WebSocket relay for AgentCom agents",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "ws": "^8.19.0",
    "write-file-atomic": "^5.0.0",
    "chokidar": "^3.6.0"
  }
}
```

Use chokidar v3 (not v4) per research -- v4 is ESM-only and the sidecar is CJS (matching existing codebase conventions). Use write-file-atomic v5 (latest CJS-compatible version).

**sidecar/config.json.example:**
```json
{
  "agent_id": "my-agent",
  "token": "paste-token-here",
  "hub_url": "ws://hub-hostname:4000/ws",
  "wake_command": "openclaw agent --message \"Task: ${TASK_JSON}\" --session-id ${TASK_ID}",
  "capabilities": ["code"],
  "confirmation_timeout_ms": 30000,
  "results_dir": "./results",
  "log_file": "./sidecar.log"
}
```

**sidecar/.gitignore:**
```
node_modules/
config.json
queue.json
sidecar.log
results/
logs/
```

Then run `npm install` in the sidecar directory to generate package-lock.json and node_modules.
  </action>
  <verify>
Run `ls sidecar/` and confirm package.json, config.json.example, .gitignore, node_modules/, and package-lock.json all exist. Run `node -e "require('ws'); require('write-file-atomic'); require('chokidar')"` from sidecar/ to confirm all dependencies load.
  </verify>
  <done>sidecar/ directory exists with package.json listing ws + write-file-atomic + chokidar, config.json.example with all required fields, .gitignore for runtime files, and all dependencies installed.</done>
</task>

<task type="auto">
  <name>Task 2: Implement core WebSocket connection with reconnect, heartbeat, config, logging, and shutdown</name>
  <files>sidecar/index.js</files>
  <action>
Create `sidecar/index.js` as a CommonJS module. This is the main sidecar entry point. Implement the following components:

**1. Config loader:**
- Load `config.json` from `__dirname` using `fs.readFileSync` + `JSON.parse`
- If config.json missing, print error message pointing to config.json.example and exit(1)
- Validate required fields: agent_id, token, hub_url

**2. Structured logging utility:**
- `function log(event, data = {})` that appends JSON-lines to the configured log_file
- Each line: `{ ts: ISO8601, event: string, agent_id: string, ...data }`
- Use `fs.appendFileSync` for simplicity (structured log is low-volume lifecycle events only)
- Also `console.log` the event for pm2 stdout capture

**3. HubConnection class:**
- Constructor takes config object, stores reconnect state
- `connect()` method:
  - Creates `new WebSocket(config.hub_url)` using the `ws` library
  - On `open`: reset reconnectDelay to 1000ms, call `identify()`
  - On `close`: log event, set identified=false, call `scheduleReconnect()`
  - On `error`: log error message (error also triggers close, so reconnect handled there)
  - On `message`: parse JSON, call `handleMessage(parsed)`
- `identify()` method:
  - Send: `{ type: "identify", agent_id, token, name: agent_id, status: "idle", capabilities, client_type: "sidecar", protocol_version: 1 }`
  - Per research: reuse existing identify format, add `client_type: "sidecar"` and `protocol_version: 1` (hub ignores unknown fields, backward-compatible)
- `scheduleReconnect()` method:
  - Wait `reconnectDelay` ms, then call `connect()`
  - Double reconnectDelay each time: 1s -> 2s -> 4s -> 8s -> 16s -> 32s -> 60s (capped at 60s per SIDE-01)
  - Log each reconnect attempt with current delay
- `handleMessage(msg)` method:
  - If `msg.type === "identified"`: set identified=true, log success, reset reconnect delay
  - If `msg.type === "error"`: log error
  - If `msg.type === "pong"`: record pong received time (for heartbeat monitoring)
  - All other message types: log as unhandled (will be extended in Plan 03)
- `send(obj)` method:
  - JSON.stringify and send via ws. Check ws.readyState === WebSocket.OPEN before sending
  - Add `protocol_version: 1` to all outgoing messages
- `startHeartbeat()` method:
  - Every 30 seconds, send `{ type: "ping" }` to hub
  - If no pong received within 10 seconds of ping, treat connection as dead: close WebSocket and trigger reconnect
  - This detects silent WebSocket death (NAT timeout, firewall kill, network partition) per research pitfall #1
  - Use setInterval for ping, setTimeout for pong timeout check

**4. Graceful shutdown:**
- Listen for SIGINT and SIGTERM (pm2 sends these on restart/stop)
- On signal: log shutdown event, close WebSocket cleanly, exit(0)
- On Windows, also handle SIGBREAK

**5. Main entry point:**
- Load config
- Create HubConnection instance
- Call connect()
- Set up graceful shutdown handlers
- Log startup with agent_id and hub_url

Do NOT implement task handling, queue management, wake commands, or result watching in this plan -- those are Plan 03.
  </action>
  <verify>
1. Create a temporary `sidecar/config.json` with test values (any agent_id/token, hub_url pointing to a non-existent host like ws://localhost:9999/ws)
2. Run `node sidecar/index.js` -- it should:
   - Log startup event
   - Attempt WebSocket connection
   - On connection failure, log reconnect attempt with 1s delay
   - On second failure, log reconnect with 2s delay (exponential backoff visible)
3. Kill the process with Ctrl+C -- it should log shutdown event and exit cleanly
4. Verify sidecar.log contains structured JSON lines for each event
5. Remove test config.json after verification
  </verify>
  <done>sidecar/index.js exists with HubConnection class implementing WebSocket connect + identify + exponential backoff reconnect (1s to 60s cap) + heartbeat ping/pong (30s interval, 10s timeout) + structured JSON-lines logging + graceful SIGINT/SIGTERM shutdown. Process starts, attempts connection, reconnects with backoff on failure, and shuts down cleanly.</done>
</task>

</tasks>

<verification>
- `node sidecar/index.js` starts and attempts WebSocket connection
- Reconnect backoff follows 1s, 2s, 4s, 8s, 16s, 32s, 60s, 60s... pattern
- sidecar.log contains structured JSON lines with ts, event, agent_id
- Process exits cleanly on SIGINT/SIGTERM
- Config loading fails gracefully with helpful error when config.json is missing
</verification>

<success_criteria>
The sidecar process can be started, connects to the hub WebSocket, identifies itself using the existing protocol, automatically reconnects with exponential backoff on disconnection, monitors connection health via heartbeat, logs all lifecycle events, and shuts down gracefully.
</success_criteria>

<output>
After completion, create `.planning/phases/01-sidecar/01-01-SUMMARY.md`
</output>

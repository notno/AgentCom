---
phase: 01-sidecar
plan: 04
type: execute
wave: 3
depends_on: ["01-03"]
files_modified:
  - sidecar/index.js
  - sidecar/ecosystem.config.js
  - sidecar/start.sh
  - sidecar/start.bat

autonomous: true

must_haves:
  truths:
    - "Sidecar recovers incomplete tasks from queue.json on restart and reports recovering status to hub"
    - "Sidecar runs as pm2 managed process that auto-restarts on crash"
    - "Sidecar auto-updates from git on pm2 restart via wrapper script"
    - "Sidecar works on both Windows and Linux"
    - "pm2 log rotation is configured for sidecar logs"
  artifacts:
    - path: "sidecar/index.js"
      provides: "Startup recovery logic for incomplete tasks"
      contains: "task_recovering"
    - path: "sidecar/ecosystem.config.js"
      provides: "pm2 process configuration with auto-restart, memory limits, and log settings"
      contains: "agentcom-sidecar"
    - path: "sidecar/start.sh"
      provides: "Linux wrapper script with git pull auto-update"
      contains: "git pull"
    - path: "sidecar/start.bat"
      provides: "Windows wrapper script with git pull auto-update"
      contains: "git pull"
  key_links:
    - from: "sidecar/ecosystem.config.js"
      to: "sidecar/start.sh or sidecar/start.bat"
      via: "pm2 script field references wrapper"
      pattern: "start\\.(sh|bat)"
    - from: "sidecar/start.sh"
      to: "sidecar/index.js"
      via: "exec node index.js after git pull"
      pattern: "node index\\.js"
    - from: "sidecar/index.js"
      to: "hub WebSocket"
      via: "task_recovering message on startup"
      pattern: "task_recovering"
---

<objective>
Add startup recovery for incomplete tasks and create all deployment artifacts for running the sidecar as a pm2 managed process with auto-update, auto-restart, and log rotation.

Purpose: Recovery ensures no tasks are lost if the sidecar crashes mid-task. pm2 management ensures the sidecar is always running. Auto-update ensures agents get the latest code without manual intervention. This completes the "always-on" promise of the sidecar.

Output: Modified index.js with recovery logic, ecosystem.config.js for pm2, start.sh and start.bat wrapper scripts.
</objective>

<execution_context>
@C:/Users/nrosq/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nrosq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-sidecar/01-CONTEXT.md
@.planning/phases/01-sidecar/01-RESEARCH.md
@.planning/phases/01-sidecar/01-01-SUMMARY.md
@.planning/phases/01-sidecar/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add startup recovery logic for incomplete tasks</name>
  <files>sidecar/index.js</files>
  <action>
Add recovery logic that runs on sidecar startup, after config load and before WebSocket connect.

**Recovery flow (per CONTEXT.md + research discretion recommendation):**

1. **Load queue.json on startup** (already have loadQueue from Plan 03)

2. **Check for incomplete task:**
   If `queue.active` is not null, the sidecar crashed or was killed while a task was in progress.

3. **Move active to recovering:**
   ```javascript
   if (queue.active) {
     log('recovery_found', { task_id: queue.active.task_id, status: queue.active.status });
     queue.recovering = queue.active;
     queue.active = null;
     saveQueue(queue);
   }
   ```

4. **After WebSocket identifies (in handleMessage for "identified"):**
   If `queue.recovering` is not null:
   - Send `task_recovering` message to hub:
     ```javascript
     {
       type: "task_recovering",
       task_id: queue.recovering.task_id,
       description: queue.recovering.description,
       metadata: queue.recovering.metadata,
       last_status: queue.recovering.status,
       protocol_version: 1
     }
     ```
   - Log recovery_reported event

5. **Handle hub response (in handleMessage):**

   When `msg.type === "task_reassign"`:
   - Hub is taking the task back (default Phase 1 behavior)
   - Clear recovering slot: `queue.recovering = null; saveQueue(queue);`
   - Log recovery_reassigned event
   - Sidecar is now idle and ready for new tasks

   When `msg.type === "task_continue"`:
   - Hub says agent is still working on it (future Phase 2+ behavior)
   - Move recovering back to active: `queue.active = queue.recovering; queue.recovering = null; saveQueue(queue);`
   - Resume watching for result file
   - Log recovery_continued event

**Per CONTEXT.md locked decision:** "Recovery on restart: report to hub with recovering status, let hub decide (reassign or re-push)"

**Per research discretion:** "On restart, report recovering status to hub and let the hub decide. Re-waking could create a duplicate session."

**Important:** Recovery runs BEFORE the sidecar accepts new tasks. The sidecar should not send task_recovering until AFTER successful WebSocket identification (needs the connection to send the message).

**Update the startup sequence in main():**
```
1. Load config
2. Load queue (check for recovery)
3. Connect to hub
4. On identify success: report recovery if needed
5. Start heartbeat
6. Start result watcher
7. Ready for tasks
```
  </action>
  <verify>
1. Push a task to the sidecar and verify it's in queue.json
2. Kill the sidecar process (SIGKILL or kill -9 to simulate crash)
3. Restart the sidecar
4. Check sidecar log: should show recovery_found event with the task_id
5. After WebSocket identifies: should show recovery_reported event
6. Hub should receive task_recovering message
7. Hub responds with task_reassign (Phase 1 default behavior)
8. Sidecar log shows recovery_reassigned, queue.json shows both active and recovering as null
9. Sidecar is now idle and accepts new tasks
  </verify>
  <done>Sidecar detects incomplete tasks in queue.json on startup, moves them to recovering slot, reports task_recovering to hub after WebSocket identification, handles hub's task_reassign response by clearing recovering state. No tasks are lost on crash -- hub always knows about incomplete work.</done>
</task>

<task type="auto">
  <name>Task 2: Create pm2 ecosystem config and wrapper scripts for deployment</name>
  <files>sidecar/ecosystem.config.js, sidecar/start.sh, sidecar/start.bat</files>
  <action>
Create deployment artifacts for running the sidecar as a pm2 managed process.

**1. sidecar/ecosystem.config.js:**

```javascript
// PM2 ecosystem configuration for AgentCom sidecar
// Usage: pm2 start ecosystem.config.js
// Docs: https://pm2.io/docs/runtime/reference/ecosystem-file/
module.exports = {
  apps: [{
    name: 'agentcom-sidecar',
    // Use platform-appropriate wrapper script for auto-update
    script: process.platform === 'win32' ? 'start.bat' : 'start.sh',
    cwd: __dirname,
    interpreter: process.platform === 'win32' ? 'cmd' : '/bin/bash',
    interpreter_args: process.platform === 'win32' ? '/c' : '',

    // Auto-restart on crash (SIDE-05)
    autorestart: true,
    max_restarts: 50,       // Max restarts within restart_delay window
    min_uptime: 5000,       // Must run 5s to be considered "started"
    restart_delay: 2000,    // Wait 2s between restarts

    // Memory limit (sidecar should be very lightweight)
    max_memory_restart: '200M',

    // Logging
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    error_file: 'logs/sidecar-error.log',
    out_file: 'logs/sidecar-out.log',
    merge_logs: true,

    // Environment
    env: {
      NODE_ENV: 'production'
    }
  }]
};
```

**2. sidecar/start.sh (Linux wrapper):**

```bash
#!/bin/bash
# AgentCom sidecar startup wrapper
# Auto-updates from git before launching, per CONTEXT.md:
# "Auto-update on restart: sidecar pulls latest from git on pm2 restart (not periodic)"

set -e

# Navigate to repo root (sidecar/ is inside the AgentCom repo)
cd "$(dirname "$0")/.."

# Pull latest changes (fast-forward only, fail silently if offline)
git pull --ff-only origin main 2>/dev/null || echo "[sidecar] git pull failed, continuing with current version"

# Install any new dependencies
cd sidecar/
npm install --production 2>/dev/null || echo "[sidecar] npm install failed, continuing with current packages"

# Create results and logs directories if they don't exist
mkdir -p results logs

# Launch sidecar (exec replaces shell process so pm2 monitors node directly)
exec node index.js
```

Make executable: the plan executor should run `chmod +x sidecar/start.sh` (on Linux/Mac) or note it for the user.

**3. sidecar/start.bat (Windows wrapper):**

```batch
@echo off
REM AgentCom sidecar startup wrapper for Windows
REM Auto-updates from git before launching

REM Navigate to repo root
cd /d "%~dp0\.."

REM Pull latest changes (fast-forward only, ignore errors)
git pull --ff-only origin main 2>nul
if errorlevel 1 echo [sidecar] git pull failed, continuing with current version

REM Install any new dependencies
cd sidecar
call npm install --production 2>nul
if errorlevel 1 echo [sidecar] npm install failed, continuing with current packages

REM Create results and logs directories
if not exist results mkdir results
if not exist logs mkdir logs

REM Launch sidecar
node index.js
```

**4. Update sidecar/.gitignore:**

Add `logs/` directory to .gitignore if not already present (it was included in Plan 01, verify it's there).

**5. Add logs/ to gitignore in sidecar/.gitignore if missing.**

**Setup instructions (add as comments in ecosystem.config.js):**

```
// SETUP:
// 1. Copy config.json.example to config.json and fill in your agent details
// 2. Install pm2 globally: npm install -g pm2
// 3. Install log rotation: pm2 install pm2-logrotate
// 4. Configure log rotation: pm2 set pm2-logrotate:max_size 10M && pm2 set pm2-logrotate:retain 30
// 5. Start sidecar: pm2 start ecosystem.config.js
// 6. Save process list: pm2 save
// 7. Set up startup script: pm2 startup (Linux) or use pm2-installer (Windows)
//
// Windows-specific:
// - Clone https://github.com/jessety/pm2-installer
// - Run `npm run setup` from elevated terminal
// - Then pm2 will run as a Windows service
//
// Verify: pm2 status (should show agentcom-sidecar as online)
// Logs: pm2 logs agentcom-sidecar
// Restart: pm2 restart agentcom-sidecar (triggers auto-update via wrapper script)
```

**Per CONTEXT.md locked decisions:**
- "pm2 as primary, node-windows as fallback for Windows machines" -- ecosystem.config.js uses pm2, Windows-specific setup notes reference pm2-installer
- "Auto-update on restart: sidecar pulls latest from git on pm2 restart (not periodic)" -- wrapper scripts do git pull
- "Cross-platform: must work on both Windows and Linux" -- separate start.sh and start.bat
- "Managed with auto-restart and log rotation" -- ecosystem.config.js has autorestart, pm2-logrotate in setup instructions
  </action>
  <verify>
1. Verify all files exist: `ls sidecar/ecosystem.config.js sidecar/start.sh sidecar/start.bat`
2. On Linux: `bash sidecar/start.sh` should pull git, install deps, and start the sidecar
3. On Windows: `sidecar\start.bat` should pull git, install deps, and start the sidecar
4. `pm2 start sidecar/ecosystem.config.js` should start the sidecar as a managed process
5. `pm2 status` should show `agentcom-sidecar` as online
6. Kill the node process (`pm2 stop agentcom-sidecar && pm2 start agentcom-sidecar`) -- should trigger auto-update (git pull visible in logs)
7. `pm2 kill` and cleanup after testing
  </verify>
  <done>ecosystem.config.js configures pm2 with auto-restart, memory limits, and structured logging. start.sh (Linux) and start.bat (Windows) wrapper scripts perform git pull + npm install before launching node index.js. Both scripts handle git/npm failures gracefully (continue with current version). Setup instructions documented in ecosystem.config.js comments.</done>
</task>

</tasks>

<verification>
- Sidecar recovers from crash: queue.json with active task -> restart -> reports task_recovering to hub -> hub responds -> sidecar clears recovering state
- pm2 manages sidecar with auto-restart on crash
- Wrapper scripts perform git pull before starting (auto-update)
- Sidecar works on both Windows (start.bat) and Linux (start.sh)
- pm2 log rotation configured via setup instructions
- Full lifecycle test: start sidecar via pm2, push task, kill sidecar mid-task, pm2 restarts it, sidecar reports recovery to hub
</verification>

<success_criteria>
The sidecar recovers incomplete tasks from queue.json on restart without losing work. It runs as a pm2 managed process that auto-restarts on crash, auto-updates from git on restart, and works on both Windows and Linux. The full always-on promise is delivered: push a task, crash the sidecar, and the task is recovered and reported to the hub on restart.
</success_criteria>

<output>
After completion, create `.planning/phases/01-sidecar/01-04-SUMMARY.md`
</output>
